
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Structure for your terminal">
      
      
        <meta name="author" content="Axium Team">
      
      
        <link rel="canonical" href="https://docs.axium.tools/reference/api/daemon/">
      
      
        <link rel="prev" href="../cli/">
      
      
        <link rel="next" href="../spokes/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Daemon - Axium Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#daemon-api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Axium Documentation" class="md-header__button md-logo" aria-label="Axium Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Axium Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Daemon
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="cyan"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="cyan"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/axium-tools/axium" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    axium-tools/axium
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../getting-started/" class="md-tabs__link">
        
  
  
    
  
  Getting Started

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../concepts/environments/" class="md-tabs__link">
          
  
  
  Concepts

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../guides/writing-spokes/" class="md-tabs__link">
          
  
  
  Guides

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../events/" class="md-tabs__link">
          
  
  
  Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../development/CONTRIBUTING/" class="md-tabs__link">
          
  
  
  Development

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Axium Documentation" class="md-nav__button md-logo" aria-label="Axium Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Axium Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/axium-tools/axium" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    axium-tools/axium
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/environments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Environments
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/prefixes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Command Prefixes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/spokes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Spokes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/gears/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Gears
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/completions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shell Completions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/wrappers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Command Wrappers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/registry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Command Registry
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/tmux-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    tmux Integration
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/writing-spokes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Writing Spokes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/writing-gears/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Writing Gears
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/hud-segments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HUD Segments
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Events
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" checked>
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API Documentation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            API Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CLI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Daemon
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Daemon
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#daemon" class="md-nav__link">
    <span class="md-ellipsis">
      daemon
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#axium.core.daemon" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;daemon
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" daemon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.AxiumDaemon" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AxiumDaemon
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AxiumDaemon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.AxiumDaemon.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.AxiumDaemon.handle_client" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;handle_client
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.AxiumDaemon.run" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.kill_daemon_pid" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;kill_daemon_pid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.cleanup_zombie_daemons" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;cleanup_zombie_daemons
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.start" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.stop" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;stop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.status" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;status
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.ensure_daemon_running" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;ensure_daemon_running
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../spokes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Spokes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../registry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Registry
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Development
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../development/CONTRIBUTING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../development/STYLE-GUIDE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Style Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../development/ROADMAP.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Roadmap
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#daemon" class="md-nav__link">
    <span class="md-ellipsis">
      daemon
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#axium.core.daemon" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;daemon
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" daemon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.AxiumDaemon" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AxiumDaemon
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AxiumDaemon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.AxiumDaemon.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.AxiumDaemon.handle_client" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;handle_client
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.AxiumDaemon.run" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.kill_daemon_pid" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;kill_daemon_pid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.cleanup_zombie_daemons" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;cleanup_zombie_daemons
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.start" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.stop" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;stop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.status" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;status
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axium.core.daemon.ensure_daemon_running" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;ensure_daemon_running
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="daemon-api">Daemon API<a class="headerlink" href="#daemon-api" title="Permanent link">&para;</a></h1>
<p>Background daemon process and state management.</p>
<hr />
<h2 id="daemon">daemon<a class="headerlink" href="#daemon" title="Permanent link">&para;</a></h2>
<p>Async daemon implementation with IPC handler.</p>


<div class="doc doc-object doc-module">



<h2 id="axium.core.daemon" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>daemon</code>


<a href="#axium.core.daemon" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">

        <p>Axium Daemon - Async background service.</p>
<p>The daemon is the heart of Axium, running as a background process to:
- Maintain session state (active environment, uptime, etc.)
- Handle IPC requests from CLI via UNIX socket
- Coordinate events across Spokes
- Apply prefix rules to commands</p>
<p>The daemon uses asyncio for concurrent request handling and communicates
via JSON over a UNIX socket at /tmp/axiumd.sock.</p>
<p>State is persisted to ~/.config/axium/state.json and includes:
- active_env: Current environment name
- panes: Per-pane environment mapping</p>
<p>Runtime state (not persisted):
- started: Daemon start timestamp (ISO 8601)
- tmux_pane: TMUX_PANE value when daemon started
- hud_cache: Pre-rendered HUD strings for panes</p>


<details class="ipc-protocol" open>
  <summary>IPC Protocol</summary>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="err">Reques</span><span class="kc">t</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="nt">&quot;cmd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;command_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;arg1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">...</span><span class="p">}</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="err">Respo</span><span class="kc">nse</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;result&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">...</span><span class="p">}</span><span class="w"> </span><span class="err">or</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">}</span>
</code></pre></div>
</details>

<details class="supported-commands" open>
  <summary>Supported Commands</summary>
  <ul>
<li>ping: Health check</li>
<li>get_state: Get full daemon state</li>
<li>set_env: Set active environment</li>
<li>reload: Reload state from disk</li>
<li>apply_prefixes: Apply prefix rules to a command</li>
<li>list_prefixed_commands: List commands with prefix rules</li>
<li>stop: Gracefully shut down daemon</li>
</ul>
</details>

<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>$<span class="w"> </span>axium<span class="w"> </span>daemon<span class="w"> </span>start
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>$<span class="w"> </span>axium<span class="w"> </span>daemon<span class="w"> </span>status
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>$<span class="w"> </span>axium<span class="w"> </span>daemon<span class="w"> </span>stop
</code></pre></div>
</details>









  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="axium.core.daemon.AxiumDaemon" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>AxiumDaemon</code>


<a href="#axium.core.daemon.AxiumDaemon" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">


        <p>Main daemon class managing state and IPC.</p>
<p>The daemon runs an asyncio event loop with a UNIX socket server
accepting JSON IPC requests from the CLI.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="axium.core.daemon.AxiumDaemon.state">state</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Runtime state dict with keys:
Persistent (saved to state.json):
    - active_env: Current environment name (str | None)
    - panes: Per-pane environment mapping (dict)
Runtime-only:
    - started: ISO 8601 timestamp of daemon start (str)
    - tmux_pane: TMUX_PANE when daemon started (str | None)
    - hud_cache: Pre-rendered HUD strings (dict)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="axium.core.daemon.AxiumDaemon._start_time">_start_time</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unix timestamp of daemon start (float, for uptime)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="axium.core.daemon.AxiumDaemon.server">server</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>asyncio.Server instance for UNIX socket</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="axium.core.daemon.AxiumDaemon._stop">_stop</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>asyncio.Event for graceful shutdown</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">daemon</span> <span class="o">=</span> <span class="n">AxiumDaemon</span><span class="p">()</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">await</span> <span class="n">daemon</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
</details>







              <details class="quote">
                <summary>Source code in <code>axium/core/daemon.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-68">  68</a></span>
<span class="normal"><a href="#__codelineno-0-69">  69</a></span>
<span class="normal"><a href="#__codelineno-0-70">  70</a></span>
<span class="normal"><a href="#__codelineno-0-71">  71</a></span>
<span class="normal"><a href="#__codelineno-0-72">  72</a></span>
<span class="normal"><a href="#__codelineno-0-73">  73</a></span>
<span class="normal"><a href="#__codelineno-0-74">  74</a></span>
<span class="normal"><a href="#__codelineno-0-75">  75</a></span>
<span class="normal"><a href="#__codelineno-0-76">  76</a></span>
<span class="normal"><a href="#__codelineno-0-77">  77</a></span>
<span class="normal"><a href="#__codelineno-0-78">  78</a></span>
<span class="normal"><a href="#__codelineno-0-79">  79</a></span>
<span class="normal"><a href="#__codelineno-0-80">  80</a></span>
<span class="normal"><a href="#__codelineno-0-81">  81</a></span>
<span class="normal"><a href="#__codelineno-0-82">  82</a></span>
<span class="normal"><a href="#__codelineno-0-83">  83</a></span>
<span class="normal"><a href="#__codelineno-0-84">  84</a></span>
<span class="normal"><a href="#__codelineno-0-85">  85</a></span>
<span class="normal"><a href="#__codelineno-0-86">  86</a></span>
<span class="normal"><a href="#__codelineno-0-87">  87</a></span>
<span class="normal"><a href="#__codelineno-0-88">  88</a></span>
<span class="normal"><a href="#__codelineno-0-89">  89</a></span>
<span class="normal"><a href="#__codelineno-0-90">  90</a></span>
<span class="normal"><a href="#__codelineno-0-91">  91</a></span>
<span class="normal"><a href="#__codelineno-0-92">  92</a></span>
<span class="normal"><a href="#__codelineno-0-93">  93</a></span>
<span class="normal"><a href="#__codelineno-0-94">  94</a></span>
<span class="normal"><a href="#__codelineno-0-95">  95</a></span>
<span class="normal"><a href="#__codelineno-0-96">  96</a></span>
<span class="normal"><a href="#__codelineno-0-97">  97</a></span>
<span class="normal"><a href="#__codelineno-0-98">  98</a></span>
<span class="normal"><a href="#__codelineno-0-99">  99</a></span>
<span class="normal"><a href="#__codelineno-0-100"> 100</a></span>
<span class="normal"><a href="#__codelineno-0-101"> 101</a></span>
<span class="normal"><a href="#__codelineno-0-102"> 102</a></span>
<span class="normal"><a href="#__codelineno-0-103"> 103</a></span>
<span class="normal"><a href="#__codelineno-0-104"> 104</a></span>
<span class="normal"><a href="#__codelineno-0-105"> 105</a></span>
<span class="normal"><a href="#__codelineno-0-106"> 106</a></span>
<span class="normal"><a href="#__codelineno-0-107"> 107</a></span>
<span class="normal"><a href="#__codelineno-0-108"> 108</a></span>
<span class="normal"><a href="#__codelineno-0-109"> 109</a></span>
<span class="normal"><a href="#__codelineno-0-110"> 110</a></span>
<span class="normal"><a href="#__codelineno-0-111"> 111</a></span>
<span class="normal"><a href="#__codelineno-0-112"> 112</a></span>
<span class="normal"><a href="#__codelineno-0-113"> 113</a></span>
<span class="normal"><a href="#__codelineno-0-114"> 114</a></span>
<span class="normal"><a href="#__codelineno-0-115"> 115</a></span>
<span class="normal"><a href="#__codelineno-0-116"> 116</a></span>
<span class="normal"><a href="#__codelineno-0-117"> 117</a></span>
<span class="normal"><a href="#__codelineno-0-118"> 118</a></span>
<span class="normal"><a href="#__codelineno-0-119"> 119</a></span>
<span class="normal"><a href="#__codelineno-0-120"> 120</a></span>
<span class="normal"><a href="#__codelineno-0-121"> 121</a></span>
<span class="normal"><a href="#__codelineno-0-122"> 122</a></span>
<span class="normal"><a href="#__codelineno-0-123"> 123</a></span>
<span class="normal"><a href="#__codelineno-0-124"> 124</a></span>
<span class="normal"><a href="#__codelineno-0-125"> 125</a></span>
<span class="normal"><a href="#__codelineno-0-126"> 126</a></span>
<span class="normal"><a href="#__codelineno-0-127"> 127</a></span>
<span class="normal"><a href="#__codelineno-0-128"> 128</a></span>
<span class="normal"><a href="#__codelineno-0-129"> 129</a></span>
<span class="normal"><a href="#__codelineno-0-130"> 130</a></span>
<span class="normal"><a href="#__codelineno-0-131"> 131</a></span>
<span class="normal"><a href="#__codelineno-0-132"> 132</a></span>
<span class="normal"><a href="#__codelineno-0-133"> 133</a></span>
<span class="normal"><a href="#__codelineno-0-134"> 134</a></span>
<span class="normal"><a href="#__codelineno-0-135"> 135</a></span>
<span class="normal"><a href="#__codelineno-0-136"> 136</a></span>
<span class="normal"><a href="#__codelineno-0-137"> 137</a></span>
<span class="normal"><a href="#__codelineno-0-138"> 138</a></span>
<span class="normal"><a href="#__codelineno-0-139"> 139</a></span>
<span class="normal"><a href="#__codelineno-0-140"> 140</a></span>
<span class="normal"><a href="#__codelineno-0-141"> 141</a></span>
<span class="normal"><a href="#__codelineno-0-142"> 142</a></span>
<span class="normal"><a href="#__codelineno-0-143"> 143</a></span>
<span class="normal"><a href="#__codelineno-0-144"> 144</a></span>
<span class="normal"><a href="#__codelineno-0-145"> 145</a></span>
<span class="normal"><a href="#__codelineno-0-146"> 146</a></span>
<span class="normal"><a href="#__codelineno-0-147"> 147</a></span>
<span class="normal"><a href="#__codelineno-0-148"> 148</a></span>
<span class="normal"><a href="#__codelineno-0-149"> 149</a></span>
<span class="normal"><a href="#__codelineno-0-150"> 150</a></span>
<span class="normal"><a href="#__codelineno-0-151"> 151</a></span>
<span class="normal"><a href="#__codelineno-0-152"> 152</a></span>
<span class="normal"><a href="#__codelineno-0-153"> 153</a></span>
<span class="normal"><a href="#__codelineno-0-154"> 154</a></span>
<span class="normal"><a href="#__codelineno-0-155"> 155</a></span>
<span class="normal"><a href="#__codelineno-0-156"> 156</a></span>
<span class="normal"><a href="#__codelineno-0-157"> 157</a></span>
<span class="normal"><a href="#__codelineno-0-158"> 158</a></span>
<span class="normal"><a href="#__codelineno-0-159"> 159</a></span>
<span class="normal"><a href="#__codelineno-0-160"> 160</a></span>
<span class="normal"><a href="#__codelineno-0-161"> 161</a></span>
<span class="normal"><a href="#__codelineno-0-162"> 162</a></span>
<span class="normal"><a href="#__codelineno-0-163"> 163</a></span>
<span class="normal"><a href="#__codelineno-0-164"> 164</a></span>
<span class="normal"><a href="#__codelineno-0-165"> 165</a></span>
<span class="normal"><a href="#__codelineno-0-166"> 166</a></span>
<span class="normal"><a href="#__codelineno-0-167"> 167</a></span>
<span class="normal"><a href="#__codelineno-0-168"> 168</a></span>
<span class="normal"><a href="#__codelineno-0-169"> 169</a></span>
<span class="normal"><a href="#__codelineno-0-170"> 170</a></span>
<span class="normal"><a href="#__codelineno-0-171"> 171</a></span>
<span class="normal"><a href="#__codelineno-0-172"> 172</a></span>
<span class="normal"><a href="#__codelineno-0-173"> 173</a></span>
<span class="normal"><a href="#__codelineno-0-174"> 174</a></span>
<span class="normal"><a href="#__codelineno-0-175"> 175</a></span>
<span class="normal"><a href="#__codelineno-0-176"> 176</a></span>
<span class="normal"><a href="#__codelineno-0-177"> 177</a></span>
<span class="normal"><a href="#__codelineno-0-178"> 178</a></span>
<span class="normal"><a href="#__codelineno-0-179"> 179</a></span>
<span class="normal"><a href="#__codelineno-0-180"> 180</a></span>
<span class="normal"><a href="#__codelineno-0-181"> 181</a></span>
<span class="normal"><a href="#__codelineno-0-182"> 182</a></span>
<span class="normal"><a href="#__codelineno-0-183"> 183</a></span>
<span class="normal"><a href="#__codelineno-0-184"> 184</a></span>
<span class="normal"><a href="#__codelineno-0-185"> 185</a></span>
<span class="normal"><a href="#__codelineno-0-186"> 186</a></span>
<span class="normal"><a href="#__codelineno-0-187"> 187</a></span>
<span class="normal"><a href="#__codelineno-0-188"> 188</a></span>
<span class="normal"><a href="#__codelineno-0-189"> 189</a></span>
<span class="normal"><a href="#__codelineno-0-190"> 190</a></span>
<span class="normal"><a href="#__codelineno-0-191"> 191</a></span>
<span class="normal"><a href="#__codelineno-0-192"> 192</a></span>
<span class="normal"><a href="#__codelineno-0-193"> 193</a></span>
<span class="normal"><a href="#__codelineno-0-194"> 194</a></span>
<span class="normal"><a href="#__codelineno-0-195"> 195</a></span>
<span class="normal"><a href="#__codelineno-0-196"> 196</a></span>
<span class="normal"><a href="#__codelineno-0-197"> 197</a></span>
<span class="normal"><a href="#__codelineno-0-198"> 198</a></span>
<span class="normal"><a href="#__codelineno-0-199"> 199</a></span>
<span class="normal"><a href="#__codelineno-0-200"> 200</a></span>
<span class="normal"><a href="#__codelineno-0-201"> 201</a></span>
<span class="normal"><a href="#__codelineno-0-202"> 202</a></span>
<span class="normal"><a href="#__codelineno-0-203"> 203</a></span>
<span class="normal"><a href="#__codelineno-0-204"> 204</a></span>
<span class="normal"><a href="#__codelineno-0-205"> 205</a></span>
<span class="normal"><a href="#__codelineno-0-206"> 206</a></span>
<span class="normal"><a href="#__codelineno-0-207"> 207</a></span>
<span class="normal"><a href="#__codelineno-0-208"> 208</a></span>
<span class="normal"><a href="#__codelineno-0-209"> 209</a></span>
<span class="normal"><a href="#__codelineno-0-210"> 210</a></span>
<span class="normal"><a href="#__codelineno-0-211"> 211</a></span>
<span class="normal"><a href="#__codelineno-0-212"> 212</a></span>
<span class="normal"><a href="#__codelineno-0-213"> 213</a></span>
<span class="normal"><a href="#__codelineno-0-214"> 214</a></span>
<span class="normal"><a href="#__codelineno-0-215"> 215</a></span>
<span class="normal"><a href="#__codelineno-0-216"> 216</a></span>
<span class="normal"><a href="#__codelineno-0-217"> 217</a></span>
<span class="normal"><a href="#__codelineno-0-218"> 218</a></span>
<span class="normal"><a href="#__codelineno-0-219"> 219</a></span>
<span class="normal"><a href="#__codelineno-0-220"> 220</a></span>
<span class="normal"><a href="#__codelineno-0-221"> 221</a></span>
<span class="normal"><a href="#__codelineno-0-222"> 222</a></span>
<span class="normal"><a href="#__codelineno-0-223"> 223</a></span>
<span class="normal"><a href="#__codelineno-0-224"> 224</a></span>
<span class="normal"><a href="#__codelineno-0-225"> 225</a></span>
<span class="normal"><a href="#__codelineno-0-226"> 226</a></span>
<span class="normal"><a href="#__codelineno-0-227"> 227</a></span>
<span class="normal"><a href="#__codelineno-0-228"> 228</a></span>
<span class="normal"><a href="#__codelineno-0-229"> 229</a></span>
<span class="normal"><a href="#__codelineno-0-230"> 230</a></span>
<span class="normal"><a href="#__codelineno-0-231"> 231</a></span>
<span class="normal"><a href="#__codelineno-0-232"> 232</a></span>
<span class="normal"><a href="#__codelineno-0-233"> 233</a></span>
<span class="normal"><a href="#__codelineno-0-234"> 234</a></span>
<span class="normal"><a href="#__codelineno-0-235"> 235</a></span>
<span class="normal"><a href="#__codelineno-0-236"> 236</a></span>
<span class="normal"><a href="#__codelineno-0-237"> 237</a></span>
<span class="normal"><a href="#__codelineno-0-238"> 238</a></span>
<span class="normal"><a href="#__codelineno-0-239"> 239</a></span>
<span class="normal"><a href="#__codelineno-0-240"> 240</a></span>
<span class="normal"><a href="#__codelineno-0-241"> 241</a></span>
<span class="normal"><a href="#__codelineno-0-242"> 242</a></span>
<span class="normal"><a href="#__codelineno-0-243"> 243</a></span>
<span class="normal"><a href="#__codelineno-0-244"> 244</a></span>
<span class="normal"><a href="#__codelineno-0-245"> 245</a></span>
<span class="normal"><a href="#__codelineno-0-246"> 246</a></span>
<span class="normal"><a href="#__codelineno-0-247"> 247</a></span>
<span class="normal"><a href="#__codelineno-0-248"> 248</a></span>
<span class="normal"><a href="#__codelineno-0-249"> 249</a></span>
<span class="normal"><a href="#__codelineno-0-250"> 250</a></span>
<span class="normal"><a href="#__codelineno-0-251"> 251</a></span>
<span class="normal"><a href="#__codelineno-0-252"> 252</a></span>
<span class="normal"><a href="#__codelineno-0-253"> 253</a></span>
<span class="normal"><a href="#__codelineno-0-254"> 254</a></span>
<span class="normal"><a href="#__codelineno-0-255"> 255</a></span>
<span class="normal"><a href="#__codelineno-0-256"> 256</a></span>
<span class="normal"><a href="#__codelineno-0-257"> 257</a></span>
<span class="normal"><a href="#__codelineno-0-258"> 258</a></span>
<span class="normal"><a href="#__codelineno-0-259"> 259</a></span>
<span class="normal"><a href="#__codelineno-0-260"> 260</a></span>
<span class="normal"><a href="#__codelineno-0-261"> 261</a></span>
<span class="normal"><a href="#__codelineno-0-262"> 262</a></span>
<span class="normal"><a href="#__codelineno-0-263"> 263</a></span>
<span class="normal"><a href="#__codelineno-0-264"> 264</a></span>
<span class="normal"><a href="#__codelineno-0-265"> 265</a></span>
<span class="normal"><a href="#__codelineno-0-266"> 266</a></span>
<span class="normal"><a href="#__codelineno-0-267"> 267</a></span>
<span class="normal"><a href="#__codelineno-0-268"> 268</a></span>
<span class="normal"><a href="#__codelineno-0-269"> 269</a></span>
<span class="normal"><a href="#__codelineno-0-270"> 270</a></span>
<span class="normal"><a href="#__codelineno-0-271"> 271</a></span>
<span class="normal"><a href="#__codelineno-0-272"> 272</a></span>
<span class="normal"><a href="#__codelineno-0-273"> 273</a></span>
<span class="normal"><a href="#__codelineno-0-274"> 274</a></span>
<span class="normal"><a href="#__codelineno-0-275"> 275</a></span>
<span class="normal"><a href="#__codelineno-0-276"> 276</a></span>
<span class="normal"><a href="#__codelineno-0-277"> 277</a></span>
<span class="normal"><a href="#__codelineno-0-278"> 278</a></span>
<span class="normal"><a href="#__codelineno-0-279"> 279</a></span>
<span class="normal"><a href="#__codelineno-0-280"> 280</a></span>
<span class="normal"><a href="#__codelineno-0-281"> 281</a></span>
<span class="normal"><a href="#__codelineno-0-282"> 282</a></span>
<span class="normal"><a href="#__codelineno-0-283"> 283</a></span>
<span class="normal"><a href="#__codelineno-0-284"> 284</a></span>
<span class="normal"><a href="#__codelineno-0-285"> 285</a></span>
<span class="normal"><a href="#__codelineno-0-286"> 286</a></span>
<span class="normal"><a href="#__codelineno-0-287"> 287</a></span>
<span class="normal"><a href="#__codelineno-0-288"> 288</a></span>
<span class="normal"><a href="#__codelineno-0-289"> 289</a></span>
<span class="normal"><a href="#__codelineno-0-290"> 290</a></span>
<span class="normal"><a href="#__codelineno-0-291"> 291</a></span>
<span class="normal"><a href="#__codelineno-0-292"> 292</a></span>
<span class="normal"><a href="#__codelineno-0-293"> 293</a></span>
<span class="normal"><a href="#__codelineno-0-294"> 294</a></span>
<span class="normal"><a href="#__codelineno-0-295"> 295</a></span>
<span class="normal"><a href="#__codelineno-0-296"> 296</a></span>
<span class="normal"><a href="#__codelineno-0-297"> 297</a></span>
<span class="normal"><a href="#__codelineno-0-298"> 298</a></span>
<span class="normal"><a href="#__codelineno-0-299"> 299</a></span>
<span class="normal"><a href="#__codelineno-0-300"> 300</a></span>
<span class="normal"><a href="#__codelineno-0-301"> 301</a></span>
<span class="normal"><a href="#__codelineno-0-302"> 302</a></span>
<span class="normal"><a href="#__codelineno-0-303"> 303</a></span>
<span class="normal"><a href="#__codelineno-0-304"> 304</a></span>
<span class="normal"><a href="#__codelineno-0-305"> 305</a></span>
<span class="normal"><a href="#__codelineno-0-306"> 306</a></span>
<span class="normal"><a href="#__codelineno-0-307"> 307</a></span>
<span class="normal"><a href="#__codelineno-0-308"> 308</a></span>
<span class="normal"><a href="#__codelineno-0-309"> 309</a></span>
<span class="normal"><a href="#__codelineno-0-310"> 310</a></span>
<span class="normal"><a href="#__codelineno-0-311"> 311</a></span>
<span class="normal"><a href="#__codelineno-0-312"> 312</a></span>
<span class="normal"><a href="#__codelineno-0-313"> 313</a></span>
<span class="normal"><a href="#__codelineno-0-314"> 314</a></span>
<span class="normal"><a href="#__codelineno-0-315"> 315</a></span>
<span class="normal"><a href="#__codelineno-0-316"> 316</a></span>
<span class="normal"><a href="#__codelineno-0-317"> 317</a></span>
<span class="normal"><a href="#__codelineno-0-318"> 318</a></span>
<span class="normal"><a href="#__codelineno-0-319"> 319</a></span>
<span class="normal"><a href="#__codelineno-0-320"> 320</a></span>
<span class="normal"><a href="#__codelineno-0-321"> 321</a></span>
<span class="normal"><a href="#__codelineno-0-322"> 322</a></span>
<span class="normal"><a href="#__codelineno-0-323"> 323</a></span>
<span class="normal"><a href="#__codelineno-0-324"> 324</a></span>
<span class="normal"><a href="#__codelineno-0-325"> 325</a></span>
<span class="normal"><a href="#__codelineno-0-326"> 326</a></span>
<span class="normal"><a href="#__codelineno-0-327"> 327</a></span>
<span class="normal"><a href="#__codelineno-0-328"> 328</a></span>
<span class="normal"><a href="#__codelineno-0-329"> 329</a></span>
<span class="normal"><a href="#__codelineno-0-330"> 330</a></span>
<span class="normal"><a href="#__codelineno-0-331"> 331</a></span>
<span class="normal"><a href="#__codelineno-0-332"> 332</a></span>
<span class="normal"><a href="#__codelineno-0-333"> 333</a></span>
<span class="normal"><a href="#__codelineno-0-334"> 334</a></span>
<span class="normal"><a href="#__codelineno-0-335"> 335</a></span>
<span class="normal"><a href="#__codelineno-0-336"> 336</a></span>
<span class="normal"><a href="#__codelineno-0-337"> 337</a></span>
<span class="normal"><a href="#__codelineno-0-338"> 338</a></span>
<span class="normal"><a href="#__codelineno-0-339"> 339</a></span>
<span class="normal"><a href="#__codelineno-0-340"> 340</a></span>
<span class="normal"><a href="#__codelineno-0-341"> 341</a></span>
<span class="normal"><a href="#__codelineno-0-342"> 342</a></span>
<span class="normal"><a href="#__codelineno-0-343"> 343</a></span>
<span class="normal"><a href="#__codelineno-0-344"> 344</a></span>
<span class="normal"><a href="#__codelineno-0-345"> 345</a></span>
<span class="normal"><a href="#__codelineno-0-346"> 346</a></span>
<span class="normal"><a href="#__codelineno-0-347"> 347</a></span>
<span class="normal"><a href="#__codelineno-0-348"> 348</a></span>
<span class="normal"><a href="#__codelineno-0-349"> 349</a></span>
<span class="normal"><a href="#__codelineno-0-350"> 350</a></span>
<span class="normal"><a href="#__codelineno-0-351"> 351</a></span>
<span class="normal"><a href="#__codelineno-0-352"> 352</a></span>
<span class="normal"><a href="#__codelineno-0-353"> 353</a></span>
<span class="normal"><a href="#__codelineno-0-354"> 354</a></span>
<span class="normal"><a href="#__codelineno-0-355"> 355</a></span>
<span class="normal"><a href="#__codelineno-0-356"> 356</a></span>
<span class="normal"><a href="#__codelineno-0-357"> 357</a></span>
<span class="normal"><a href="#__codelineno-0-358"> 358</a></span>
<span class="normal"><a href="#__codelineno-0-359"> 359</a></span>
<span class="normal"><a href="#__codelineno-0-360"> 360</a></span>
<span class="normal"><a href="#__codelineno-0-361"> 361</a></span>
<span class="normal"><a href="#__codelineno-0-362"> 362</a></span>
<span class="normal"><a href="#__codelineno-0-363"> 363</a></span>
<span class="normal"><a href="#__codelineno-0-364"> 364</a></span>
<span class="normal"><a href="#__codelineno-0-365"> 365</a></span>
<span class="normal"><a href="#__codelineno-0-366"> 366</a></span>
<span class="normal"><a href="#__codelineno-0-367"> 367</a></span>
<span class="normal"><a href="#__codelineno-0-368"> 368</a></span>
<span class="normal"><a href="#__codelineno-0-369"> 369</a></span>
<span class="normal"><a href="#__codelineno-0-370"> 370</a></span>
<span class="normal"><a href="#__codelineno-0-371"> 371</a></span>
<span class="normal"><a href="#__codelineno-0-372"> 372</a></span>
<span class="normal"><a href="#__codelineno-0-373"> 373</a></span>
<span class="normal"><a href="#__codelineno-0-374"> 374</a></span>
<span class="normal"><a href="#__codelineno-0-375"> 375</a></span>
<span class="normal"><a href="#__codelineno-0-376"> 376</a></span>
<span class="normal"><a href="#__codelineno-0-377"> 377</a></span>
<span class="normal"><a href="#__codelineno-0-378"> 378</a></span>
<span class="normal"><a href="#__codelineno-0-379"> 379</a></span>
<span class="normal"><a href="#__codelineno-0-380"> 380</a></span>
<span class="normal"><a href="#__codelineno-0-381"> 381</a></span>
<span class="normal"><a href="#__codelineno-0-382"> 382</a></span>
<span class="normal"><a href="#__codelineno-0-383"> 383</a></span>
<span class="normal"><a href="#__codelineno-0-384"> 384</a></span>
<span class="normal"><a href="#__codelineno-0-385"> 385</a></span>
<span class="normal"><a href="#__codelineno-0-386"> 386</a></span>
<span class="normal"><a href="#__codelineno-0-387"> 387</a></span>
<span class="normal"><a href="#__codelineno-0-388"> 388</a></span>
<span class="normal"><a href="#__codelineno-0-389"> 389</a></span>
<span class="normal"><a href="#__codelineno-0-390"> 390</a></span>
<span class="normal"><a href="#__codelineno-0-391"> 391</a></span>
<span class="normal"><a href="#__codelineno-0-392"> 392</a></span>
<span class="normal"><a href="#__codelineno-0-393"> 393</a></span>
<span class="normal"><a href="#__codelineno-0-394"> 394</a></span>
<span class="normal"><a href="#__codelineno-0-395"> 395</a></span>
<span class="normal"><a href="#__codelineno-0-396"> 396</a></span>
<span class="normal"><a href="#__codelineno-0-397"> 397</a></span>
<span class="normal"><a href="#__codelineno-0-398"> 398</a></span>
<span class="normal"><a href="#__codelineno-0-399"> 399</a></span>
<span class="normal"><a href="#__codelineno-0-400"> 400</a></span>
<span class="normal"><a href="#__codelineno-0-401"> 401</a></span>
<span class="normal"><a href="#__codelineno-0-402"> 402</a></span>
<span class="normal"><a href="#__codelineno-0-403"> 403</a></span>
<span class="normal"><a href="#__codelineno-0-404"> 404</a></span>
<span class="normal"><a href="#__codelineno-0-405"> 405</a></span>
<span class="normal"><a href="#__codelineno-0-406"> 406</a></span>
<span class="normal"><a href="#__codelineno-0-407"> 407</a></span>
<span class="normal"><a href="#__codelineno-0-408"> 408</a></span>
<span class="normal"><a href="#__codelineno-0-409"> 409</a></span>
<span class="normal"><a href="#__codelineno-0-410"> 410</a></span>
<span class="normal"><a href="#__codelineno-0-411"> 411</a></span>
<span class="normal"><a href="#__codelineno-0-412"> 412</a></span>
<span class="normal"><a href="#__codelineno-0-413"> 413</a></span>
<span class="normal"><a href="#__codelineno-0-414"> 414</a></span>
<span class="normal"><a href="#__codelineno-0-415"> 415</a></span>
<span class="normal"><a href="#__codelineno-0-416"> 416</a></span>
<span class="normal"><a href="#__codelineno-0-417"> 417</a></span>
<span class="normal"><a href="#__codelineno-0-418"> 418</a></span>
<span class="normal"><a href="#__codelineno-0-419"> 419</a></span>
<span class="normal"><a href="#__codelineno-0-420"> 420</a></span>
<span class="normal"><a href="#__codelineno-0-421"> 421</a></span>
<span class="normal"><a href="#__codelineno-0-422"> 422</a></span>
<span class="normal"><a href="#__codelineno-0-423"> 423</a></span>
<span class="normal"><a href="#__codelineno-0-424"> 424</a></span>
<span class="normal"><a href="#__codelineno-0-425"> 425</a></span>
<span class="normal"><a href="#__codelineno-0-426"> 426</a></span>
<span class="normal"><a href="#__codelineno-0-427"> 427</a></span>
<span class="normal"><a href="#__codelineno-0-428"> 428</a></span>
<span class="normal"><a href="#__codelineno-0-429"> 429</a></span>
<span class="normal"><a href="#__codelineno-0-430"> 430</a></span>
<span class="normal"><a href="#__codelineno-0-431"> 431</a></span>
<span class="normal"><a href="#__codelineno-0-432"> 432</a></span>
<span class="normal"><a href="#__codelineno-0-433"> 433</a></span>
<span class="normal"><a href="#__codelineno-0-434"> 434</a></span>
<span class="normal"><a href="#__codelineno-0-435"> 435</a></span>
<span class="normal"><a href="#__codelineno-0-436"> 436</a></span>
<span class="normal"><a href="#__codelineno-0-437"> 437</a></span>
<span class="normal"><a href="#__codelineno-0-438"> 438</a></span>
<span class="normal"><a href="#__codelineno-0-439"> 439</a></span>
<span class="normal"><a href="#__codelineno-0-440"> 440</a></span>
<span class="normal"><a href="#__codelineno-0-441"> 441</a></span>
<span class="normal"><a href="#__codelineno-0-442"> 442</a></span>
<span class="normal"><a href="#__codelineno-0-443"> 443</a></span>
<span class="normal"><a href="#__codelineno-0-444"> 444</a></span>
<span class="normal"><a href="#__codelineno-0-445"> 445</a></span>
<span class="normal"><a href="#__codelineno-0-446"> 446</a></span>
<span class="normal"><a href="#__codelineno-0-447"> 447</a></span>
<span class="normal"><a href="#__codelineno-0-448"> 448</a></span>
<span class="normal"><a href="#__codelineno-0-449"> 449</a></span>
<span class="normal"><a href="#__codelineno-0-450"> 450</a></span>
<span class="normal"><a href="#__codelineno-0-451"> 451</a></span>
<span class="normal"><a href="#__codelineno-0-452"> 452</a></span>
<span class="normal"><a href="#__codelineno-0-453"> 453</a></span>
<span class="normal"><a href="#__codelineno-0-454"> 454</a></span>
<span class="normal"><a href="#__codelineno-0-455"> 455</a></span>
<span class="normal"><a href="#__codelineno-0-456"> 456</a></span>
<span class="normal"><a href="#__codelineno-0-457"> 457</a></span>
<span class="normal"><a href="#__codelineno-0-458"> 458</a></span>
<span class="normal"><a href="#__codelineno-0-459"> 459</a></span>
<span class="normal"><a href="#__codelineno-0-460"> 460</a></span>
<span class="normal"><a href="#__codelineno-0-461"> 461</a></span>
<span class="normal"><a href="#__codelineno-0-462"> 462</a></span>
<span class="normal"><a href="#__codelineno-0-463"> 463</a></span>
<span class="normal"><a href="#__codelineno-0-464"> 464</a></span>
<span class="normal"><a href="#__codelineno-0-465"> 465</a></span>
<span class="normal"><a href="#__codelineno-0-466"> 466</a></span>
<span class="normal"><a href="#__codelineno-0-467"> 467</a></span>
<span class="normal"><a href="#__codelineno-0-468"> 468</a></span>
<span class="normal"><a href="#__codelineno-0-469"> 469</a></span>
<span class="normal"><a href="#__codelineno-0-470"> 470</a></span>
<span class="normal"><a href="#__codelineno-0-471"> 471</a></span>
<span class="normal"><a href="#__codelineno-0-472"> 472</a></span>
<span class="normal"><a href="#__codelineno-0-473"> 473</a></span>
<span class="normal"><a href="#__codelineno-0-474"> 474</a></span>
<span class="normal"><a href="#__codelineno-0-475"> 475</a></span>
<span class="normal"><a href="#__codelineno-0-476"> 476</a></span>
<span class="normal"><a href="#__codelineno-0-477"> 477</a></span>
<span class="normal"><a href="#__codelineno-0-478"> 478</a></span>
<span class="normal"><a href="#__codelineno-0-479"> 479</a></span>
<span class="normal"><a href="#__codelineno-0-480"> 480</a></span>
<span class="normal"><a href="#__codelineno-0-481"> 481</a></span>
<span class="normal"><a href="#__codelineno-0-482"> 482</a></span>
<span class="normal"><a href="#__codelineno-0-483"> 483</a></span>
<span class="normal"><a href="#__codelineno-0-484"> 484</a></span>
<span class="normal"><a href="#__codelineno-0-485"> 485</a></span>
<span class="normal"><a href="#__codelineno-0-486"> 486</a></span>
<span class="normal"><a href="#__codelineno-0-487"> 487</a></span>
<span class="normal"><a href="#__codelineno-0-488"> 488</a></span>
<span class="normal"><a href="#__codelineno-0-489"> 489</a></span>
<span class="normal"><a href="#__codelineno-0-490"> 490</a></span>
<span class="normal"><a href="#__codelineno-0-491"> 491</a></span>
<span class="normal"><a href="#__codelineno-0-492"> 492</a></span>
<span class="normal"><a href="#__codelineno-0-493"> 493</a></span>
<span class="normal"><a href="#__codelineno-0-494"> 494</a></span>
<span class="normal"><a href="#__codelineno-0-495"> 495</a></span>
<span class="normal"><a href="#__codelineno-0-496"> 496</a></span>
<span class="normal"><a href="#__codelineno-0-497"> 497</a></span>
<span class="normal"><a href="#__codelineno-0-498"> 498</a></span>
<span class="normal"><a href="#__codelineno-0-499"> 499</a></span>
<span class="normal"><a href="#__codelineno-0-500"> 500</a></span>
<span class="normal"><a href="#__codelineno-0-501"> 501</a></span>
<span class="normal"><a href="#__codelineno-0-502"> 502</a></span>
<span class="normal"><a href="#__codelineno-0-503"> 503</a></span>
<span class="normal"><a href="#__codelineno-0-504"> 504</a></span>
<span class="normal"><a href="#__codelineno-0-505"> 505</a></span>
<span class="normal"><a href="#__codelineno-0-506"> 506</a></span>
<span class="normal"><a href="#__codelineno-0-507"> 507</a></span>
<span class="normal"><a href="#__codelineno-0-508"> 508</a></span>
<span class="normal"><a href="#__codelineno-0-509"> 509</a></span>
<span class="normal"><a href="#__codelineno-0-510"> 510</a></span>
<span class="normal"><a href="#__codelineno-0-511"> 511</a></span>
<span class="normal"><a href="#__codelineno-0-512"> 512</a></span>
<span class="normal"><a href="#__codelineno-0-513"> 513</a></span>
<span class="normal"><a href="#__codelineno-0-514"> 514</a></span>
<span class="normal"><a href="#__codelineno-0-515"> 515</a></span>
<span class="normal"><a href="#__codelineno-0-516"> 516</a></span>
<span class="normal"><a href="#__codelineno-0-517"> 517</a></span>
<span class="normal"><a href="#__codelineno-0-518"> 518</a></span>
<span class="normal"><a href="#__codelineno-0-519"> 519</a></span>
<span class="normal"><a href="#__codelineno-0-520"> 520</a></span>
<span class="normal"><a href="#__codelineno-0-521"> 521</a></span>
<span class="normal"><a href="#__codelineno-0-522"> 522</a></span>
<span class="normal"><a href="#__codelineno-0-523"> 523</a></span>
<span class="normal"><a href="#__codelineno-0-524"> 524</a></span>
<span class="normal"><a href="#__codelineno-0-525"> 525</a></span>
<span class="normal"><a href="#__codelineno-0-526"> 526</a></span>
<span class="normal"><a href="#__codelineno-0-527"> 527</a></span>
<span class="normal"><a href="#__codelineno-0-528"> 528</a></span>
<span class="normal"><a href="#__codelineno-0-529"> 529</a></span>
<span class="normal"><a href="#__codelineno-0-530"> 530</a></span>
<span class="normal"><a href="#__codelineno-0-531"> 531</a></span>
<span class="normal"><a href="#__codelineno-0-532"> 532</a></span>
<span class="normal"><a href="#__codelineno-0-533"> 533</a></span>
<span class="normal"><a href="#__codelineno-0-534"> 534</a></span>
<span class="normal"><a href="#__codelineno-0-535"> 535</a></span>
<span class="normal"><a href="#__codelineno-0-536"> 536</a></span>
<span class="normal"><a href="#__codelineno-0-537"> 537</a></span>
<span class="normal"><a href="#__codelineno-0-538"> 538</a></span>
<span class="normal"><a href="#__codelineno-0-539"> 539</a></span>
<span class="normal"><a href="#__codelineno-0-540"> 540</a></span>
<span class="normal"><a href="#__codelineno-0-541"> 541</a></span>
<span class="normal"><a href="#__codelineno-0-542"> 542</a></span>
<span class="normal"><a href="#__codelineno-0-543"> 543</a></span>
<span class="normal"><a href="#__codelineno-0-544"> 544</a></span>
<span class="normal"><a href="#__codelineno-0-545"> 545</a></span>
<span class="normal"><a href="#__codelineno-0-546"> 546</a></span>
<span class="normal"><a href="#__codelineno-0-547"> 547</a></span>
<span class="normal"><a href="#__codelineno-0-548"> 548</a></span>
<span class="normal"><a href="#__codelineno-0-549"> 549</a></span>
<span class="normal"><a href="#__codelineno-0-550"> 550</a></span>
<span class="normal"><a href="#__codelineno-0-551"> 551</a></span>
<span class="normal"><a href="#__codelineno-0-552"> 552</a></span>
<span class="normal"><a href="#__codelineno-0-553"> 553</a></span>
<span class="normal"><a href="#__codelineno-0-554"> 554</a></span>
<span class="normal"><a href="#__codelineno-0-555"> 555</a></span>
<span class="normal"><a href="#__codelineno-0-556"> 556</a></span>
<span class="normal"><a href="#__codelineno-0-557"> 557</a></span>
<span class="normal"><a href="#__codelineno-0-558"> 558</a></span>
<span class="normal"><a href="#__codelineno-0-559"> 559</a></span>
<span class="normal"><a href="#__codelineno-0-560"> 560</a></span>
<span class="normal"><a href="#__codelineno-0-561"> 561</a></span>
<span class="normal"><a href="#__codelineno-0-562"> 562</a></span>
<span class="normal"><a href="#__codelineno-0-563"> 563</a></span>
<span class="normal"><a href="#__codelineno-0-564"> 564</a></span>
<span class="normal"><a href="#__codelineno-0-565"> 565</a></span>
<span class="normal"><a href="#__codelineno-0-566"> 566</a></span>
<span class="normal"><a href="#__codelineno-0-567"> 567</a></span>
<span class="normal"><a href="#__codelineno-0-568"> 568</a></span>
<span class="normal"><a href="#__codelineno-0-569"> 569</a></span>
<span class="normal"><a href="#__codelineno-0-570"> 570</a></span>
<span class="normal"><a href="#__codelineno-0-571"> 571</a></span>
<span class="normal"><a href="#__codelineno-0-572"> 572</a></span>
<span class="normal"><a href="#__codelineno-0-573"> 573</a></span>
<span class="normal"><a href="#__codelineno-0-574"> 574</a></span>
<span class="normal"><a href="#__codelineno-0-575"> 575</a></span>
<span class="normal"><a href="#__codelineno-0-576"> 576</a></span>
<span class="normal"><a href="#__codelineno-0-577"> 577</a></span>
<span class="normal"><a href="#__codelineno-0-578"> 578</a></span>
<span class="normal"><a href="#__codelineno-0-579"> 579</a></span>
<span class="normal"><a href="#__codelineno-0-580"> 580</a></span>
<span class="normal"><a href="#__codelineno-0-581"> 581</a></span>
<span class="normal"><a href="#__codelineno-0-582"> 582</a></span>
<span class="normal"><a href="#__codelineno-0-583"> 583</a></span>
<span class="normal"><a href="#__codelineno-0-584"> 584</a></span>
<span class="normal"><a href="#__codelineno-0-585"> 585</a></span>
<span class="normal"><a href="#__codelineno-0-586"> 586</a></span>
<span class="normal"><a href="#__codelineno-0-587"> 587</a></span>
<span class="normal"><a href="#__codelineno-0-588"> 588</a></span>
<span class="normal"><a href="#__codelineno-0-589"> 589</a></span>
<span class="normal"><a href="#__codelineno-0-590"> 590</a></span>
<span class="normal"><a href="#__codelineno-0-591"> 591</a></span>
<span class="normal"><a href="#__codelineno-0-592"> 592</a></span>
<span class="normal"><a href="#__codelineno-0-593"> 593</a></span>
<span class="normal"><a href="#__codelineno-0-594"> 594</a></span>
<span class="normal"><a href="#__codelineno-0-595"> 595</a></span>
<span class="normal"><a href="#__codelineno-0-596"> 596</a></span>
<span class="normal"><a href="#__codelineno-0-597"> 597</a></span>
<span class="normal"><a href="#__codelineno-0-598"> 598</a></span>
<span class="normal"><a href="#__codelineno-0-599"> 599</a></span>
<span class="normal"><a href="#__codelineno-0-600"> 600</a></span>
<span class="normal"><a href="#__codelineno-0-601"> 601</a></span>
<span class="normal"><a href="#__codelineno-0-602"> 602</a></span>
<span class="normal"><a href="#__codelineno-0-603"> 603</a></span>
<span class="normal"><a href="#__codelineno-0-604"> 604</a></span>
<span class="normal"><a href="#__codelineno-0-605"> 605</a></span>
<span class="normal"><a href="#__codelineno-0-606"> 606</a></span>
<span class="normal"><a href="#__codelineno-0-607"> 607</a></span>
<span class="normal"><a href="#__codelineno-0-608"> 608</a></span>
<span class="normal"><a href="#__codelineno-0-609"> 609</a></span>
<span class="normal"><a href="#__codelineno-0-610"> 610</a></span>
<span class="normal"><a href="#__codelineno-0-611"> 611</a></span>
<span class="normal"><a href="#__codelineno-0-612"> 612</a></span>
<span class="normal"><a href="#__codelineno-0-613"> 613</a></span>
<span class="normal"><a href="#__codelineno-0-614"> 614</a></span>
<span class="normal"><a href="#__codelineno-0-615"> 615</a></span>
<span class="normal"><a href="#__codelineno-0-616"> 616</a></span>
<span class="normal"><a href="#__codelineno-0-617"> 617</a></span>
<span class="normal"><a href="#__codelineno-0-618"> 618</a></span>
<span class="normal"><a href="#__codelineno-0-619"> 619</a></span>
<span class="normal"><a href="#__codelineno-0-620"> 620</a></span>
<span class="normal"><a href="#__codelineno-0-621"> 621</a></span>
<span class="normal"><a href="#__codelineno-0-622"> 622</a></span>
<span class="normal"><a href="#__codelineno-0-623"> 623</a></span>
<span class="normal"><a href="#__codelineno-0-624"> 624</a></span>
<span class="normal"><a href="#__codelineno-0-625"> 625</a></span>
<span class="normal"><a href="#__codelineno-0-626"> 626</a></span>
<span class="normal"><a href="#__codelineno-0-627"> 627</a></span>
<span class="normal"><a href="#__codelineno-0-628"> 628</a></span>
<span class="normal"><a href="#__codelineno-0-629"> 629</a></span>
<span class="normal"><a href="#__codelineno-0-630"> 630</a></span>
<span class="normal"><a href="#__codelineno-0-631"> 631</a></span>
<span class="normal"><a href="#__codelineno-0-632"> 632</a></span>
<span class="normal"><a href="#__codelineno-0-633"> 633</a></span>
<span class="normal"><a href="#__codelineno-0-634"> 634</a></span>
<span class="normal"><a href="#__codelineno-0-635"> 635</a></span>
<span class="normal"><a href="#__codelineno-0-636"> 636</a></span>
<span class="normal"><a href="#__codelineno-0-637"> 637</a></span>
<span class="normal"><a href="#__codelineno-0-638"> 638</a></span>
<span class="normal"><a href="#__codelineno-0-639"> 639</a></span>
<span class="normal"><a href="#__codelineno-0-640"> 640</a></span>
<span class="normal"><a href="#__codelineno-0-641"> 641</a></span>
<span class="normal"><a href="#__codelineno-0-642"> 642</a></span>
<span class="normal"><a href="#__codelineno-0-643"> 643</a></span>
<span class="normal"><a href="#__codelineno-0-644"> 644</a></span>
<span class="normal"><a href="#__codelineno-0-645"> 645</a></span>
<span class="normal"><a href="#__codelineno-0-646"> 646</a></span>
<span class="normal"><a href="#__codelineno-0-647"> 647</a></span>
<span class="normal"><a href="#__codelineno-0-648"> 648</a></span>
<span class="normal"><a href="#__codelineno-0-649"> 649</a></span>
<span class="normal"><a href="#__codelineno-0-650"> 650</a></span>
<span class="normal"><a href="#__codelineno-0-651"> 651</a></span>
<span class="normal"><a href="#__codelineno-0-652"> 652</a></span>
<span class="normal"><a href="#__codelineno-0-653"> 653</a></span>
<span class="normal"><a href="#__codelineno-0-654"> 654</a></span>
<span class="normal"><a href="#__codelineno-0-655"> 655</a></span>
<span class="normal"><a href="#__codelineno-0-656"> 656</a></span>
<span class="normal"><a href="#__codelineno-0-657"> 657</a></span>
<span class="normal"><a href="#__codelineno-0-658"> 658</a></span>
<span class="normal"><a href="#__codelineno-0-659"> 659</a></span>
<span class="normal"><a href="#__codelineno-0-660"> 660</a></span>
<span class="normal"><a href="#__codelineno-0-661"> 661</a></span>
<span class="normal"><a href="#__codelineno-0-662"> 662</a></span>
<span class="normal"><a href="#__codelineno-0-663"> 663</a></span>
<span class="normal"><a href="#__codelineno-0-664"> 664</a></span>
<span class="normal"><a href="#__codelineno-0-665"> 665</a></span>
<span class="normal"><a href="#__codelineno-0-666"> 666</a></span>
<span class="normal"><a href="#__codelineno-0-667"> 667</a></span>
<span class="normal"><a href="#__codelineno-0-668"> 668</a></span>
<span class="normal"><a href="#__codelineno-0-669"> 669</a></span>
<span class="normal"><a href="#__codelineno-0-670"> 670</a></span>
<span class="normal"><a href="#__codelineno-0-671"> 671</a></span>
<span class="normal"><a href="#__codelineno-0-672"> 672</a></span>
<span class="normal"><a href="#__codelineno-0-673"> 673</a></span>
<span class="normal"><a href="#__codelineno-0-674"> 674</a></span>
<span class="normal"><a href="#__codelineno-0-675"> 675</a></span>
<span class="normal"><a href="#__codelineno-0-676"> 676</a></span>
<span class="normal"><a href="#__codelineno-0-677"> 677</a></span>
<span class="normal"><a href="#__codelineno-0-678"> 678</a></span>
<span class="normal"><a href="#__codelineno-0-679"> 679</a></span>
<span class="normal"><a href="#__codelineno-0-680"> 680</a></span>
<span class="normal"><a href="#__codelineno-0-681"> 681</a></span>
<span class="normal"><a href="#__codelineno-0-682"> 682</a></span>
<span class="normal"><a href="#__codelineno-0-683"> 683</a></span>
<span class="normal"><a href="#__codelineno-0-684"> 684</a></span>
<span class="normal"><a href="#__codelineno-0-685"> 685</a></span>
<span class="normal"><a href="#__codelineno-0-686"> 686</a></span>
<span class="normal"><a href="#__codelineno-0-687"> 687</a></span>
<span class="normal"><a href="#__codelineno-0-688"> 688</a></span>
<span class="normal"><a href="#__codelineno-0-689"> 689</a></span>
<span class="normal"><a href="#__codelineno-0-690"> 690</a></span>
<span class="normal"><a href="#__codelineno-0-691"> 691</a></span>
<span class="normal"><a href="#__codelineno-0-692"> 692</a></span>
<span class="normal"><a href="#__codelineno-0-693"> 693</a></span>
<span class="normal"><a href="#__codelineno-0-694"> 694</a></span>
<span class="normal"><a href="#__codelineno-0-695"> 695</a></span>
<span class="normal"><a href="#__codelineno-0-696"> 696</a></span>
<span class="normal"><a href="#__codelineno-0-697"> 697</a></span>
<span class="normal"><a href="#__codelineno-0-698"> 698</a></span>
<span class="normal"><a href="#__codelineno-0-699"> 699</a></span>
<span class="normal"><a href="#__codelineno-0-700"> 700</a></span>
<span class="normal"><a href="#__codelineno-0-701"> 701</a></span>
<span class="normal"><a href="#__codelineno-0-702"> 702</a></span>
<span class="normal"><a href="#__codelineno-0-703"> 703</a></span>
<span class="normal"><a href="#__codelineno-0-704"> 704</a></span>
<span class="normal"><a href="#__codelineno-0-705"> 705</a></span>
<span class="normal"><a href="#__codelineno-0-706"> 706</a></span>
<span class="normal"><a href="#__codelineno-0-707"> 707</a></span>
<span class="normal"><a href="#__codelineno-0-708"> 708</a></span>
<span class="normal"><a href="#__codelineno-0-709"> 709</a></span>
<span class="normal"><a href="#__codelineno-0-710"> 710</a></span>
<span class="normal"><a href="#__codelineno-0-711"> 711</a></span>
<span class="normal"><a href="#__codelineno-0-712"> 712</a></span>
<span class="normal"><a href="#__codelineno-0-713"> 713</a></span>
<span class="normal"><a href="#__codelineno-0-714"> 714</a></span>
<span class="normal"><a href="#__codelineno-0-715"> 715</a></span>
<span class="normal"><a href="#__codelineno-0-716"> 716</a></span>
<span class="normal"><a href="#__codelineno-0-717"> 717</a></span>
<span class="normal"><a href="#__codelineno-0-718"> 718</a></span>
<span class="normal"><a href="#__codelineno-0-719"> 719</a></span>
<span class="normal"><a href="#__codelineno-0-720"> 720</a></span>
<span class="normal"><a href="#__codelineno-0-721"> 721</a></span>
<span class="normal"><a href="#__codelineno-0-722"> 722</a></span>
<span class="normal"><a href="#__codelineno-0-723"> 723</a></span>
<span class="normal"><a href="#__codelineno-0-724"> 724</a></span>
<span class="normal"><a href="#__codelineno-0-725"> 725</a></span>
<span class="normal"><a href="#__codelineno-0-726"> 726</a></span>
<span class="normal"><a href="#__codelineno-0-727"> 727</a></span>
<span class="normal"><a href="#__codelineno-0-728"> 728</a></span>
<span class="normal"><a href="#__codelineno-0-729"> 729</a></span>
<span class="normal"><a href="#__codelineno-0-730"> 730</a></span>
<span class="normal"><a href="#__codelineno-0-731"> 731</a></span>
<span class="normal"><a href="#__codelineno-0-732"> 732</a></span>
<span class="normal"><a href="#__codelineno-0-733"> 733</a></span>
<span class="normal"><a href="#__codelineno-0-734"> 734</a></span>
<span class="normal"><a href="#__codelineno-0-735"> 735</a></span>
<span class="normal"><a href="#__codelineno-0-736"> 736</a></span>
<span class="normal"><a href="#__codelineno-0-737"> 737</a></span>
<span class="normal"><a href="#__codelineno-0-738"> 738</a></span>
<span class="normal"><a href="#__codelineno-0-739"> 739</a></span>
<span class="normal"><a href="#__codelineno-0-740"> 740</a></span>
<span class="normal"><a href="#__codelineno-0-741"> 741</a></span>
<span class="normal"><a href="#__codelineno-0-742"> 742</a></span>
<span class="normal"><a href="#__codelineno-0-743"> 743</a></span>
<span class="normal"><a href="#__codelineno-0-744"> 744</a></span>
<span class="normal"><a href="#__codelineno-0-745"> 745</a></span>
<span class="normal"><a href="#__codelineno-0-746"> 746</a></span>
<span class="normal"><a href="#__codelineno-0-747"> 747</a></span>
<span class="normal"><a href="#__codelineno-0-748"> 748</a></span>
<span class="normal"><a href="#__codelineno-0-749"> 749</a></span>
<span class="normal"><a href="#__codelineno-0-750"> 750</a></span>
<span class="normal"><a href="#__codelineno-0-751"> 751</a></span>
<span class="normal"><a href="#__codelineno-0-752"> 752</a></span>
<span class="normal"><a href="#__codelineno-0-753"> 753</a></span>
<span class="normal"><a href="#__codelineno-0-754"> 754</a></span>
<span class="normal"><a href="#__codelineno-0-755"> 755</a></span>
<span class="normal"><a href="#__codelineno-0-756"> 756</a></span>
<span class="normal"><a href="#__codelineno-0-757"> 757</a></span>
<span class="normal"><a href="#__codelineno-0-758"> 758</a></span>
<span class="normal"><a href="#__codelineno-0-759"> 759</a></span>
<span class="normal"><a href="#__codelineno-0-760"> 760</a></span>
<span class="normal"><a href="#__codelineno-0-761"> 761</a></span>
<span class="normal"><a href="#__codelineno-0-762"> 762</a></span>
<span class="normal"><a href="#__codelineno-0-763"> 763</a></span>
<span class="normal"><a href="#__codelineno-0-764"> 764</a></span>
<span class="normal"><a href="#__codelineno-0-765"> 765</a></span>
<span class="normal"><a href="#__codelineno-0-766"> 766</a></span>
<span class="normal"><a href="#__codelineno-0-767"> 767</a></span>
<span class="normal"><a href="#__codelineno-0-768"> 768</a></span>
<span class="normal"><a href="#__codelineno-0-769"> 769</a></span>
<span class="normal"><a href="#__codelineno-0-770"> 770</a></span>
<span class="normal"><a href="#__codelineno-0-771"> 771</a></span>
<span class="normal"><a href="#__codelineno-0-772"> 772</a></span>
<span class="normal"><a href="#__codelineno-0-773"> 773</a></span>
<span class="normal"><a href="#__codelineno-0-774"> 774</a></span>
<span class="normal"><a href="#__codelineno-0-775"> 775</a></span>
<span class="normal"><a href="#__codelineno-0-776"> 776</a></span>
<span class="normal"><a href="#__codelineno-0-777"> 777</a></span>
<span class="normal"><a href="#__codelineno-0-778"> 778</a></span>
<span class="normal"><a href="#__codelineno-0-779"> 779</a></span>
<span class="normal"><a href="#__codelineno-0-780"> 780</a></span>
<span class="normal"><a href="#__codelineno-0-781"> 781</a></span>
<span class="normal"><a href="#__codelineno-0-782"> 782</a></span>
<span class="normal"><a href="#__codelineno-0-783"> 783</a></span>
<span class="normal"><a href="#__codelineno-0-784"> 784</a></span>
<span class="normal"><a href="#__codelineno-0-785"> 785</a></span>
<span class="normal"><a href="#__codelineno-0-786"> 786</a></span>
<span class="normal"><a href="#__codelineno-0-787"> 787</a></span>
<span class="normal"><a href="#__codelineno-0-788"> 788</a></span>
<span class="normal"><a href="#__codelineno-0-789"> 789</a></span>
<span class="normal"><a href="#__codelineno-0-790"> 790</a></span>
<span class="normal"><a href="#__codelineno-0-791"> 791</a></span>
<span class="normal"><a href="#__codelineno-0-792"> 792</a></span>
<span class="normal"><a href="#__codelineno-0-793"> 793</a></span>
<span class="normal"><a href="#__codelineno-0-794"> 794</a></span>
<span class="normal"><a href="#__codelineno-0-795"> 795</a></span>
<span class="normal"><a href="#__codelineno-0-796"> 796</a></span>
<span class="normal"><a href="#__codelineno-0-797"> 797</a></span>
<span class="normal"><a href="#__codelineno-0-798"> 798</a></span>
<span class="normal"><a href="#__codelineno-0-799"> 799</a></span>
<span class="normal"><a href="#__codelineno-0-800"> 800</a></span>
<span class="normal"><a href="#__codelineno-0-801"> 801</a></span>
<span class="normal"><a href="#__codelineno-0-802"> 802</a></span>
<span class="normal"><a href="#__codelineno-0-803"> 803</a></span>
<span class="normal"><a href="#__codelineno-0-804"> 804</a></span>
<span class="normal"><a href="#__codelineno-0-805"> 805</a></span>
<span class="normal"><a href="#__codelineno-0-806"> 806</a></span>
<span class="normal"><a href="#__codelineno-0-807"> 807</a></span>
<span class="normal"><a href="#__codelineno-0-808"> 808</a></span>
<span class="normal"><a href="#__codelineno-0-809"> 809</a></span>
<span class="normal"><a href="#__codelineno-0-810"> 810</a></span>
<span class="normal"><a href="#__codelineno-0-811"> 811</a></span>
<span class="normal"><a href="#__codelineno-0-812"> 812</a></span>
<span class="normal"><a href="#__codelineno-0-813"> 813</a></span>
<span class="normal"><a href="#__codelineno-0-814"> 814</a></span>
<span class="normal"><a href="#__codelineno-0-815"> 815</a></span>
<span class="normal"><a href="#__codelineno-0-816"> 816</a></span>
<span class="normal"><a href="#__codelineno-0-817"> 817</a></span>
<span class="normal"><a href="#__codelineno-0-818"> 818</a></span>
<span class="normal"><a href="#__codelineno-0-819"> 819</a></span>
<span class="normal"><a href="#__codelineno-0-820"> 820</a></span>
<span class="normal"><a href="#__codelineno-0-821"> 821</a></span>
<span class="normal"><a href="#__codelineno-0-822"> 822</a></span>
<span class="normal"><a href="#__codelineno-0-823"> 823</a></span>
<span class="normal"><a href="#__codelineno-0-824"> 824</a></span>
<span class="normal"><a href="#__codelineno-0-825"> 825</a></span>
<span class="normal"><a href="#__codelineno-0-826"> 826</a></span>
<span class="normal"><a href="#__codelineno-0-827"> 827</a></span>
<span class="normal"><a href="#__codelineno-0-828"> 828</a></span>
<span class="normal"><a href="#__codelineno-0-829"> 829</a></span>
<span class="normal"><a href="#__codelineno-0-830"> 830</a></span>
<span class="normal"><a href="#__codelineno-0-831"> 831</a></span>
<span class="normal"><a href="#__codelineno-0-832"> 832</a></span>
<span class="normal"><a href="#__codelineno-0-833"> 833</a></span>
<span class="normal"><a href="#__codelineno-0-834"> 834</a></span>
<span class="normal"><a href="#__codelineno-0-835"> 835</a></span>
<span class="normal"><a href="#__codelineno-0-836"> 836</a></span>
<span class="normal"><a href="#__codelineno-0-837"> 837</a></span>
<span class="normal"><a href="#__codelineno-0-838"> 838</a></span>
<span class="normal"><a href="#__codelineno-0-839"> 839</a></span>
<span class="normal"><a href="#__codelineno-0-840"> 840</a></span>
<span class="normal"><a href="#__codelineno-0-841"> 841</a></span>
<span class="normal"><a href="#__codelineno-0-842"> 842</a></span>
<span class="normal"><a href="#__codelineno-0-843"> 843</a></span>
<span class="normal"><a href="#__codelineno-0-844"> 844</a></span>
<span class="normal"><a href="#__codelineno-0-845"> 845</a></span>
<span class="normal"><a href="#__codelineno-0-846"> 846</a></span>
<span class="normal"><a href="#__codelineno-0-847"> 847</a></span>
<span class="normal"><a href="#__codelineno-0-848"> 848</a></span>
<span class="normal"><a href="#__codelineno-0-849"> 849</a></span>
<span class="normal"><a href="#__codelineno-0-850"> 850</a></span>
<span class="normal"><a href="#__codelineno-0-851"> 851</a></span>
<span class="normal"><a href="#__codelineno-0-852"> 852</a></span>
<span class="normal"><a href="#__codelineno-0-853"> 853</a></span>
<span class="normal"><a href="#__codelineno-0-854"> 854</a></span>
<span class="normal"><a href="#__codelineno-0-855"> 855</a></span>
<span class="normal"><a href="#__codelineno-0-856"> 856</a></span>
<span class="normal"><a href="#__codelineno-0-857"> 857</a></span>
<span class="normal"><a href="#__codelineno-0-858"> 858</a></span>
<span class="normal"><a href="#__codelineno-0-859"> 859</a></span>
<span class="normal"><a href="#__codelineno-0-860"> 860</a></span>
<span class="normal"><a href="#__codelineno-0-861"> 861</a></span>
<span class="normal"><a href="#__codelineno-0-862"> 862</a></span>
<span class="normal"><a href="#__codelineno-0-863"> 863</a></span>
<span class="normal"><a href="#__codelineno-0-864"> 864</a></span>
<span class="normal"><a href="#__codelineno-0-865"> 865</a></span>
<span class="normal"><a href="#__codelineno-0-866"> 866</a></span>
<span class="normal"><a href="#__codelineno-0-867"> 867</a></span>
<span class="normal"><a href="#__codelineno-0-868"> 868</a></span>
<span class="normal"><a href="#__codelineno-0-869"> 869</a></span>
<span class="normal"><a href="#__codelineno-0-870"> 870</a></span>
<span class="normal"><a href="#__codelineno-0-871"> 871</a></span>
<span class="normal"><a href="#__codelineno-0-872"> 872</a></span>
<span class="normal"><a href="#__codelineno-0-873"> 873</a></span>
<span class="normal"><a href="#__codelineno-0-874"> 874</a></span>
<span class="normal"><a href="#__codelineno-0-875"> 875</a></span>
<span class="normal"><a href="#__codelineno-0-876"> 876</a></span>
<span class="normal"><a href="#__codelineno-0-877"> 877</a></span>
<span class="normal"><a href="#__codelineno-0-878"> 878</a></span>
<span class="normal"><a href="#__codelineno-0-879"> 879</a></span>
<span class="normal"><a href="#__codelineno-0-880"> 880</a></span>
<span class="normal"><a href="#__codelineno-0-881"> 881</a></span>
<span class="normal"><a href="#__codelineno-0-882"> 882</a></span>
<span class="normal"><a href="#__codelineno-0-883"> 883</a></span>
<span class="normal"><a href="#__codelineno-0-884"> 884</a></span>
<span class="normal"><a href="#__codelineno-0-885"> 885</a></span>
<span class="normal"><a href="#__codelineno-0-886"> 886</a></span>
<span class="normal"><a href="#__codelineno-0-887"> 887</a></span>
<span class="normal"><a href="#__codelineno-0-888"> 888</a></span>
<span class="normal"><a href="#__codelineno-0-889"> 889</a></span>
<span class="normal"><a href="#__codelineno-0-890"> 890</a></span>
<span class="normal"><a href="#__codelineno-0-891"> 891</a></span>
<span class="normal"><a href="#__codelineno-0-892"> 892</a></span>
<span class="normal"><a href="#__codelineno-0-893"> 893</a></span>
<span class="normal"><a href="#__codelineno-0-894"> 894</a></span>
<span class="normal"><a href="#__codelineno-0-895"> 895</a></span>
<span class="normal"><a href="#__codelineno-0-896"> 896</a></span>
<span class="normal"><a href="#__codelineno-0-897"> 897</a></span>
<span class="normal"><a href="#__codelineno-0-898"> 898</a></span>
<span class="normal"><a href="#__codelineno-0-899"> 899</a></span>
<span class="normal"><a href="#__codelineno-0-900"> 900</a></span>
<span class="normal"><a href="#__codelineno-0-901"> 901</a></span>
<span class="normal"><a href="#__codelineno-0-902"> 902</a></span>
<span class="normal"><a href="#__codelineno-0-903"> 903</a></span>
<span class="normal"><a href="#__codelineno-0-904"> 904</a></span>
<span class="normal"><a href="#__codelineno-0-905"> 905</a></span>
<span class="normal"><a href="#__codelineno-0-906"> 906</a></span>
<span class="normal"><a href="#__codelineno-0-907"> 907</a></span>
<span class="normal"><a href="#__codelineno-0-908"> 908</a></span>
<span class="normal"><a href="#__codelineno-0-909"> 909</a></span>
<span class="normal"><a href="#__codelineno-0-910"> 910</a></span>
<span class="normal"><a href="#__codelineno-0-911"> 911</a></span>
<span class="normal"><a href="#__codelineno-0-912"> 912</a></span>
<span class="normal"><a href="#__codelineno-0-913"> 913</a></span>
<span class="normal"><a href="#__codelineno-0-914"> 914</a></span>
<span class="normal"><a href="#__codelineno-0-915"> 915</a></span>
<span class="normal"><a href="#__codelineno-0-916"> 916</a></span>
<span class="normal"><a href="#__codelineno-0-917"> 917</a></span>
<span class="normal"><a href="#__codelineno-0-918"> 918</a></span>
<span class="normal"><a href="#__codelineno-0-919"> 919</a></span>
<span class="normal"><a href="#__codelineno-0-920"> 920</a></span>
<span class="normal"><a href="#__codelineno-0-921"> 921</a></span>
<span class="normal"><a href="#__codelineno-0-922"> 922</a></span>
<span class="normal"><a href="#__codelineno-0-923"> 923</a></span>
<span class="normal"><a href="#__codelineno-0-924"> 924</a></span>
<span class="normal"><a href="#__codelineno-0-925"> 925</a></span>
<span class="normal"><a href="#__codelineno-0-926"> 926</a></span>
<span class="normal"><a href="#__codelineno-0-927"> 927</a></span>
<span class="normal"><a href="#__codelineno-0-928"> 928</a></span>
<span class="normal"><a href="#__codelineno-0-929"> 929</a></span>
<span class="normal"><a href="#__codelineno-0-930"> 930</a></span>
<span class="normal"><a href="#__codelineno-0-931"> 931</a></span>
<span class="normal"><a href="#__codelineno-0-932"> 932</a></span>
<span class="normal"><a href="#__codelineno-0-933"> 933</a></span>
<span class="normal"><a href="#__codelineno-0-934"> 934</a></span>
<span class="normal"><a href="#__codelineno-0-935"> 935</a></span>
<span class="normal"><a href="#__codelineno-0-936"> 936</a></span>
<span class="normal"><a href="#__codelineno-0-937"> 937</a></span>
<span class="normal"><a href="#__codelineno-0-938"> 938</a></span>
<span class="normal"><a href="#__codelineno-0-939"> 939</a></span>
<span class="normal"><a href="#__codelineno-0-940"> 940</a></span>
<span class="normal"><a href="#__codelineno-0-941"> 941</a></span>
<span class="normal"><a href="#__codelineno-0-942"> 942</a></span>
<span class="normal"><a href="#__codelineno-0-943"> 943</a></span>
<span class="normal"><a href="#__codelineno-0-944"> 944</a></span>
<span class="normal"><a href="#__codelineno-0-945"> 945</a></span>
<span class="normal"><a href="#__codelineno-0-946"> 946</a></span>
<span class="normal"><a href="#__codelineno-0-947"> 947</a></span>
<span class="normal"><a href="#__codelineno-0-948"> 948</a></span>
<span class="normal"><a href="#__codelineno-0-949"> 949</a></span>
<span class="normal"><a href="#__codelineno-0-950"> 950</a></span>
<span class="normal"><a href="#__codelineno-0-951"> 951</a></span>
<span class="normal"><a href="#__codelineno-0-952"> 952</a></span>
<span class="normal"><a href="#__codelineno-0-953"> 953</a></span>
<span class="normal"><a href="#__codelineno-0-954"> 954</a></span>
<span class="normal"><a href="#__codelineno-0-955"> 955</a></span>
<span class="normal"><a href="#__codelineno-0-956"> 956</a></span>
<span class="normal"><a href="#__codelineno-0-957"> 957</a></span>
<span class="normal"><a href="#__codelineno-0-958"> 958</a></span>
<span class="normal"><a href="#__codelineno-0-959"> 959</a></span>
<span class="normal"><a href="#__codelineno-0-960"> 960</a></span>
<span class="normal"><a href="#__codelineno-0-961"> 961</a></span>
<span class="normal"><a href="#__codelineno-0-962"> 962</a></span>
<span class="normal"><a href="#__codelineno-0-963"> 963</a></span>
<span class="normal"><a href="#__codelineno-0-964"> 964</a></span>
<span class="normal"><a href="#__codelineno-0-965"> 965</a></span>
<span class="normal"><a href="#__codelineno-0-966"> 966</a></span>
<span class="normal"><a href="#__codelineno-0-967"> 967</a></span>
<span class="normal"><a href="#__codelineno-0-968"> 968</a></span>
<span class="normal"><a href="#__codelineno-0-969"> 969</a></span>
<span class="normal"><a href="#__codelineno-0-970"> 970</a></span>
<span class="normal"><a href="#__codelineno-0-971"> 971</a></span>
<span class="normal"><a href="#__codelineno-0-972"> 972</a></span>
<span class="normal"><a href="#__codelineno-0-973"> 973</a></span>
<span class="normal"><a href="#__codelineno-0-974"> 974</a></span>
<span class="normal"><a href="#__codelineno-0-975"> 975</a></span>
<span class="normal"><a href="#__codelineno-0-976"> 976</a></span>
<span class="normal"><a href="#__codelineno-0-977"> 977</a></span>
<span class="normal"><a href="#__codelineno-0-978"> 978</a></span>
<span class="normal"><a href="#__codelineno-0-979"> 979</a></span>
<span class="normal"><a href="#__codelineno-0-980"> 980</a></span>
<span class="normal"><a href="#__codelineno-0-981"> 981</a></span>
<span class="normal"><a href="#__codelineno-0-982"> 982</a></span>
<span class="normal"><a href="#__codelineno-0-983"> 983</a></span>
<span class="normal"><a href="#__codelineno-0-984"> 984</a></span>
<span class="normal"><a href="#__codelineno-0-985"> 985</a></span>
<span class="normal"><a href="#__codelineno-0-986"> 986</a></span>
<span class="normal"><a href="#__codelineno-0-987"> 987</a></span>
<span class="normal"><a href="#__codelineno-0-988"> 988</a></span>
<span class="normal"><a href="#__codelineno-0-989"> 989</a></span>
<span class="normal"><a href="#__codelineno-0-990"> 990</a></span>
<span class="normal"><a href="#__codelineno-0-991"> 991</a></span>
<span class="normal"><a href="#__codelineno-0-992"> 992</a></span>
<span class="normal"><a href="#__codelineno-0-993"> 993</a></span>
<span class="normal"><a href="#__codelineno-0-994"> 994</a></span>
<span class="normal"><a href="#__codelineno-0-995"> 995</a></span>
<span class="normal"><a href="#__codelineno-0-996"> 996</a></span>
<span class="normal"><a href="#__codelineno-0-997"> 997</a></span>
<span class="normal"><a href="#__codelineno-0-998"> 998</a></span>
<span class="normal"><a href="#__codelineno-0-999"> 999</a></span>
<span class="normal"><a href="#__codelineno-0-1000">1000</a></span>
<span class="normal"><a href="#__codelineno-0-1001">1001</a></span>
<span class="normal"><a href="#__codelineno-0-1002">1002</a></span>
<span class="normal"><a href="#__codelineno-0-1003">1003</a></span>
<span class="normal"><a href="#__codelineno-0-1004">1004</a></span>
<span class="normal"><a href="#__codelineno-0-1005">1005</a></span>
<span class="normal"><a href="#__codelineno-0-1006">1006</a></span>
<span class="normal"><a href="#__codelineno-0-1007">1007</a></span>
<span class="normal"><a href="#__codelineno-0-1008">1008</a></span>
<span class="normal"><a href="#__codelineno-0-1009">1009</a></span>
<span class="normal"><a href="#__codelineno-0-1010">1010</a></span>
<span class="normal"><a href="#__codelineno-0-1011">1011</a></span>
<span class="normal"><a href="#__codelineno-0-1012">1012</a></span>
<span class="normal"><a href="#__codelineno-0-1013">1013</a></span>
<span class="normal"><a href="#__codelineno-0-1014">1014</a></span>
<span class="normal"><a href="#__codelineno-0-1015">1015</a></span>
<span class="normal"><a href="#__codelineno-0-1016">1016</a></span>
<span class="normal"><a href="#__codelineno-0-1017">1017</a></span>
<span class="normal"><a href="#__codelineno-0-1018">1018</a></span>
<span class="normal"><a href="#__codelineno-0-1019">1019</a></span>
<span class="normal"><a href="#__codelineno-0-1020">1020</a></span>
<span class="normal"><a href="#__codelineno-0-1021">1021</a></span>
<span class="normal"><a href="#__codelineno-0-1022">1022</a></span>
<span class="normal"><a href="#__codelineno-0-1023">1023</a></span>
<span class="normal"><a href="#__codelineno-0-1024">1024</a></span>
<span class="normal"><a href="#__codelineno-0-1025">1025</a></span>
<span class="normal"><a href="#__codelineno-0-1026">1026</a></span>
<span class="normal"><a href="#__codelineno-0-1027">1027</a></span>
<span class="normal"><a href="#__codelineno-0-1028">1028</a></span>
<span class="normal"><a href="#__codelineno-0-1029">1029</a></span>
<span class="normal"><a href="#__codelineno-0-1030">1030</a></span>
<span class="normal"><a href="#__codelineno-0-1031">1031</a></span>
<span class="normal"><a href="#__codelineno-0-1032">1032</a></span>
<span class="normal"><a href="#__codelineno-0-1033">1033</a></span>
<span class="normal"><a href="#__codelineno-0-1034">1034</a></span>
<span class="normal"><a href="#__codelineno-0-1035">1035</a></span>
<span class="normal"><a href="#__codelineno-0-1036">1036</a></span>
<span class="normal"><a href="#__codelineno-0-1037">1037</a></span>
<span class="normal"><a href="#__codelineno-0-1038">1038</a></span>
<span class="normal"><a href="#__codelineno-0-1039">1039</a></span>
<span class="normal"><a href="#__codelineno-0-1040">1040</a></span>
<span class="normal"><a href="#__codelineno-0-1041">1041</a></span>
<span class="normal"><a href="#__codelineno-0-1042">1042</a></span>
<span class="normal"><a href="#__codelineno-0-1043">1043</a></span>
<span class="normal"><a href="#__codelineno-0-1044">1044</a></span>
<span class="normal"><a href="#__codelineno-0-1045">1045</a></span>
<span class="normal"><a href="#__codelineno-0-1046">1046</a></span>
<span class="normal"><a href="#__codelineno-0-1047">1047</a></span>
<span class="normal"><a href="#__codelineno-0-1048">1048</a></span>
<span class="normal"><a href="#__codelineno-0-1049">1049</a></span>
<span class="normal"><a href="#__codelineno-0-1050">1050</a></span>
<span class="normal"><a href="#__codelineno-0-1051">1051</a></span>
<span class="normal"><a href="#__codelineno-0-1052">1052</a></span>
<span class="normal"><a href="#__codelineno-0-1053">1053</a></span>
<span class="normal"><a href="#__codelineno-0-1054">1054</a></span>
<span class="normal"><a href="#__codelineno-0-1055">1055</a></span>
<span class="normal"><a href="#__codelineno-0-1056">1056</a></span>
<span class="normal"><a href="#__codelineno-0-1057">1057</a></span>
<span class="normal"><a href="#__codelineno-0-1058">1058</a></span>
<span class="normal"><a href="#__codelineno-0-1059">1059</a></span>
<span class="normal"><a href="#__codelineno-0-1060">1060</a></span>
<span class="normal"><a href="#__codelineno-0-1061">1061</a></span>
<span class="normal"><a href="#__codelineno-0-1062">1062</a></span>
<span class="normal"><a href="#__codelineno-0-1063">1063</a></span>
<span class="normal"><a href="#__codelineno-0-1064">1064</a></span>
<span class="normal"><a href="#__codelineno-0-1065">1065</a></span>
<span class="normal"><a href="#__codelineno-0-1066">1066</a></span>
<span class="normal"><a href="#__codelineno-0-1067">1067</a></span>
<span class="normal"><a href="#__codelineno-0-1068">1068</a></span>
<span class="normal"><a href="#__codelineno-0-1069">1069</a></span>
<span class="normal"><a href="#__codelineno-0-1070">1070</a></span>
<span class="normal"><a href="#__codelineno-0-1071">1071</a></span>
<span class="normal"><a href="#__codelineno-0-1072">1072</a></span>
<span class="normal"><a href="#__codelineno-0-1073">1073</a></span>
<span class="normal"><a href="#__codelineno-0-1074">1074</a></span>
<span class="normal"><a href="#__codelineno-0-1075">1075</a></span>
<span class="normal"><a href="#__codelineno-0-1076">1076</a></span>
<span class="normal"><a href="#__codelineno-0-1077">1077</a></span>
<span class="normal"><a href="#__codelineno-0-1078">1078</a></span>
<span class="normal"><a href="#__codelineno-0-1079">1079</a></span>
<span class="normal"><a href="#__codelineno-0-1080">1080</a></span>
<span class="normal"><a href="#__codelineno-0-1081">1081</a></span>
<span class="normal"><a href="#__codelineno-0-1082">1082</a></span>
<span class="normal"><a href="#__codelineno-0-1083">1083</a></span>
<span class="normal"><a href="#__codelineno-0-1084">1084</a></span>
<span class="normal"><a href="#__codelineno-0-1085">1085</a></span>
<span class="normal"><a href="#__codelineno-0-1086">1086</a></span>
<span class="normal"><a href="#__codelineno-0-1087">1087</a></span>
<span class="normal"><a href="#__codelineno-0-1088">1088</a></span>
<span class="normal"><a href="#__codelineno-0-1089">1089</a></span>
<span class="normal"><a href="#__codelineno-0-1090">1090</a></span>
<span class="normal"><a href="#__codelineno-0-1091">1091</a></span>
<span class="normal"><a href="#__codelineno-0-1092">1092</a></span>
<span class="normal"><a href="#__codelineno-0-1093">1093</a></span>
<span class="normal"><a href="#__codelineno-0-1094">1094</a></span>
<span class="normal"><a href="#__codelineno-0-1095">1095</a></span>
<span class="normal"><a href="#__codelineno-0-1096">1096</a></span>
<span class="normal"><a href="#__codelineno-0-1097">1097</a></span>
<span class="normal"><a href="#__codelineno-0-1098">1098</a></span>
<span class="normal"><a href="#__codelineno-0-1099">1099</a></span>
<span class="normal"><a href="#__codelineno-0-1100">1100</a></span>
<span class="normal"><a href="#__codelineno-0-1101">1101</a></span>
<span class="normal"><a href="#__codelineno-0-1102">1102</a></span>
<span class="normal"><a href="#__codelineno-0-1103">1103</a></span>
<span class="normal"><a href="#__codelineno-0-1104">1104</a></span>
<span class="normal"><a href="#__codelineno-0-1105">1105</a></span>
<span class="normal"><a href="#__codelineno-0-1106">1106</a></span>
<span class="normal"><a href="#__codelineno-0-1107">1107</a></span>
<span class="normal"><a href="#__codelineno-0-1108">1108</a></span>
<span class="normal"><a href="#__codelineno-0-1109">1109</a></span>
<span class="normal"><a href="#__codelineno-0-1110">1110</a></span>
<span class="normal"><a href="#__codelineno-0-1111">1111</a></span>
<span class="normal"><a href="#__codelineno-0-1112">1112</a></span>
<span class="normal"><a href="#__codelineno-0-1113">1113</a></span>
<span class="normal"><a href="#__codelineno-0-1114">1114</a></span>
<span class="normal"><a href="#__codelineno-0-1115">1115</a></span>
<span class="normal"><a href="#__codelineno-0-1116">1116</a></span>
<span class="normal"><a href="#__codelineno-0-1117">1117</a></span>
<span class="normal"><a href="#__codelineno-0-1118">1118</a></span>
<span class="normal"><a href="#__codelineno-0-1119">1119</a></span>
<span class="normal"><a href="#__codelineno-0-1120">1120</a></span>
<span class="normal"><a href="#__codelineno-0-1121">1121</a></span>
<span class="normal"><a href="#__codelineno-0-1122">1122</a></span>
<span class="normal"><a href="#__codelineno-0-1123">1123</a></span>
<span class="normal"><a href="#__codelineno-0-1124">1124</a></span>
<span class="normal"><a href="#__codelineno-0-1125">1125</a></span>
<span class="normal"><a href="#__codelineno-0-1126">1126</a></span>
<span class="normal"><a href="#__codelineno-0-1127">1127</a></span>
<span class="normal"><a href="#__codelineno-0-1128">1128</a></span>
<span class="normal"><a href="#__codelineno-0-1129">1129</a></span>
<span class="normal"><a href="#__codelineno-0-1130">1130</a></span>
<span class="normal"><a href="#__codelineno-0-1131">1131</a></span>
<span class="normal"><a href="#__codelineno-0-1132">1132</a></span>
<span class="normal"><a href="#__codelineno-0-1133">1133</a></span>
<span class="normal"><a href="#__codelineno-0-1134">1134</a></span>
<span class="normal"><a href="#__codelineno-0-1135">1135</a></span>
<span class="normal"><a href="#__codelineno-0-1136">1136</a></span>
<span class="normal"><a href="#__codelineno-0-1137">1137</a></span>
<span class="normal"><a href="#__codelineno-0-1138">1138</a></span>
<span class="normal"><a href="#__codelineno-0-1139">1139</a></span>
<span class="normal"><a href="#__codelineno-0-1140">1140</a></span>
<span class="normal"><a href="#__codelineno-0-1141">1141</a></span>
<span class="normal"><a href="#__codelineno-0-1142">1142</a></span>
<span class="normal"><a href="#__codelineno-0-1143">1143</a></span>
<span class="normal"><a href="#__codelineno-0-1144">1144</a></span>
<span class="normal"><a href="#__codelineno-0-1145">1145</a></span>
<span class="normal"><a href="#__codelineno-0-1146">1146</a></span>
<span class="normal"><a href="#__codelineno-0-1147">1147</a></span>
<span class="normal"><a href="#__codelineno-0-1148">1148</a></span>
<span class="normal"><a href="#__codelineno-0-1149">1149</a></span>
<span class="normal"><a href="#__codelineno-0-1150">1150</a></span>
<span class="normal"><a href="#__codelineno-0-1151">1151</a></span>
<span class="normal"><a href="#__codelineno-0-1152">1152</a></span>
<span class="normal"><a href="#__codelineno-0-1153">1153</a></span>
<span class="normal"><a href="#__codelineno-0-1154">1154</a></span>
<span class="normal"><a href="#__codelineno-0-1155">1155</a></span>
<span class="normal"><a href="#__codelineno-0-1156">1156</a></span>
<span class="normal"><a href="#__codelineno-0-1157">1157</a></span>
<span class="normal"><a href="#__codelineno-0-1158">1158</a></span>
<span class="normal"><a href="#__codelineno-0-1159">1159</a></span>
<span class="normal"><a href="#__codelineno-0-1160">1160</a></span>
<span class="normal"><a href="#__codelineno-0-1161">1161</a></span>
<span class="normal"><a href="#__codelineno-0-1162">1162</a></span>
<span class="normal"><a href="#__codelineno-0-1163">1163</a></span>
<span class="normal"><a href="#__codelineno-0-1164">1164</a></span>
<span class="normal"><a href="#__codelineno-0-1165">1165</a></span>
<span class="normal"><a href="#__codelineno-0-1166">1166</a></span>
<span class="normal"><a href="#__codelineno-0-1167">1167</a></span>
<span class="normal"><a href="#__codelineno-0-1168">1168</a></span>
<span class="normal"><a href="#__codelineno-0-1169">1169</a></span>
<span class="normal"><a href="#__codelineno-0-1170">1170</a></span>
<span class="normal"><a href="#__codelineno-0-1171">1171</a></span>
<span class="normal"><a href="#__codelineno-0-1172">1172</a></span>
<span class="normal"><a href="#__codelineno-0-1173">1173</a></span>
<span class="normal"><a href="#__codelineno-0-1174">1174</a></span>
<span class="normal"><a href="#__codelineno-0-1175">1175</a></span>
<span class="normal"><a href="#__codelineno-0-1176">1176</a></span>
<span class="normal"><a href="#__codelineno-0-1177">1177</a></span>
<span class="normal"><a href="#__codelineno-0-1178">1178</a></span>
<span class="normal"><a href="#__codelineno-0-1179">1179</a></span>
<span class="normal"><a href="#__codelineno-0-1180">1180</a></span>
<span class="normal"><a href="#__codelineno-0-1181">1181</a></span>
<span class="normal"><a href="#__codelineno-0-1182">1182</a></span>
<span class="normal"><a href="#__codelineno-0-1183">1183</a></span>
<span class="normal"><a href="#__codelineno-0-1184">1184</a></span>
<span class="normal"><a href="#__codelineno-0-1185">1185</a></span>
<span class="normal"><a href="#__codelineno-0-1186">1186</a></span>
<span class="normal"><a href="#__codelineno-0-1187">1187</a></span>
<span class="normal"><a href="#__codelineno-0-1188">1188</a></span>
<span class="normal"><a href="#__codelineno-0-1189">1189</a></span>
<span class="normal"><a href="#__codelineno-0-1190">1190</a></span>
<span class="normal"><a href="#__codelineno-0-1191">1191</a></span>
<span class="normal"><a href="#__codelineno-0-1192">1192</a></span>
<span class="normal"><a href="#__codelineno-0-1193">1193</a></span>
<span class="normal"><a href="#__codelineno-0-1194">1194</a></span>
<span class="normal"><a href="#__codelineno-0-1195">1195</a></span>
<span class="normal"><a href="#__codelineno-0-1196">1196</a></span>
<span class="normal"><a href="#__codelineno-0-1197">1197</a></span>
<span class="normal"><a href="#__codelineno-0-1198">1198</a></span>
<span class="normal"><a href="#__codelineno-0-1199">1199</a></span>
<span class="normal"><a href="#__codelineno-0-1200">1200</a></span>
<span class="normal"><a href="#__codelineno-0-1201">1201</a></span>
<span class="normal"><a href="#__codelineno-0-1202">1202</a></span>
<span class="normal"><a href="#__codelineno-0-1203">1203</a></span>
<span class="normal"><a href="#__codelineno-0-1204">1204</a></span>
<span class="normal"><a href="#__codelineno-0-1205">1205</a></span>
<span class="normal"><a href="#__codelineno-0-1206">1206</a></span>
<span class="normal"><a href="#__codelineno-0-1207">1207</a></span>
<span class="normal"><a href="#__codelineno-0-1208">1208</a></span>
<span class="normal"><a href="#__codelineno-0-1209">1209</a></span>
<span class="normal"><a href="#__codelineno-0-1210">1210</a></span>
<span class="normal"><a href="#__codelineno-0-1211">1211</a></span>
<span class="normal"><a href="#__codelineno-0-1212">1212</a></span>
<span class="normal"><a href="#__codelineno-0-1213">1213</a></span>
<span class="normal"><a href="#__codelineno-0-1214">1214</a></span>
<span class="normal"><a href="#__codelineno-0-1215">1215</a></span>
<span class="normal"><a href="#__codelineno-0-1216">1216</a></span>
<span class="normal"><a href="#__codelineno-0-1217">1217</a></span>
<span class="normal"><a href="#__codelineno-0-1218">1218</a></span>
<span class="normal"><a href="#__codelineno-0-1219">1219</a></span>
<span class="normal"><a href="#__codelineno-0-1220">1220</a></span>
<span class="normal"><a href="#__codelineno-0-1221">1221</a></span>
<span class="normal"><a href="#__codelineno-0-1222">1222</a></span>
<span class="normal"><a href="#__codelineno-0-1223">1223</a></span>
<span class="normal"><a href="#__codelineno-0-1224">1224</a></span>
<span class="normal"><a href="#__codelineno-0-1225">1225</a></span>
<span class="normal"><a href="#__codelineno-0-1226">1226</a></span>
<span class="normal"><a href="#__codelineno-0-1227">1227</a></span>
<span class="normal"><a href="#__codelineno-0-1228">1228</a></span>
<span class="normal"><a href="#__codelineno-0-1229">1229</a></span>
<span class="normal"><a href="#__codelineno-0-1230">1230</a></span>
<span class="normal"><a href="#__codelineno-0-1231">1231</a></span>
<span class="normal"><a href="#__codelineno-0-1232">1232</a></span>
<span class="normal"><a href="#__codelineno-0-1233">1233</a></span>
<span class="normal"><a href="#__codelineno-0-1234">1234</a></span>
<span class="normal"><a href="#__codelineno-0-1235">1235</a></span>
<span class="normal"><a href="#__codelineno-0-1236">1236</a></span>
<span class="normal"><a href="#__codelineno-0-1237">1237</a></span>
<span class="normal"><a href="#__codelineno-0-1238">1238</a></span>
<span class="normal"><a href="#__codelineno-0-1239">1239</a></span>
<span class="normal"><a href="#__codelineno-0-1240">1240</a></span>
<span class="normal"><a href="#__codelineno-0-1241">1241</a></span>
<span class="normal"><a href="#__codelineno-0-1242">1242</a></span>
<span class="normal"><a href="#__codelineno-0-1243">1243</a></span>
<span class="normal"><a href="#__codelineno-0-1244">1244</a></span>
<span class="normal"><a href="#__codelineno-0-1245">1245</a></span>
<span class="normal"><a href="#__codelineno-0-1246">1246</a></span>
<span class="normal"><a href="#__codelineno-0-1247">1247</a></span>
<span class="normal"><a href="#__codelineno-0-1248">1248</a></span>
<span class="normal"><a href="#__codelineno-0-1249">1249</a></span>
<span class="normal"><a href="#__codelineno-0-1250">1250</a></span>
<span class="normal"><a href="#__codelineno-0-1251">1251</a></span>
<span class="normal"><a href="#__codelineno-0-1252">1252</a></span>
<span class="normal"><a href="#__codelineno-0-1253">1253</a></span>
<span class="normal"><a href="#__codelineno-0-1254">1254</a></span>
<span class="normal"><a href="#__codelineno-0-1255">1255</a></span>
<span class="normal"><a href="#__codelineno-0-1256">1256</a></span>
<span class="normal"><a href="#__codelineno-0-1257">1257</a></span>
<span class="normal"><a href="#__codelineno-0-1258">1258</a></span>
<span class="normal"><a href="#__codelineno-0-1259">1259</a></span>
<span class="normal"><a href="#__codelineno-0-1260">1260</a></span>
<span class="normal"><a href="#__codelineno-0-1261">1261</a></span>
<span class="normal"><a href="#__codelineno-0-1262">1262</a></span>
<span class="normal"><a href="#__codelineno-0-1263">1263</a></span>
<span class="normal"><a href="#__codelineno-0-1264">1264</a></span>
<span class="normal"><a href="#__codelineno-0-1265">1265</a></span>
<span class="normal"><a href="#__codelineno-0-1266">1266</a></span>
<span class="normal"><a href="#__codelineno-0-1267">1267</a></span>
<span class="normal"><a href="#__codelineno-0-1268">1268</a></span>
<span class="normal"><a href="#__codelineno-0-1269">1269</a></span>
<span class="normal"><a href="#__codelineno-0-1270">1270</a></span>
<span class="normal"><a href="#__codelineno-0-1271">1271</a></span>
<span class="normal"><a href="#__codelineno-0-1272">1272</a></span>
<span class="normal"><a href="#__codelineno-0-1273">1273</a></span>
<span class="normal"><a href="#__codelineno-0-1274">1274</a></span>
<span class="normal"><a href="#__codelineno-0-1275">1275</a></span>
<span class="normal"><a href="#__codelineno-0-1276">1276</a></span>
<span class="normal"><a href="#__codelineno-0-1277">1277</a></span>
<span class="normal"><a href="#__codelineno-0-1278">1278</a></span>
<span class="normal"><a href="#__codelineno-0-1279">1279</a></span>
<span class="normal"><a href="#__codelineno-0-1280">1280</a></span>
<span class="normal"><a href="#__codelineno-0-1281">1281</a></span>
<span class="normal"><a href="#__codelineno-0-1282">1282</a></span>
<span class="normal"><a href="#__codelineno-0-1283">1283</a></span>
<span class="normal"><a href="#__codelineno-0-1284">1284</a></span>
<span class="normal"><a href="#__codelineno-0-1285">1285</a></span>
<span class="normal"><a href="#__codelineno-0-1286">1286</a></span>
<span class="normal"><a href="#__codelineno-0-1287">1287</a></span>
<span class="normal"><a href="#__codelineno-0-1288">1288</a></span>
<span class="normal"><a href="#__codelineno-0-1289">1289</a></span>
<span class="normal"><a href="#__codelineno-0-1290">1290</a></span>
<span class="normal"><a href="#__codelineno-0-1291">1291</a></span>
<span class="normal"><a href="#__codelineno-0-1292">1292</a></span>
<span class="normal"><a href="#__codelineno-0-1293">1293</a></span>
<span class="normal"><a href="#__codelineno-0-1294">1294</a></span>
<span class="normal"><a href="#__codelineno-0-1295">1295</a></span>
<span class="normal"><a href="#__codelineno-0-1296">1296</a></span>
<span class="normal"><a href="#__codelineno-0-1297">1297</a></span>
<span class="normal"><a href="#__codelineno-0-1298">1298</a></span>
<span class="normal"><a href="#__codelineno-0-1299">1299</a></span>
<span class="normal"><a href="#__codelineno-0-1300">1300</a></span>
<span class="normal"><a href="#__codelineno-0-1301">1301</a></span>
<span class="normal"><a href="#__codelineno-0-1302">1302</a></span>
<span class="normal"><a href="#__codelineno-0-1303">1303</a></span>
<span class="normal"><a href="#__codelineno-0-1304">1304</a></span>
<span class="normal"><a href="#__codelineno-0-1305">1305</a></span>
<span class="normal"><a href="#__codelineno-0-1306">1306</a></span>
<span class="normal"><a href="#__codelineno-0-1307">1307</a></span>
<span class="normal"><a href="#__codelineno-0-1308">1308</a></span>
<span class="normal"><a href="#__codelineno-0-1309">1309</a></span>
<span class="normal"><a href="#__codelineno-0-1310">1310</a></span>
<span class="normal"><a href="#__codelineno-0-1311">1311</a></span>
<span class="normal"><a href="#__codelineno-0-1312">1312</a></span>
<span class="normal"><a href="#__codelineno-0-1313">1313</a></span>
<span class="normal"><a href="#__codelineno-0-1314">1314</a></span>
<span class="normal"><a href="#__codelineno-0-1315">1315</a></span>
<span class="normal"><a href="#__codelineno-0-1316">1316</a></span>
<span class="normal"><a href="#__codelineno-0-1317">1317</a></span>
<span class="normal"><a href="#__codelineno-0-1318">1318</a></span>
<span class="normal"><a href="#__codelineno-0-1319">1319</a></span>
<span class="normal"><a href="#__codelineno-0-1320">1320</a></span>
<span class="normal"><a href="#__codelineno-0-1321">1321</a></span>
<span class="normal"><a href="#__codelineno-0-1322">1322</a></span>
<span class="normal"><a href="#__codelineno-0-1323">1323</a></span>
<span class="normal"><a href="#__codelineno-0-1324">1324</a></span>
<span class="normal"><a href="#__codelineno-0-1325">1325</a></span>
<span class="normal"><a href="#__codelineno-0-1326">1326</a></span>
<span class="normal"><a href="#__codelineno-0-1327">1327</a></span>
<span class="normal"><a href="#__codelineno-0-1328">1328</a></span>
<span class="normal"><a href="#__codelineno-0-1329">1329</a></span>
<span class="normal"><a href="#__codelineno-0-1330">1330</a></span>
<span class="normal"><a href="#__codelineno-0-1331">1331</a></span>
<span class="normal"><a href="#__codelineno-0-1332">1332</a></span>
<span class="normal"><a href="#__codelineno-0-1333">1333</a></span>
<span class="normal"><a href="#__codelineno-0-1334">1334</a></span>
<span class="normal"><a href="#__codelineno-0-1335">1335</a></span>
<span class="normal"><a href="#__codelineno-0-1336">1336</a></span>
<span class="normal"><a href="#__codelineno-0-1337">1337</a></span>
<span class="normal"><a href="#__codelineno-0-1338">1338</a></span>
<span class="normal"><a href="#__codelineno-0-1339">1339</a></span>
<span class="normal"><a href="#__codelineno-0-1340">1340</a></span>
<span class="normal"><a href="#__codelineno-0-1341">1341</a></span>
<span class="normal"><a href="#__codelineno-0-1342">1342</a></span>
<span class="normal"><a href="#__codelineno-0-1343">1343</a></span>
<span class="normal"><a href="#__codelineno-0-1344">1344</a></span>
<span class="normal"><a href="#__codelineno-0-1345">1345</a></span>
<span class="normal"><a href="#__codelineno-0-1346">1346</a></span>
<span class="normal"><a href="#__codelineno-0-1347">1347</a></span>
<span class="normal"><a href="#__codelineno-0-1348">1348</a></span>
<span class="normal"><a href="#__codelineno-0-1349">1349</a></span>
<span class="normal"><a href="#__codelineno-0-1350">1350</a></span>
<span class="normal"><a href="#__codelineno-0-1351">1351</a></span>
<span class="normal"><a href="#__codelineno-0-1352">1352</a></span>
<span class="normal"><a href="#__codelineno-0-1353">1353</a></span>
<span class="normal"><a href="#__codelineno-0-1354">1354</a></span>
<span class="normal"><a href="#__codelineno-0-1355">1355</a></span>
<span class="normal"><a href="#__codelineno-0-1356">1356</a></span>
<span class="normal"><a href="#__codelineno-0-1357">1357</a></span>
<span class="normal"><a href="#__codelineno-0-1358">1358</a></span>
<span class="normal"><a href="#__codelineno-0-1359">1359</a></span>
<span class="normal"><a href="#__codelineno-0-1360">1360</a></span>
<span class="normal"><a href="#__codelineno-0-1361">1361</a></span>
<span class="normal"><a href="#__codelineno-0-1362">1362</a></span>
<span class="normal"><a href="#__codelineno-0-1363">1363</a></span>
<span class="normal"><a href="#__codelineno-0-1364">1364</a></span>
<span class="normal"><a href="#__codelineno-0-1365">1365</a></span>
<span class="normal"><a href="#__codelineno-0-1366">1366</a></span>
<span class="normal"><a href="#__codelineno-0-1367">1367</a></span>
<span class="normal"><a href="#__codelineno-0-1368">1368</a></span>
<span class="normal"><a href="#__codelineno-0-1369">1369</a></span>
<span class="normal"><a href="#__codelineno-0-1370">1370</a></span>
<span class="normal"><a href="#__codelineno-0-1371">1371</a></span>
<span class="normal"><a href="#__codelineno-0-1372">1372</a></span>
<span class="normal"><a href="#__codelineno-0-1373">1373</a></span>
<span class="normal"><a href="#__codelineno-0-1374">1374</a></span>
<span class="normal"><a href="#__codelineno-0-1375">1375</a></span>
<span class="normal"><a href="#__codelineno-0-1376">1376</a></span>
<span class="normal"><a href="#__codelineno-0-1377">1377</a></span>
<span class="normal"><a href="#__codelineno-0-1378">1378</a></span>
<span class="normal"><a href="#__codelineno-0-1379">1379</a></span>
<span class="normal"><a href="#__codelineno-0-1380">1380</a></span>
<span class="normal"><a href="#__codelineno-0-1381">1381</a></span>
<span class="normal"><a href="#__codelineno-0-1382">1382</a></span>
<span class="normal"><a href="#__codelineno-0-1383">1383</a></span>
<span class="normal"><a href="#__codelineno-0-1384">1384</a></span>
<span class="normal"><a href="#__codelineno-0-1385">1385</a></span>
<span class="normal"><a href="#__codelineno-0-1386">1386</a></span>
<span class="normal"><a href="#__codelineno-0-1387">1387</a></span>
<span class="normal"><a href="#__codelineno-0-1388">1388</a></span>
<span class="normal"><a href="#__codelineno-0-1389">1389</a></span>
<span class="normal"><a href="#__codelineno-0-1390">1390</a></span>
<span class="normal"><a href="#__codelineno-0-1391">1391</a></span>
<span class="normal"><a href="#__codelineno-0-1392">1392</a></span>
<span class="normal"><a href="#__codelineno-0-1393">1393</a></span>
<span class="normal"><a href="#__codelineno-0-1394">1394</a></span>
<span class="normal"><a href="#__codelineno-0-1395">1395</a></span>
<span class="normal"><a href="#__codelineno-0-1396">1396</a></span>
<span class="normal"><a href="#__codelineno-0-1397">1397</a></span>
<span class="normal"><a href="#__codelineno-0-1398">1398</a></span>
<span class="normal"><a href="#__codelineno-0-1399">1399</a></span>
<span class="normal"><a href="#__codelineno-0-1400">1400</a></span>
<span class="normal"><a href="#__codelineno-0-1401">1401</a></span>
<span class="normal"><a href="#__codelineno-0-1402">1402</a></span>
<span class="normal"><a href="#__codelineno-0-1403">1403</a></span>
<span class="normal"><a href="#__codelineno-0-1404">1404</a></span>
<span class="normal"><a href="#__codelineno-0-1405">1405</a></span>
<span class="normal"><a href="#__codelineno-0-1406">1406</a></span>
<span class="normal"><a href="#__codelineno-0-1407">1407</a></span>
<span class="normal"><a href="#__codelineno-0-1408">1408</a></span>
<span class="normal"><a href="#__codelineno-0-1409">1409</a></span>
<span class="normal"><a href="#__codelineno-0-1410">1410</a></span>
<span class="normal"><a href="#__codelineno-0-1411">1411</a></span>
<span class="normal"><a href="#__codelineno-0-1412">1412</a></span>
<span class="normal"><a href="#__codelineno-0-1413">1413</a></span>
<span class="normal"><a href="#__codelineno-0-1414">1414</a></span>
<span class="normal"><a href="#__codelineno-0-1415">1415</a></span>
<span class="normal"><a href="#__codelineno-0-1416">1416</a></span>
<span class="normal"><a href="#__codelineno-0-1417">1417</a></span>
<span class="normal"><a href="#__codelineno-0-1418">1418</a></span>
<span class="normal"><a href="#__codelineno-0-1419">1419</a></span>
<span class="normal"><a href="#__codelineno-0-1420">1420</a></span>
<span class="normal"><a href="#__codelineno-0-1421">1421</a></span>
<span class="normal"><a href="#__codelineno-0-1422">1422</a></span>
<span class="normal"><a href="#__codelineno-0-1423">1423</a></span>
<span class="normal"><a href="#__codelineno-0-1424">1424</a></span>
<span class="normal"><a href="#__codelineno-0-1425">1425</a></span>
<span class="normal"><a href="#__codelineno-0-1426">1426</a></span>
<span class="normal"><a href="#__codelineno-0-1427">1427</a></span>
<span class="normal"><a href="#__codelineno-0-1428">1428</a></span>
<span class="normal"><a href="#__codelineno-0-1429">1429</a></span>
<span class="normal"><a href="#__codelineno-0-1430">1430</a></span>
<span class="normal"><a href="#__codelineno-0-1431">1431</a></span>
<span class="normal"><a href="#__codelineno-0-1432">1432</a></span>
<span class="normal"><a href="#__codelineno-0-1433">1433</a></span>
<span class="normal"><a href="#__codelineno-0-1434">1434</a></span>
<span class="normal"><a href="#__codelineno-0-1435">1435</a></span>
<span class="normal"><a href="#__codelineno-0-1436">1436</a></span>
<span class="normal"><a href="#__codelineno-0-1437">1437</a></span>
<span class="normal"><a href="#__codelineno-0-1438">1438</a></span>
<span class="normal"><a href="#__codelineno-0-1439">1439</a></span>
<span class="normal"><a href="#__codelineno-0-1440">1440</a></span>
<span class="normal"><a href="#__codelineno-0-1441">1441</a></span>
<span class="normal"><a href="#__codelineno-0-1442">1442</a></span>
<span class="normal"><a href="#__codelineno-0-1443">1443</a></span>
<span class="normal"><a href="#__codelineno-0-1444">1444</a></span>
<span class="normal"><a href="#__codelineno-0-1445">1445</a></span>
<span class="normal"><a href="#__codelineno-0-1446">1446</a></span>
<span class="normal"><a href="#__codelineno-0-1447">1447</a></span>
<span class="normal"><a href="#__codelineno-0-1448">1448</a></span>
<span class="normal"><a href="#__codelineno-0-1449">1449</a></span>
<span class="normal"><a href="#__codelineno-0-1450">1450</a></span>
<span class="normal"><a href="#__codelineno-0-1451">1451</a></span>
<span class="normal"><a href="#__codelineno-0-1452">1452</a></span>
<span class="normal"><a href="#__codelineno-0-1453">1453</a></span>
<span class="normal"><a href="#__codelineno-0-1454">1454</a></span>
<span class="normal"><a href="#__codelineno-0-1455">1455</a></span>
<span class="normal"><a href="#__codelineno-0-1456">1456</a></span>
<span class="normal"><a href="#__codelineno-0-1457">1457</a></span>
<span class="normal"><a href="#__codelineno-0-1458">1458</a></span>
<span class="normal"><a href="#__codelineno-0-1459">1459</a></span>
<span class="normal"><a href="#__codelineno-0-1460">1460</a></span>
<span class="normal"><a href="#__codelineno-0-1461">1461</a></span>
<span class="normal"><a href="#__codelineno-0-1462">1462</a></span>
<span class="normal"><a href="#__codelineno-0-1463">1463</a></span>
<span class="normal"><a href="#__codelineno-0-1464">1464</a></span>
<span class="normal"><a href="#__codelineno-0-1465">1465</a></span>
<span class="normal"><a href="#__codelineno-0-1466">1466</a></span>
<span class="normal"><a href="#__codelineno-0-1467">1467</a></span>
<span class="normal"><a href="#__codelineno-0-1468">1468</a></span>
<span class="normal"><a href="#__codelineno-0-1469">1469</a></span>
<span class="normal"><a href="#__codelineno-0-1470">1470</a></span>
<span class="normal"><a href="#__codelineno-0-1471">1471</a></span>
<span class="normal"><a href="#__codelineno-0-1472">1472</a></span>
<span class="normal"><a href="#__codelineno-0-1473">1473</a></span>
<span class="normal"><a href="#__codelineno-0-1474">1474</a></span>
<span class="normal"><a href="#__codelineno-0-1475">1475</a></span>
<span class="normal"><a href="#__codelineno-0-1476">1476</a></span>
<span class="normal"><a href="#__codelineno-0-1477">1477</a></span>
<span class="normal"><a href="#__codelineno-0-1478">1478</a></span>
<span class="normal"><a href="#__codelineno-0-1479">1479</a></span>
<span class="normal"><a href="#__codelineno-0-1480">1480</a></span>
<span class="normal"><a href="#__codelineno-0-1481">1481</a></span>
<span class="normal"><a href="#__codelineno-0-1482">1482</a></span>
<span class="normal"><a href="#__codelineno-0-1483">1483</a></span>
<span class="normal"><a href="#__codelineno-0-1484">1484</a></span>
<span class="normal"><a href="#__codelineno-0-1485">1485</a></span>
<span class="normal"><a href="#__codelineno-0-1486">1486</a></span>
<span class="normal"><a href="#__codelineno-0-1487">1487</a></span>
<span class="normal"><a href="#__codelineno-0-1488">1488</a></span>
<span class="normal"><a href="#__codelineno-0-1489">1489</a></span>
<span class="normal"><a href="#__codelineno-0-1490">1490</a></span>
<span class="normal"><a href="#__codelineno-0-1491">1491</a></span>
<span class="normal"><a href="#__codelineno-0-1492">1492</a></span>
<span class="normal"><a href="#__codelineno-0-1493">1493</a></span>
<span class="normal"><a href="#__codelineno-0-1494">1494</a></span>
<span class="normal"><a href="#__codelineno-0-1495">1495</a></span>
<span class="normal"><a href="#__codelineno-0-1496">1496</a></span>
<span class="normal"><a href="#__codelineno-0-1497">1497</a></span>
<span class="normal"><a href="#__codelineno-0-1498">1498</a></span>
<span class="normal"><a href="#__codelineno-0-1499">1499</a></span>
<span class="normal"><a href="#__codelineno-0-1500">1500</a></span>
<span class="normal"><a href="#__codelineno-0-1501">1501</a></span>
<span class="normal"><a href="#__codelineno-0-1502">1502</a></span>
<span class="normal"><a href="#__codelineno-0-1503">1503</a></span>
<span class="normal"><a href="#__codelineno-0-1504">1504</a></span>
<span class="normal"><a href="#__codelineno-0-1505">1505</a></span>
<span class="normal"><a href="#__codelineno-0-1506">1506</a></span>
<span class="normal"><a href="#__codelineno-0-1507">1507</a></span>
<span class="normal"><a href="#__codelineno-0-1508">1508</a></span>
<span class="normal"><a href="#__codelineno-0-1509">1509</a></span>
<span class="normal"><a href="#__codelineno-0-1510">1510</a></span>
<span class="normal"><a href="#__codelineno-0-1511">1511</a></span>
<span class="normal"><a href="#__codelineno-0-1512">1512</a></span>
<span class="normal"><a href="#__codelineno-0-1513">1513</a></span>
<span class="normal"><a href="#__codelineno-0-1514">1514</a></span>
<span class="normal"><a href="#__codelineno-0-1515">1515</a></span>
<span class="normal"><a href="#__codelineno-0-1516">1516</a></span>
<span class="normal"><a href="#__codelineno-0-1517">1517</a></span>
<span class="normal"><a href="#__codelineno-0-1518">1518</a></span>
<span class="normal"><a href="#__codelineno-0-1519">1519</a></span>
<span class="normal"><a href="#__codelineno-0-1520">1520</a></span>
<span class="normal"><a href="#__codelineno-0-1521">1521</a></span>
<span class="normal"><a href="#__codelineno-0-1522">1522</a></span>
<span class="normal"><a href="#__codelineno-0-1523">1523</a></span>
<span class="normal"><a href="#__codelineno-0-1524">1524</a></span>
<span class="normal"><a href="#__codelineno-0-1525">1525</a></span>
<span class="normal"><a href="#__codelineno-0-1526">1526</a></span>
<span class="normal"><a href="#__codelineno-0-1527">1527</a></span>
<span class="normal"><a href="#__codelineno-0-1528">1528</a></span>
<span class="normal"><a href="#__codelineno-0-1529">1529</a></span>
<span class="normal"><a href="#__codelineno-0-1530">1530</a></span>
<span class="normal"><a href="#__codelineno-0-1531">1531</a></span>
<span class="normal"><a href="#__codelineno-0-1532">1532</a></span>
<span class="normal"><a href="#__codelineno-0-1533">1533</a></span>
<span class="normal"><a href="#__codelineno-0-1534">1534</a></span>
<span class="normal"><a href="#__codelineno-0-1535">1535</a></span>
<span class="normal"><a href="#__codelineno-0-1536">1536</a></span>
<span class="normal"><a href="#__codelineno-0-1537">1537</a></span>
<span class="normal"><a href="#__codelineno-0-1538">1538</a></span>
<span class="normal"><a href="#__codelineno-0-1539">1539</a></span>
<span class="normal"><a href="#__codelineno-0-1540">1540</a></span>
<span class="normal"><a href="#__codelineno-0-1541">1541</a></span>
<span class="normal"><a href="#__codelineno-0-1542">1542</a></span>
<span class="normal"><a href="#__codelineno-0-1543">1543</a></span>
<span class="normal"><a href="#__codelineno-0-1544">1544</a></span>
<span class="normal"><a href="#__codelineno-0-1545">1545</a></span>
<span class="normal"><a href="#__codelineno-0-1546">1546</a></span>
<span class="normal"><a href="#__codelineno-0-1547">1547</a></span>
<span class="normal"><a href="#__codelineno-0-1548">1548</a></span>
<span class="normal"><a href="#__codelineno-0-1549">1549</a></span>
<span class="normal"><a href="#__codelineno-0-1550">1550</a></span>
<span class="normal"><a href="#__codelineno-0-1551">1551</a></span>
<span class="normal"><a href="#__codelineno-0-1552">1552</a></span>
<span class="normal"><a href="#__codelineno-0-1553">1553</a></span>
<span class="normal"><a href="#__codelineno-0-1554">1554</a></span>
<span class="normal"><a href="#__codelineno-0-1555">1555</a></span>
<span class="normal"><a href="#__codelineno-0-1556">1556</a></span>
<span class="normal"><a href="#__codelineno-0-1557">1557</a></span>
<span class="normal"><a href="#__codelineno-0-1558">1558</a></span>
<span class="normal"><a href="#__codelineno-0-1559">1559</a></span>
<span class="normal"><a href="#__codelineno-0-1560">1560</a></span>
<span class="normal"><a href="#__codelineno-0-1561">1561</a></span>
<span class="normal"><a href="#__codelineno-0-1562">1562</a></span>
<span class="normal"><a href="#__codelineno-0-1563">1563</a></span>
<span class="normal"><a href="#__codelineno-0-1564">1564</a></span>
<span class="normal"><a href="#__codelineno-0-1565">1565</a></span>
<span class="normal"><a href="#__codelineno-0-1566">1566</a></span>
<span class="normal"><a href="#__codelineno-0-1567">1567</a></span>
<span class="normal"><a href="#__codelineno-0-1568">1568</a></span>
<span class="normal"><a href="#__codelineno-0-1569">1569</a></span>
<span class="normal"><a href="#__codelineno-0-1570">1570</a></span>
<span class="normal"><a href="#__codelineno-0-1571">1571</a></span>
<span class="normal"><a href="#__codelineno-0-1572">1572</a></span>
<span class="normal"><a href="#__codelineno-0-1573">1573</a></span>
<span class="normal"><a href="#__codelineno-0-1574">1574</a></span>
<span class="normal"><a href="#__codelineno-0-1575">1575</a></span>
<span class="normal"><a href="#__codelineno-0-1576">1576</a></span>
<span class="normal"><a href="#__codelineno-0-1577">1577</a></span>
<span class="normal"><a href="#__codelineno-0-1578">1578</a></span>
<span class="normal"><a href="#__codelineno-0-1579">1579</a></span>
<span class="normal"><a href="#__codelineno-0-1580">1580</a></span>
<span class="normal"><a href="#__codelineno-0-1581">1581</a></span>
<span class="normal"><a href="#__codelineno-0-1582">1582</a></span>
<span class="normal"><a href="#__codelineno-0-1583">1583</a></span>
<span class="normal"><a href="#__codelineno-0-1584">1584</a></span>
<span class="normal"><a href="#__codelineno-0-1585">1585</a></span>
<span class="normal"><a href="#__codelineno-0-1586">1586</a></span>
<span class="normal"><a href="#__codelineno-0-1587">1587</a></span>
<span class="normal"><a href="#__codelineno-0-1588">1588</a></span>
<span class="normal"><a href="#__codelineno-0-1589">1589</a></span>
<span class="normal"><a href="#__codelineno-0-1590">1590</a></span>
<span class="normal"><a href="#__codelineno-0-1591">1591</a></span>
<span class="normal"><a href="#__codelineno-0-1592">1592</a></span>
<span class="normal"><a href="#__codelineno-0-1593">1593</a></span>
<span class="normal"><a href="#__codelineno-0-1594">1594</a></span>
<span class="normal"><a href="#__codelineno-0-1595">1595</a></span>
<span class="normal"><a href="#__codelineno-0-1596">1596</a></span>
<span class="normal"><a href="#__codelineno-0-1597">1597</a></span>
<span class="normal"><a href="#__codelineno-0-1598">1598</a></span>
<span class="normal"><a href="#__codelineno-0-1599">1599</a></span>
<span class="normal"><a href="#__codelineno-0-1600">1600</a></span>
<span class="normal"><a href="#__codelineno-0-1601">1601</a></span>
<span class="normal"><a href="#__codelineno-0-1602">1602</a></span>
<span class="normal"><a href="#__codelineno-0-1603">1603</a></span>
<span class="normal"><a href="#__codelineno-0-1604">1604</a></span>
<span class="normal"><a href="#__codelineno-0-1605">1605</a></span>
<span class="normal"><a href="#__codelineno-0-1606">1606</a></span>
<span class="normal"><a href="#__codelineno-0-1607">1607</a></span>
<span class="normal"><a href="#__codelineno-0-1608">1608</a></span>
<span class="normal"><a href="#__codelineno-0-1609">1609</a></span>
<span class="normal"><a href="#__codelineno-0-1610">1610</a></span>
<span class="normal"><a href="#__codelineno-0-1611">1611</a></span>
<span class="normal"><a href="#__codelineno-0-1612">1612</a></span>
<span class="normal"><a href="#__codelineno-0-1613">1613</a></span>
<span class="normal"><a href="#__codelineno-0-1614">1614</a></span>
<span class="normal"><a href="#__codelineno-0-1615">1615</a></span>
<span class="normal"><a href="#__codelineno-0-1616">1616</a></span>
<span class="normal"><a href="#__codelineno-0-1617">1617</a></span>
<span class="normal"><a href="#__codelineno-0-1618">1618</a></span>
<span class="normal"><a href="#__codelineno-0-1619">1619</a></span>
<span class="normal"><a href="#__codelineno-0-1620">1620</a></span>
<span class="normal"><a href="#__codelineno-0-1621">1621</a></span>
<span class="normal"><a href="#__codelineno-0-1622">1622</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="k">class</span><span class="w"> </span><span class="nc">AxiumDaemon</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    Main daemon class managing state and IPC.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    The daemon runs an asyncio event loop with a UNIX socket server</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">    accepting JSON IPC requests from the CLI.</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        state: Runtime state dict with keys:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">            Persistent (saved to state.json):</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">                - active_env: Current environment name (str | None)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">                - panes: Per-pane environment mapping (dict)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">            Runtime-only:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">                - started: ISO 8601 timestamp of daemon start (str)</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">                - tmux_pane: TMUX_PANE when daemon started (str | None)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">                - hud_cache: Pre-rendered HUD strings (dict)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        _start_time: Unix timestamp of daemon start (float, for uptime)</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        server: asyncio.Server instance for UNIX socket</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        _stop: asyncio.Event for graceful shutdown</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">        ```python</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">        daemon = AxiumDaemon()</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">        await daemon.run()</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">        ```</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">        Initialize daemon with default state.</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">        Loads persistent state from state.json if it exists, otherwise</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">        initializes with defaults. Creates empty event registry.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="c1"># Runtime-only state (not persisted)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="s2">&quot;active_env&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="s2">&quot;panes&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># Per-pane environment mapping: {&quot;%1&quot;: &quot;root&quot;, &quot;%2&quot;: &quot;builder&quot;}</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="s2">&quot;hud_cache&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># Pre-rendered HUD strings: {&quot;%1&quot;: &quot;[axium] pane:%1 ...&quot;}</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="s2">&quot;tmux_pane&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TMUX_PANE&quot;</span><span class="p">),</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="s2">&quot;started&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+00:00&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">),</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="p">}</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># Unix timestamp for fast uptime calculations</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="p">{}</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="p">)</span>  <span class="c1"># Effective permissions per spoke: {spoke_name: SpokePermissions}</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">notification_queue</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="p">[]</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="p">)</span>  <span class="c1"># Queued notifications: [{&quot;title&quot;: ..., &quot;body&quot;: ..., &quot;spoke&quot;: ...}]</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hud_config</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># HUD layout configuration from hud.yaml</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="c1"># Initialize EventBus for spoke coordination</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">axium.core.spokes</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_event_bus</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">get_event_bus</span><span class="p">()</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="c1"># Set up completion cache event listeners</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;spoke_loaded&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_spoke_loaded</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;spoke_reloaded&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_spoke_reloaded</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;spoke_unloaded&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_spoke_unloaded</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;gear_loaded&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_gear_loaded</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;gear_unloaded&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_gear_unloaded</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;daemon_reload&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_daemon_reload</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_load_state</span><span class="p">()</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_load_hud_config</span><span class="p">()</span>  <span class="c1"># Load HUD layout from hud.yaml</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_write_state_cache</span><span class="p">()</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_all_hud_caches</span><span class="p">()</span>  <span class="c1"># Pre-render HUD for all panes</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="c1"># Load gears for daemon IPC operations</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="c1"># Note: Gears are also loaded in CLI for command registration</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="c1"># This loads them in daemon context for IPC permission enforcement</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_load_gears_for_daemon</span><span class="p">()</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="c1"># Generate initial completion cache</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_regenerate_completions</span><span class="p">(</span><span class="s2">&quot;daemon_init&quot;</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_load_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">        Load persistent state from state.json.</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">        Reads active_env and panes mapping from disk if state.json exists.</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">        Other state (started, tmux_pane) is runtime-only and not loaded.</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">        Side Effects:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">            Updates self.state[&quot;active_env&quot;] and self.state[&quot;panes&quot;] if file exists and is valid.</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        Note:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">            Logs warning if state.json is malformed but continues with defaults.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="k">if</span> <span class="n">STATE_PATH</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">STATE_PATH</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;active_env&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;active_env&quot;</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;panes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;panes&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loaded state from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">STATE_PATH</span><span class="p">)</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to load state: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_load_hud_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">        Load HUD layout configuration from hud.yaml.</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">        Reads HUD layout and style configuration from ~/.config/axium/hud.yaml.</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">        Falls back to hardcoded defaults if file doesn&#39;t exist or is invalid.</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">        Side Effects:</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">            Updates self.hud_config with layout and style settings</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">        Note:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">            - layout: List of segment names to display (e.g., [&quot;env&quot;, &quot;uptime&quot;])</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">            - style: Dict with color and padding settings</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">            - Logs warning if hud.yaml is malformed but continues with defaults</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="n">hud_path</span> <span class="o">=</span> <span class="n">CONF_DIR</span> <span class="o">/</span> <span class="s2">&quot;hud.yaml&quot;</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="c1"># Default configuration</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="n">default_config</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="s2">&quot;layout&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;uptime&quot;</span><span class="p">],</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;#00B7C7&quot;</span><span class="p">,</span> <span class="s2">&quot;padding&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="p">}</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">hud_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">hud_config</span> <span class="o">=</span> <span class="n">default_config</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using default HUD config (hud.yaml not found)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="k">return</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">hud_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">hud_config</span> <span class="o">=</span> <span class="n">data</span> <span class="k">if</span> <span class="n">data</span> <span class="k">else</span> <span class="n">default_config</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loaded HUD config from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">hud_path</span><span class="p">)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to load hud.yaml: </span><span class="si">%s</span><span class="s2"> (using defaults)&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">hud_config</span> <span class="o">=</span> <span class="n">default_config</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_load_gears_for_daemon</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">        Load gears for daemon IPC operations.</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">        Loads gears to populate self.permissions dict for IPC permission enforcement.</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">        Gears are also loaded in CLI context for command registration.</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">        This is called during daemon initialization.</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">gears</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="n">discovered</span> <span class="o">=</span> <span class="n">gears</span><span class="o">.</span><span class="n">discover_gears</span><span class="p">()</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">discovered</span><span class="p">:</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No gears found&quot;</span><span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="k">return</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="c1"># Gears need app and events, but in daemon context we don&#39;t have the CLI app</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="c1"># We only need to load permissions for IPC operations</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="c1"># Commands are registered when gears load in CLI context</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="k">for</span> <span class="n">gear_name</span> <span class="ow">in</span> <span class="n">discovered</span><span class="p">:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                <span class="c1"># Load just the permissions without calling register()</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                <span class="n">gear_path</span> <span class="o">=</span> <span class="n">gears</span><span class="o">.</span><span class="n">GEARS_DIR</span> <span class="o">/</span> <span class="n">gear_name</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                <span class="n">gear_yaml</span> <span class="o">=</span> <span class="n">gear_path</span> <span class="o">/</span> <span class="s2">&quot;gear.yaml&quot;</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">gear_yaml</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Gear </span><span class="si">%s</span><span class="s2"> missing gear.yaml&quot;</span><span class="p">,</span> <span class="n">gear_name</span><span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                <span class="c1"># Load and store permissions</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>                <span class="n">effective_perms</span> <span class="o">=</span> <span class="n">gears</span><span class="o">.</span><span class="n">get_effective_gear_permissions</span><span class="p">(</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                    <span class="n">gear_name</span><span class="p">,</span> <span class="n">gear_yaml</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                <span class="p">)</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="p">[</span><span class="n">gear_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">effective_perms</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                    <span class="s2">&quot;Loaded gear permissions: </span><span class="si">%s</span><span class="s2"> (exec=</span><span class="si">%s</span><span class="s2"> ipc=</span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                    <span class="n">gear_name</span><span class="p">,</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                    <span class="n">effective_perms</span><span class="o">.</span><span class="n">exec</span><span class="p">,</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">effective_perms</span><span class="o">.</span><span class="n">ipc</span><span class="p">),</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                <span class="p">)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to load gear </span><span class="si">%s</span><span class="s2"> permissions: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">gear_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">        Persist state to state.json.</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">        Saves only persistent fields (active_env, panes) to disk.</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">        Runtime fields (started, tmux_pane) are not saved.</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">        Side Effects:</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">            Writes to ~/.config/axium/state.json</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">        Note:</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">            Creates parent directory if it doesn&#39;t exist.</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">            Logs error but doesn&#39;t raise if save fails.</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="n">CONF_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                <span class="s2">&quot;active_env&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;active_env&quot;</span><span class="p">],</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>                <span class="s2">&quot;panes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;panes&quot;</span><span class="p">,</span> <span class="p">{}),</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>            <span class="p">}</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>            <span class="n">STATE_PATH</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Saved state to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">STATE_PATH</span><span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to save state: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_write_state_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">        Write shell-optimized state cache to state_cache.json.</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">        Creates a JSON file with prefixed commands list for fast shell startup.</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">        This file is read by bash/init.sh to generate wrapper functions without</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">        requiring Python or daemon IPC during shell initialization.</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">        Cache Format:</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">            ```json</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">            {</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">                &quot;prefixed_commands&quot;: [&quot;aws&quot;, &quot;terraform&quot;, &quot;ansible&quot;]</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">            }</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="sd">            ```</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a><span class="sd">        Side Effects:</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="sd">            Writes to ~/.config/axium/state_cache.json</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">        Note:</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">            This should be called whenever prefix rules change:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">            - On daemon startup (__init__)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a><span class="sd">            - When prefix.yaml is modified (reload command)</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a><span class="sd">            - When Spokes are loaded/unloaded</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="sd">            Errors are logged but not raised to avoid breaking daemon startup.</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="n">CONF_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>            <span class="n">commands</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">get_prefixed_commands</span><span class="p">()</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="n">cache_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;prefixed_commands&quot;</span><span class="p">:</span> <span class="n">commands</span><span class="p">}</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>            <span class="n">STATE_CACHE_PATH</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">cache_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>                <span class="s2">&quot;Wrote state cache to </span><span class="si">%s</span><span class="s2"> with </span><span class="si">%d</span><span class="s2"> commands&quot;</span><span class="p">,</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>                <span class="n">STATE_CACHE_PATH</span><span class="p">,</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>                <span class="nb">len</span><span class="p">(</span><span class="n">commands</span><span class="p">),</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to write state cache: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_render_hud_for_pane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pane_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="sd">        Pre-render HUD string for a specific pane.</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a><span class="sd">        Runs in daemon process, generating the complete HUD string without</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a><span class="sd">        requiring CLI-side computation. This enables instant HUD responses.</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="sd">        Uses the new HudRegistry system for modular segment rendering.</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="sd">            pane_id: tmux pane ID (e.g., &quot;%1&quot;)</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><span class="sd">            Rendered HUD string like &quot;[axium] pane:%1  env:root  uptime:2h15m&quot;</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a><span class="sd">        Note:</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="sd">            This method is called by the daemon to pre-compute HUD strings.</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a><span class="sd">            Uses HudRegistry for consistent rendering with hud.main().</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="c1"># Import hud module to ensure segments are registered</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">axium.core.hud</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_registry</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>            <span class="c1"># Get pane environment</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>            <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;panes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pane_id</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>            <span class="c1"># Get wrapper and theme config from hud.yaml</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>            <span class="n">wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hud_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wrapper&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>            <span class="n">theme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hud_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;theme&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>            <span class="c1"># Build context for segment rendering (same as hud.main())</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>                <span class="s2">&quot;pane_id&quot;</span><span class="p">:</span> <span class="n">pane_id</span><span class="p">,</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>                <span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="n">env</span><span class="p">,</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>                <span class="s2">&quot;started&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;started&quot;</span><span class="p">),</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>                <span class="s2">&quot;wrapper&quot;</span><span class="p">:</span> <span class="n">wrapper</span><span class="p">,</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>                <span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="n">theme</span><span class="p">,</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>            <span class="p">}</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>            <span class="c1"># Render all segments via registry</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>            <span class="c1"># Don&#39;t call hud.main() as it does IPC calls which causes async issues</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>            <span class="n">registry</span> <span class="o">=</span> <span class="n">get_registry</span><span class="p">()</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>            <span class="n">segments</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">render_all</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>            <span class="k">return</span> <span class="s2">&quot;[axium] &quot;</span> <span class="o">+</span> <span class="s2">&quot;  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>                <span class="s2">&quot;Error rendering HUD for pane </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>                <span class="n">pane_id</span><span class="p">,</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>                <span class="n">e</span><span class="p">,</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>                <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>            <span class="p">)</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>            <span class="k">return</span> <span class="s2">&quot;[axium] inactive&quot;</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_update_hud_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pane_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a><span class="sd">        Update cached HUD string for a specific pane.</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a><span class="sd">        Re-renders the HUD and stores it in the cache for instant retrieval.</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a><span class="sd">            pane_id: tmux pane ID (e.g., &quot;%1&quot;)</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="sd">        Side Effects:</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a><span class="sd">            Updates self.state[&quot;hud_cache&quot;][pane_id]</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">        Note:</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">            Called automatically when pane environment changes or on reload.</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">            Errors are logged but don&#39;t raise to avoid disrupting daemon.</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;hud_cache&quot;</span><span class="p">][</span><span class="n">pane_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_hud_for_pane</span><span class="p">(</span><span class="n">pane_id</span><span class="p">)</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated HUD cache for pane </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pane_id</span><span class="p">)</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to render HUD for pane </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pane_id</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>            <span class="c1"># Don&#39;t add to cache if render fails - let caller handle fallback</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_refresh_all_hud_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="sd">        Refresh HUD cache for all known panes.</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a><span class="sd">        Iterates through all panes in state and re-renders their HUD strings.</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a><span class="sd">        Called on daemon startup and after reload operations.</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a><span class="sd">        Side Effects:</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a><span class="sd">            Updates self.state[&quot;hud_cache&quot;] for all panes</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a><span class="sd">        Note:</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a><span class="sd">            Safe to call even if panes dict is empty (no-op).</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="k">for</span> <span class="n">pane_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;panes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_update_hud_cache</span><span class="p">(</span><span class="n">pane_id</span><span class="p">)</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Refreshed HUD cache for </span><span class="si">%d</span><span class="s2"> panes&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;panes&quot;</span><span class="p">]))</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_regenerate_completions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a><span class="sd">        Regenerate completion cache after command structure changes.</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a><span class="sd">        Called by event handlers when spokes/gears are loaded, reloaded,</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a><span class="sd">        or unloaded, or when daemon config is reloaded.</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a><span class="sd">            event_name: Name of the event that triggered regeneration</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a><span class="sd">        Side Effects:</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a><span class="sd">            Writes to ~/.config/axium/completions.json</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a><span class="sd">        Note:</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a><span class="sd">            Errors are logged but not raised to avoid disrupting</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a><span class="sd">            the main event flow.</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">axium.core.completions</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_completion_cache</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>            <span class="n">success</span> <span class="o">=</span> <span class="n">generate_completion_cache</span><span class="p">()</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Regenerated completions after </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">event_name</span><span class="p">)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to regenerate completions after </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">event_name</span><span class="p">)</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error regenerating completions after </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_on_spoke_loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Event handler: spoke_loaded.&quot;&quot;&quot;</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_regenerate_completions</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spoke_loaded:</span><span class="si">{</span><span class="n">spoke_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>        <span class="c1"># Refresh HUD caches since spoke may have registered new segments</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_all_hud_caches</span><span class="p">()</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_on_spoke_reloaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Event handler: spoke_reloaded.&quot;&quot;&quot;</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_regenerate_completions</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spoke_reloaded:</span><span class="si">{</span><span class="n">spoke_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>        <span class="c1"># Refresh HUD caches since spoke may have updated segments</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_all_hud_caches</span><span class="p">()</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_on_spoke_unloaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Event handler: spoke_unloaded.&quot;&quot;&quot;</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_regenerate_completions</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spoke_unloaded:</span><span class="si">{</span><span class="n">spoke_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>        <span class="c1"># Refresh HUD caches since spoke segments are removed</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_all_hud_caches</span><span class="p">()</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_on_gear_loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gear_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Event handler: gear_loaded.&quot;&quot;&quot;</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_regenerate_completions</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;gear_loaded:</span><span class="si">{</span><span class="n">gear_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>        <span class="c1"># Refresh HUD caches since gear may have registered new segments</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_all_hud_caches</span><span class="p">()</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_on_gear_unloaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gear_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Event handler: gear_unloaded.&quot;&quot;&quot;</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_regenerate_completions</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;gear_unloaded:</span><span class="si">{</span><span class="n">gear_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>        <span class="c1"># Refresh HUD caches since gear segments are removed</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_all_hud_caches</span><span class="p">()</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_on_daemon_reload</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Event handler: daemon_reload.&quot;&quot;&quot;</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_regenerate_completions</span><span class="p">(</span><span class="s2">&quot;daemon_reload&quot;</span><span class="p">)</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_set_pane_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a><span class="sd">        Handle set_pane_env IPC command.</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a><span class="sd">        Sets environment for specific tmux pane and emits env_change event.</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a><span class="sd">            msg: IPC message with &#39;pane&#39; and &#39;value&#39; fields</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a><span class="sd">            Response dict with &#39;ok&#39; status</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>        <span class="n">pane_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pane&quot;</span><span class="p">)</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>        <span class="n">new_env</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">)</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pane_id</span><span class="p">:</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;pane ID required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>        <span class="c1"># Validate environment name before setting</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">env</span> <span class="k">as</span> <span class="n">env_module</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>        <span class="n">is_valid</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">env_module</span><span class="o">.</span><span class="n">validate_env_name</span><span class="p">(</span><span class="n">new_env</span><span class="p">)</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">}</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>        <span class="n">old_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;panes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pane_id</span><span class="p">)</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;panes&quot;</span><span class="p">][</span><span class="n">pane_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_env</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_save_state</span><span class="p">()</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>        <span class="c1"># Invalidate all config caches (env-aware configs need refresh)</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>        <span class="n">config</span><span class="o">.</span><span class="n">invalidate_cache</span><span class="p">()</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Invalidated all config caches due to pane env change&quot;</span><span class="p">)</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>        <span class="c1"># Update HUD cache for this pane</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_update_hud_cache</span><span class="p">(</span><span class="n">pane_id</span><span class="p">)</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pane </span><span class="si">%s</span><span class="s2"> environment set to: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pane_id</span><span class="p">,</span> <span class="n">new_env</span><span class="p">)</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>        <span class="c1"># Emit env_change event with pane context</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">spokes</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>        <span class="n">spokes</span><span class="o">.</span><span class="n">get_event_bus</span><span class="p">()</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;env_change&quot;</span><span class="p">,</span> <span class="n">new_env</span><span class="p">,</span> <span class="n">old_env</span><span class="p">,</span> <span class="n">pane</span><span class="o">=</span><span class="n">pane_id</span><span class="p">)</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_get_pane_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a><span class="sd">        Handle get_pane_env IPC command.</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a><span class="sd">        Gets environment for specific tmux pane.</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a><span class="sd">            msg: IPC message with &#39;pane&#39; field</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a><span class="sd">            Response dict with &#39;ok&#39; status and &#39;env&#39; value</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>        <span class="n">pane_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pane&quot;</span><span class="p">)</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pane_id</span><span class="p">:</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;pane ID required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>        <span class="n">env_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;panes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pane_id</span><span class="p">)</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="n">env_name</span><span class="p">}</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_clear_pane_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a><span class="sd">        Handle clear_pane_env IPC command.</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a><span class="sd">        Clears environment mapping for specific pane and emits env_change event.</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a><span class="sd">            msg: IPC message with &#39;pane&#39; field</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a><span class="sd">            Response dict with &#39;ok&#39; status</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>        <span class="n">pane_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pane&quot;</span><span class="p">)</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pane_id</span><span class="p">:</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;pane ID required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>        <span class="n">old_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;panes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pane_id</span><span class="p">)</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>        <span class="k">if</span> <span class="n">pane_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;panes&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;panes&quot;</span><span class="p">][</span><span class="n">pane_id</span><span class="p">]</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_save_state</span><span class="p">()</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleared pane </span><span class="si">%s</span><span class="s2"> environment&quot;</span><span class="p">,</span> <span class="n">pane_id</span><span class="p">)</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>            <span class="c1"># Emit post-action event</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;env_change&quot;</span><span class="p">,</span> <span class="n">new_env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">old_env</span><span class="o">=</span><span class="n">old_env</span><span class="p">,</span> <span class="n">pane</span><span class="o">=</span><span class="n">pane_id</span><span class="p">)</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a><span class="sd">        Handle notify IPC command.</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a><span class="sd">        Checks notify permission for spoke, then queues notification.</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a><span class="sd">            msg: IPC message with &#39;spoke&#39;, &#39;title&#39;, &#39;body&#39;, &#39;level&#39; fields</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a><span class="sd">            Response dict with &#39;ok&#39; status</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">permissions</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>        <span class="n">spoke_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spoke&quot;</span><span class="p">)</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>        <span class="n">title</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>        <span class="n">body</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>        <span class="n">level</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_name</span><span class="p">:</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke name required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>        <span class="c1"># Check permission</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>        <span class="n">spoke_perms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spoke_name</span><span class="p">)</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_perms</span><span class="p">:</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>            <span class="n">permissions</span><span class="o">.</span><span class="n">log_security</span><span class="p">(</span><span class="n">spoke_name</span><span class="p">,</span> <span class="s2">&quot;notify&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke not loaded&quot;</span><span class="p">}</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>        <span class="n">allowed</span> <span class="o">=</span> <span class="n">permissions</span><span class="o">.</span><span class="n">check_permission</span><span class="p">(</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>            <span class="n">spoke_name</span><span class="p">,</span> <span class="s2">&quot;notify&quot;</span><span class="p">,</span> <span class="n">spoke_perms</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">title</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>        <span class="p">)</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;permission denied: notify&quot;</span><span class="p">}</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>        <span class="c1"># Queue notification</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>        <span class="n">notification</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>            <span class="s2">&quot;spoke&quot;</span><span class="p">:</span> <span class="n">spoke_name</span><span class="p">,</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">body</span><span class="p">,</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>            <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="n">level</span><span class="p">,</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+00:00&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">),</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>        <span class="p">}</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">notification_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>            <span class="s2">&quot;Notification queued: spoke=</span><span class="si">%s</span><span class="s2"> title=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>            <span class="n">spoke_name</span><span class="p">,</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>            <span class="n">title</span><span class="p">[:</span><span class="mi">50</span><span class="p">],</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>        <span class="p">)</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_daemon_exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a><span class="sd">        Handle daemon_exec IPC command.</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a><span class="sd">        Checks exec permission for spoke, then runs command in background subprocess.</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a><span class="sd">            msg: IPC message with &#39;spoke&#39;, &#39;command&#39;, &#39;mode&#39; fields</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><span class="sd">            Response dict with &#39;ok&#39; status and &#39;pid&#39; (if successful)</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">permissions</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>        <span class="n">spoke_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spoke&quot;</span><span class="p">)</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>        <span class="n">cmd</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>        <span class="n">mode</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="s2">&quot;background&quot;</span><span class="p">)</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_name</span><span class="p">:</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke name required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;command required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>        <span class="c1"># Phase 1: only background mode supported</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>        <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;background&quot;</span><span class="p">:</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>                <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;unsupported mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> (only &#39;background&#39; supported)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>            <span class="p">}</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>        <span class="c1"># Check permission</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>        <span class="n">spoke_perms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spoke_name</span><span class="p">)</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_perms</span><span class="p">:</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>            <span class="n">permissions</span><span class="o">.</span><span class="n">log_security</span><span class="p">(</span><span class="n">spoke_name</span><span class="p">,</span> <span class="s2">&quot;daemon_exec&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke not loaded&quot;</span><span class="p">}</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>        <span class="n">allowed</span> <span class="o">=</span> <span class="n">permissions</span><span class="o">.</span><span class="n">check_permission</span><span class="p">(</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>            <span class="n">spoke_name</span><span class="p">,</span> <span class="s2">&quot;exec&quot;</span><span class="p">,</span> <span class="n">spoke_perms</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">cmd</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>        <span class="p">)</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;permission denied: exec&quot;</span><span class="p">}</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>        <span class="c1"># Run command in background (no TTY, non-interactive)</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>            <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>                <span class="n">cmd</span><span class="p">,</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>                <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>                <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>                <span class="n">start_new_session</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Detach from daemon</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>            <span class="p">)</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>                <span class="s2">&quot;Background command started: spoke=</span><span class="si">%s</span><span class="s2"> pid=</span><span class="si">%d</span><span class="s2"> cmd=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>                <span class="n">spoke_name</span><span class="p">,</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>                <span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>                <span class="n">cmd</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>            <span class="p">)</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">}</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>                <span class="s2">&quot;Failed to execute command: spoke=</span><span class="si">%s</span><span class="s2"> cmd=&#39;</span><span class="si">%s</span><span class="s2">&#39; error=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>                <span class="n">spoke_name</span><span class="p">,</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>                <span class="n">cmd</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>                <span class="n">e</span><span class="p">,</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>            <span class="p">)</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_notify_drain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a><span class="sd">        Handle notify_drain IPC command.</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a><span class="sd">        Returns and clears the notification queue.</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a><span class="sd">            msg: IPC message (no parameters needed)</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a><span class="sd">            Response dict with &#39;ok&#39; status and &#39;notifications&#39; list</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a>        <span class="n">notifications</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">notification_queue</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">notification_queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Drained </span><span class="si">%d</span><span class="s2"> notifications&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">notifications</span><span class="p">))</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;notifications&quot;</span><span class="p">:</span> <span class="n">notifications</span><span class="p">}</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_get_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a><span class="sd">        Handle get_permissions IPC command.</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a><span class="sd">        Returns effective permissions for a spoke.</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a><span class="sd">            msg: IPC message with &#39;spoke&#39; field</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a><span class="sd">            Response dict with &#39;ok&#39; status and &#39;permissions&#39; dict</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a>        <span class="n">spoke_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spoke&quot;</span><span class="p">)</span>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_name</span><span class="p">:</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke name required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>        <span class="n">spoke_perms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spoke_name</span><span class="p">)</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_perms</span><span class="p">:</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke not loaded&quot;</span><span class="p">}</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>        <span class="c1"># Convert to dict with source info</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>        <span class="n">perms_dict</span> <span class="o">=</span> <span class="n">spoke_perms</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>        <span class="n">sources</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="n">spoke_perms</span><span class="o">.</span><span class="n">get_source</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">perms_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>            <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>            <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="n">perms_dict</span><span class="p">,</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>            <span class="s2">&quot;sources&quot;</span><span class="p">:</span> <span class="n">sources</span><span class="p">,</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a>        <span class="p">}</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_load_spoke_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a><span class="sd">        Handle load_spoke_permissions IPC command.</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a><span class="sd">        Loads permissions for a spoke from its spoke.yaml and merges with user overrides.</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a><span class="sd">            msg: IPC message with &#39;spoke&#39;, &#39;spoke_yaml_path&#39; fields</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a><span class="sd">            Response dict with &#39;ok&#39; status</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">permissions</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>        <span class="n">spoke_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spoke&quot;</span><span class="p">)</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>        <span class="n">spoke_yaml_path_str</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spoke_yaml_path&quot;</span><span class="p">)</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_name</span><span class="p">:</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke name required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_yaml_path_str</span><span class="p">:</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke_yaml_path required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a>            <span class="n">spoke_yaml_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">spoke_yaml_path_str</span><span class="p">)</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a>            <span class="n">effective_perms</span> <span class="o">=</span> <span class="n">permissions</span><span class="o">.</span><span class="n">get_effective_permissions</span><span class="p">(</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a>                <span class="n">spoke_name</span><span class="p">,</span> <span class="n">spoke_yaml_path</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a>            <span class="p">)</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="p">[</span><span class="n">spoke_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">effective_perms</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>                <span class="s2">&quot;Loaded permissions: spoke=</span><span class="si">%s</span><span class="s2"> exec=</span><span class="si">%s</span><span class="s2"> notify=</span><span class="si">%s</span><span class="s2"> fs_read=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>                <span class="n">spoke_name</span><span class="p">,</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>                <span class="n">effective_perms</span><span class="o">.</span><span class="n">exec</span><span class="p">,</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a>                <span class="n">effective_perms</span><span class="o">.</span><span class="n">notify</span><span class="p">,</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>                <span class="nb">len</span><span class="p">(</span><span class="n">effective_perms</span><span class="o">.</span><span class="n">fs_read</span><span class="p">),</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>            <span class="p">)</span>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to load permissions for spoke </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a><span class="sd">        Handle get_config IPC command.</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a><span class="sd">        Loads config for a spoke and optionally returns a specific value by key path.</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a><span class="sd">        Uses the centralized config system with caching.</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a><span class="sd">            msg: IPC message with:</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a><span class="sd">                - &#39;spoke&#39;: Spoke name (required)</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a><span class="sd">                - &#39;key&#39;: Optional dot-notation key path (e.g., &quot;check.path&quot;)</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a><span class="sd">                - &#39;default_filename&#39;: Optional config filename (defaults to &lt;spoke&gt;.yaml)</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a><span class="sd">            Response dict with:</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a><span class="sd">                - &#39;ok&#39;: True if successful</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a><span class="sd">                - &#39;config&#39;: Full config dict OR specific value if key provided</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a><span class="sd">                - &#39;source&#39;: &#39;cache&#39; or &#39;loaded&#39;</span>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a><span class="sd">                - &#39;error&#39;: Error message if failed</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a><span class="sd">        Example:</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a><span class="sd">            &gt;&gt;&gt; # Full config</span>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a><span class="sd">            &gt;&gt;&gt; _handle_get_config({&quot;cmd&quot;: &quot;get_config&quot;, &quot;spoke&quot;: &quot;creds&quot;})</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a><span class="sd">            {&quot;ok&quot;: True, &quot;config&quot;: {...}, &quot;source&quot;: &quot;cache&quot;}</span>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a><span class="sd">            &gt;&gt;&gt; # Specific key</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a><span class="sd">            &gt;&gt;&gt; _handle_get_config({&quot;cmd&quot;: &quot;get_config&quot;, &quot;spoke&quot;: &quot;creds&quot;, &quot;key&quot;: &quot;check.path&quot;})</span>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a><span class="sd">            {&quot;ok&quot;: True, &quot;config&quot;: &quot;~/.aws/credentials&quot;, &quot;source&quot;: &quot;cache&quot;}</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a>        <span class="n">spoke_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spoke&quot;</span><span class="p">)</span>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a>        <span class="n">key_path</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a>        <span class="n">default_filename</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_filename&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spoke_name</span><span class="si">}</span><span class="s2">.yaml&quot;</span><span class="p">)</span>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_name</span><span class="p">:</span>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke name required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>            <span class="c1"># Check if config is cached</span>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>            <span class="n">cache_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">_config_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">spoke_name</span><span class="p">]</span>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a>            <span class="n">was_cached</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a>            <span class="c1"># Load config (will use cache if available)</span>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a>            <span class="n">spoke_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">load_spoke_config</span><span class="p">(</span>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a>                <span class="n">spoke_name</span><span class="p">,</span> <span class="n">default_filename</span><span class="p">,</span> <span class="n">env_aware</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a>            <span class="p">)</span>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-845" name="__codelineno-0-845"></a>                <span class="s2">&quot;Config request: spoke=</span><span class="si">%s</span><span class="s2"> key=</span><span class="si">%s</span><span class="s2"> cached=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-846" name="__codelineno-0-846"></a>                <span class="n">spoke_name</span><span class="p">,</span>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a>                <span class="n">key_path</span> <span class="ow">or</span> <span class="s2">&quot;(full)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a>                <span class="n">was_cached</span><span class="p">,</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a>            <span class="p">)</span>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a>            <span class="c1"># If key path provided, extract specific value</span>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a>            <span class="k">if</span> <span class="n">key_path</span><span class="p">:</span>
<a id="__codelineno-0-853" name="__codelineno-0-853"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_config_value_by_path</span><span class="p">(</span>
<a id="__codelineno-0-854" name="__codelineno-0-854"></a>                    <span class="n">spoke_config</span><span class="p">,</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
<a id="__codelineno-0-855" name="__codelineno-0-855"></a>                <span class="p">)</span>
<a id="__codelineno-0-856" name="__codelineno-0-856"></a>
<a id="__codelineno-0-857" name="__codelineno-0-857"></a>                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-858" name="__codelineno-0-858"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a>                        <span class="s2">&quot;Config key not found: spoke=</span><span class="si">%s</span><span class="s2"> key=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">,</span> <span class="n">key_path</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a>                    <span class="p">)</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a>                    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a>                        <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a>                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;key &#39;</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">&#39; not found in config&quot;</span><span class="p">,</span>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a>                    <span class="p">}</span>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a>                <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a>                    <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a>                    <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a>                    <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;cache&quot;</span> <span class="k">if</span> <span class="n">was_cached</span> <span class="k">else</span> <span class="s2">&quot;loaded&quot;</span><span class="p">,</span>
<a id="__codelineno-0-870" name="__codelineno-0-870"></a>                <span class="p">}</span>
<a id="__codelineno-0-871" name="__codelineno-0-871"></a>
<a id="__codelineno-0-872" name="__codelineno-0-872"></a>            <span class="c1"># Return full config</span>
<a id="__codelineno-0-873" name="__codelineno-0-873"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-874" name="__codelineno-0-874"></a>                <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-875" name="__codelineno-0-875"></a>                <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">spoke_config</span><span class="p">,</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a>                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;cache&quot;</span> <span class="k">if</span> <span class="n">was_cached</span> <span class="k">else</span> <span class="s2">&quot;loaded&quot;</span><span class="p">,</span>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a>            <span class="p">}</span>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a>        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-880" name="__codelineno-0-880"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Config file not found: spoke=</span><span class="si">%s</span><span class="s2"> error=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-881" name="__codelineno-0-881"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;config file not found: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<a id="__codelineno-0-882" name="__codelineno-0-882"></a>
<a id="__codelineno-0-883" name="__codelineno-0-883"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-884" name="__codelineno-0-884"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to load config for spoke </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-885" name="__codelineno-0-885"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;config error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<a id="__codelineno-0-886" name="__codelineno-0-886"></a>
<a id="__codelineno-0-887" name="__codelineno-0-887"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_tmux_split_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-888" name="__codelineno-0-888"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-889" name="__codelineno-0-889"></a><span class="sd">        Handle tmux_split_run IPC command.</span>
<a id="__codelineno-0-890" name="__codelineno-0-890"></a>
<a id="__codelineno-0-891" name="__codelineno-0-891"></a><span class="sd">        Creates a tmux split pane and runs a command inside it.</span>
<a id="__codelineno-0-892" name="__codelineno-0-892"></a><span class="sd">        Requires &#39;tmux_split_run&#39; in spoke/gear&#39;s IPC permissions.</span>
<a id="__codelineno-0-893" name="__codelineno-0-893"></a>
<a id="__codelineno-0-894" name="__codelineno-0-894"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-895" name="__codelineno-0-895"></a><span class="sd">            msg: IPC message with &#39;spoke&#39;, &#39;command&#39;, &#39;height&#39; fields</span>
<a id="__codelineno-0-896" name="__codelineno-0-896"></a>
<a id="__codelineno-0-897" name="__codelineno-0-897"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-898" name="__codelineno-0-898"></a><span class="sd">            Response dict with &#39;ok&#39; status and &#39;pane_id&#39; if successful</span>
<a id="__codelineno-0-899" name="__codelineno-0-899"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-900" name="__codelineno-0-900"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<a id="__codelineno-0-901" name="__codelineno-0-901"></a>
<a id="__codelineno-0-902" name="__codelineno-0-902"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">permissions</span>
<a id="__codelineno-0-903" name="__codelineno-0-903"></a>
<a id="__codelineno-0-904" name="__codelineno-0-904"></a>        <span class="n">spoke_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spoke&quot;</span><span class="p">)</span>
<a id="__codelineno-0-905" name="__codelineno-0-905"></a>        <span class="n">command</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-906" name="__codelineno-0-906"></a>        <span class="n">height</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-0-907" name="__codelineno-0-907"></a>
<a id="__codelineno-0-908" name="__codelineno-0-908"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">command</span><span class="p">:</span>
<a id="__codelineno-0-909" name="__codelineno-0-909"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke and command required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-910" name="__codelineno-0-910"></a>
<a id="__codelineno-0-911" name="__codelineno-0-911"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">height</span> <span class="o">&lt;=</span> <span class="mi">99</span><span class="p">):</span>
<a id="__codelineno-0-912" name="__codelineno-0-912"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;height must be 1-99&quot;</span><span class="p">}</span>
<a id="__codelineno-0-913" name="__codelineno-0-913"></a>
<a id="__codelineno-0-914" name="__codelineno-0-914"></a>        <span class="c1"># Permission check</span>
<a id="__codelineno-0-915" name="__codelineno-0-915"></a>        <span class="n">spoke_perms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spoke_name</span><span class="p">)</span>
<a id="__codelineno-0-916" name="__codelineno-0-916"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_perms</span><span class="p">:</span>
<a id="__codelineno-0-917" name="__codelineno-0-917"></a>            <span class="n">permissions</span><span class="o">.</span><span class="n">log_security</span><span class="p">(</span>
<a id="__codelineno-0-918" name="__codelineno-0-918"></a>                <span class="n">spoke_name</span><span class="p">,</span> <span class="s2">&quot;ipc:tmux_split_run&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="kc">False</span>
<a id="__codelineno-0-919" name="__codelineno-0-919"></a>            <span class="p">)</span>
<a id="__codelineno-0-920" name="__codelineno-0-920"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke not loaded&quot;</span><span class="p">}</span>
<a id="__codelineno-0-921" name="__codelineno-0-921"></a>
<a id="__codelineno-0-922" name="__codelineno-0-922"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">permissions</span><span class="o">.</span><span class="n">check_ipc_permission</span><span class="p">(</span>
<a id="__codelineno-0-923" name="__codelineno-0-923"></a>            <span class="n">spoke_name</span><span class="p">,</span> <span class="s2">&quot;tmux_split_run&quot;</span><span class="p">,</span> <span class="n">spoke_perms</span><span class="p">,</span> <span class="n">command</span>
<a id="__codelineno-0-924" name="__codelineno-0-924"></a>        <span class="p">):</span>
<a id="__codelineno-0-925" name="__codelineno-0-925"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;permission denied: tmux_split_run&quot;</span><span class="p">}</span>
<a id="__codelineno-0-926" name="__codelineno-0-926"></a>
<a id="__codelineno-0-927" name="__codelineno-0-927"></a>        <span class="c1"># Execute tmux split</span>
<a id="__codelineno-0-928" name="__codelineno-0-928"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-929" name="__codelineno-0-929"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
<a id="__codelineno-0-930" name="__codelineno-0-930"></a>                <span class="p">[</span>
<a id="__codelineno-0-931" name="__codelineno-0-931"></a>                    <span class="s2">&quot;tmux&quot;</span><span class="p">,</span>
<a id="__codelineno-0-932" name="__codelineno-0-932"></a>                    <span class="s2">&quot;split-window&quot;</span><span class="p">,</span>
<a id="__codelineno-0-933" name="__codelineno-0-933"></a>                    <span class="s2">&quot;-v&quot;</span><span class="p">,</span>
<a id="__codelineno-0-934" name="__codelineno-0-934"></a>                    <span class="s2">&quot;-l&quot;</span><span class="p">,</span>
<a id="__codelineno-0-935" name="__codelineno-0-935"></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
<a id="__codelineno-0-936" name="__codelineno-0-936"></a>                    <span class="s2">&quot;-P&quot;</span><span class="p">,</span>
<a id="__codelineno-0-937" name="__codelineno-0-937"></a>                    <span class="s2">&quot;-F&quot;</span><span class="p">,</span>
<a id="__codelineno-0-938" name="__codelineno-0-938"></a>                    <span class="s2">&quot;#</span><span class="si">{pane_id}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-939" name="__codelineno-0-939"></a>                    <span class="n">command</span><span class="p">,</span>
<a id="__codelineno-0-940" name="__codelineno-0-940"></a>                <span class="p">],</span>
<a id="__codelineno-0-941" name="__codelineno-0-941"></a>                <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-942" name="__codelineno-0-942"></a>                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-943" name="__codelineno-0-943"></a>                <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-0-944" name="__codelineno-0-944"></a>                <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-945" name="__codelineno-0-945"></a>            <span class="p">)</span>
<a id="__codelineno-0-946" name="__codelineno-0-946"></a>            <span class="n">pane_id</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-947" name="__codelineno-0-947"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-948" name="__codelineno-0-948"></a>                <span class="s2">&quot;Tmux split created: spoke=</span><span class="si">%s</span><span class="s2"> pane=</span><span class="si">%s</span><span class="s2"> cmd=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-949" name="__codelineno-0-949"></a>                <span class="n">spoke_name</span><span class="p">,</span>
<a id="__codelineno-0-950" name="__codelineno-0-950"></a>                <span class="n">pane_id</span><span class="p">,</span>
<a id="__codelineno-0-951" name="__codelineno-0-951"></a>                <span class="n">command</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span>
<a id="__codelineno-0-952" name="__codelineno-0-952"></a>            <span class="p">)</span>
<a id="__codelineno-0-953" name="__codelineno-0-953"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;pane_id&quot;</span><span class="p">:</span> <span class="n">pane_id</span><span class="p">}</span>
<a id="__codelineno-0-954" name="__codelineno-0-954"></a>
<a id="__codelineno-0-955" name="__codelineno-0-955"></a>        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
<a id="__codelineno-0-956" name="__codelineno-0-956"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Tmux split timeout: spoke=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">)</span>
<a id="__codelineno-0-957" name="__codelineno-0-957"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;tmux command timeout&quot;</span><span class="p">}</span>
<a id="__codelineno-0-958" name="__codelineno-0-958"></a>        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-959" name="__codelineno-0-959"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-960" name="__codelineno-0-960"></a>                <span class="s2">&quot;Tmux split failed: spoke=</span><span class="si">%s</span><span class="s2"> stderr=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">stderr</span>
<a id="__codelineno-0-961" name="__codelineno-0-961"></a>            <span class="p">)</span>
<a id="__codelineno-0-962" name="__codelineno-0-962"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;tmux error: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<a id="__codelineno-0-963" name="__codelineno-0-963"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-964" name="__codelineno-0-964"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Tmux split exception: spoke=</span><span class="si">%s</span><span class="s2"> error=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-965" name="__codelineno-0-965"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-0-966" name="__codelineno-0-966"></a>
<a id="__codelineno-0-967" name="__codelineno-0-967"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_tmux_send_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-968" name="__codelineno-0-968"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle tmux_send_keys IPC command.&quot;&quot;&quot;</span>
<a id="__codelineno-0-969" name="__codelineno-0-969"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<a id="__codelineno-0-970" name="__codelineno-0-970"></a>
<a id="__codelineno-0-971" name="__codelineno-0-971"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">permissions</span>
<a id="__codelineno-0-972" name="__codelineno-0-972"></a>
<a id="__codelineno-0-973" name="__codelineno-0-973"></a>        <span class="n">spoke_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spoke&quot;</span><span class="p">)</span>
<a id="__codelineno-0-974" name="__codelineno-0-974"></a>        <span class="n">pane_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pane_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-975" name="__codelineno-0-975"></a>        <span class="n">keys</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-976" name="__codelineno-0-976"></a>
<a id="__codelineno-0-977" name="__codelineno-0-977"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">spoke_name</span><span class="p">,</span> <span class="n">pane_id</span><span class="p">,</span> <span class="n">keys</span><span class="p">]):</span>
<a id="__codelineno-0-978" name="__codelineno-0-978"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke, pane_id, and keys required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-979" name="__codelineno-0-979"></a>
<a id="__codelineno-0-980" name="__codelineno-0-980"></a>        <span class="c1"># Permission check</span>
<a id="__codelineno-0-981" name="__codelineno-0-981"></a>        <span class="n">spoke_perms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spoke_name</span><span class="p">)</span>
<a id="__codelineno-0-982" name="__codelineno-0-982"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_perms</span><span class="p">:</span>
<a id="__codelineno-0-983" name="__codelineno-0-983"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke not loaded&quot;</span><span class="p">}</span>
<a id="__codelineno-0-984" name="__codelineno-0-984"></a>
<a id="__codelineno-0-985" name="__codelineno-0-985"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">permissions</span><span class="o">.</span><span class="n">check_ipc_permission</span><span class="p">(</span>
<a id="__codelineno-0-986" name="__codelineno-0-986"></a>            <span class="n">spoke_name</span><span class="p">,</span> <span class="s2">&quot;tmux_send_keys&quot;</span><span class="p">,</span> <span class="n">spoke_perms</span>
<a id="__codelineno-0-987" name="__codelineno-0-987"></a>        <span class="p">):</span>
<a id="__codelineno-0-988" name="__codelineno-0-988"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;permission denied: tmux_send_keys&quot;</span><span class="p">}</span>
<a id="__codelineno-0-989" name="__codelineno-0-989"></a>
<a id="__codelineno-0-990" name="__codelineno-0-990"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-991" name="__codelineno-0-991"></a>            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
<a id="__codelineno-0-992" name="__codelineno-0-992"></a>                <span class="p">[</span><span class="s2">&quot;tmux&quot;</span><span class="p">,</span> <span class="s2">&quot;send-keys&quot;</span><span class="p">,</span> <span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="n">pane_id</span><span class="p">,</span> <span class="n">keys</span><span class="p">],</span>
<a id="__codelineno-0-993" name="__codelineno-0-993"></a>                <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-994" name="__codelineno-0-994"></a>                <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-0-995" name="__codelineno-0-995"></a>            <span class="p">)</span>
<a id="__codelineno-0-996" name="__codelineno-0-996"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sent keys to pane: spoke=</span><span class="si">%s</span><span class="s2"> pane=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">,</span> <span class="n">pane_id</span><span class="p">)</span>
<a id="__codelineno-0-997" name="__codelineno-0-997"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-998" name="__codelineno-0-998"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-999" name="__codelineno-0-999"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;tmux_send_keys failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1000" name="__codelineno-0-1000"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-0-1001" name="__codelineno-0-1001"></a>
<a id="__codelineno-0-1002" name="__codelineno-0-1002"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_tmux_capture_pane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-1003" name="__codelineno-0-1003"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle tmux_capture_pane IPC command.&quot;&quot;&quot;</span>
<a id="__codelineno-0-1004" name="__codelineno-0-1004"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<a id="__codelineno-0-1005" name="__codelineno-0-1005"></a>
<a id="__codelineno-0-1006" name="__codelineno-0-1006"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">permissions</span>
<a id="__codelineno-0-1007" name="__codelineno-0-1007"></a>
<a id="__codelineno-0-1008" name="__codelineno-0-1008"></a>        <span class="n">spoke_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spoke&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1009" name="__codelineno-0-1009"></a>        <span class="n">pane_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pane_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1010" name="__codelineno-0-1010"></a>
<a id="__codelineno-0-1011" name="__codelineno-0-1011"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">pane_id</span><span class="p">:</span>
<a id="__codelineno-0-1012" name="__codelineno-0-1012"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke and pane_id required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1013" name="__codelineno-0-1013"></a>
<a id="__codelineno-0-1014" name="__codelineno-0-1014"></a>        <span class="c1"># Permission check</span>
<a id="__codelineno-0-1015" name="__codelineno-0-1015"></a>        <span class="n">spoke_perms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spoke_name</span><span class="p">)</span>
<a id="__codelineno-0-1016" name="__codelineno-0-1016"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_perms</span><span class="p">:</span>
<a id="__codelineno-0-1017" name="__codelineno-0-1017"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke not loaded&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1018" name="__codelineno-0-1018"></a>
<a id="__codelineno-0-1019" name="__codelineno-0-1019"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">permissions</span><span class="o">.</span><span class="n">check_ipc_permission</span><span class="p">(</span>
<a id="__codelineno-0-1020" name="__codelineno-0-1020"></a>            <span class="n">spoke_name</span><span class="p">,</span> <span class="s2">&quot;tmux_capture_pane&quot;</span><span class="p">,</span> <span class="n">spoke_perms</span>
<a id="__codelineno-0-1021" name="__codelineno-0-1021"></a>        <span class="p">):</span>
<a id="__codelineno-0-1022" name="__codelineno-0-1022"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;permission denied: tmux_capture_pane&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1023" name="__codelineno-0-1023"></a>
<a id="__codelineno-0-1024" name="__codelineno-0-1024"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1025" name="__codelineno-0-1025"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
<a id="__codelineno-0-1026" name="__codelineno-0-1026"></a>                <span class="p">[</span><span class="s2">&quot;tmux&quot;</span><span class="p">,</span> <span class="s2">&quot;capture-pane&quot;</span><span class="p">,</span> <span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="n">pane_id</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1027" name="__codelineno-0-1027"></a>                <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1028" name="__codelineno-0-1028"></a>                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1029" name="__codelineno-0-1029"></a>                <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1030" name="__codelineno-0-1030"></a>                <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-0-1031" name="__codelineno-0-1031"></a>            <span class="p">)</span>
<a id="__codelineno-0-1032" name="__codelineno-0-1032"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-1033" name="__codelineno-0-1033"></a>                <span class="s2">&quot;Captured pane: spoke=</span><span class="si">%s</span><span class="s2"> pane=</span><span class="si">%s</span><span class="s2"> size=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1034" name="__codelineno-0-1034"></a>                <span class="n">spoke_name</span><span class="p">,</span>
<a id="__codelineno-0-1035" name="__codelineno-0-1035"></a>                <span class="n">pane_id</span><span class="p">,</span>
<a id="__codelineno-0-1036" name="__codelineno-0-1036"></a>                <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">),</span>
<a id="__codelineno-0-1037" name="__codelineno-0-1037"></a>            <span class="p">)</span>
<a id="__codelineno-0-1038" name="__codelineno-0-1038"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">}</span>
<a id="__codelineno-0-1039" name="__codelineno-0-1039"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1040" name="__codelineno-0-1040"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;tmux_capture_pane failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1041" name="__codelineno-0-1041"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-0-1042" name="__codelineno-0-1042"></a>
<a id="__codelineno-0-1043" name="__codelineno-0-1043"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_read_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-1044" name="__codelineno-0-1044"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1045" name="__codelineno-0-1045"></a><span class="sd">        Handle read_file IPC command.</span>
<a id="__codelineno-0-1046" name="__codelineno-0-1046"></a>
<a id="__codelineno-0-1047" name="__codelineno-0-1047"></a><span class="sd">        Reads file with permission checking against fs_read patterns.</span>
<a id="__codelineno-0-1048" name="__codelineno-0-1048"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1049" name="__codelineno-0-1049"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<a id="__codelineno-0-1050" name="__codelineno-0-1050"></a>
<a id="__codelineno-0-1051" name="__codelineno-0-1051"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">permissions</span>
<a id="__codelineno-0-1052" name="__codelineno-0-1052"></a>
<a id="__codelineno-0-1053" name="__codelineno-0-1053"></a>        <span class="n">spoke_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spoke&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1054" name="__codelineno-0-1054"></a>        <span class="n">path_str</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1055" name="__codelineno-0-1055"></a>
<a id="__codelineno-0-1056" name="__codelineno-0-1056"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">path_str</span><span class="p">:</span>
<a id="__codelineno-0-1057" name="__codelineno-0-1057"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke and path required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1058" name="__codelineno-0-1058"></a>
<a id="__codelineno-0-1059" name="__codelineno-0-1059"></a>        <span class="c1"># Permission check</span>
<a id="__codelineno-0-1060" name="__codelineno-0-1060"></a>        <span class="n">spoke_perms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spoke_name</span><span class="p">)</span>
<a id="__codelineno-0-1061" name="__codelineno-0-1061"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_perms</span><span class="p">:</span>
<a id="__codelineno-0-1062" name="__codelineno-0-1062"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke not loaded&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1063" name="__codelineno-0-1063"></a>
<a id="__codelineno-0-1064" name="__codelineno-0-1064"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">permissions</span><span class="o">.</span><span class="n">check_permission</span><span class="p">(</span>
<a id="__codelineno-0-1065" name="__codelineno-0-1065"></a>            <span class="n">spoke_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;fs_read:</span><span class="si">{</span><span class="n">path_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spoke_perms</span>
<a id="__codelineno-0-1066" name="__codelineno-0-1066"></a>        <span class="p">):</span>
<a id="__codelineno-0-1067" name="__codelineno-0-1067"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;permission denied: fs_read&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1068" name="__codelineno-0-1068"></a>
<a id="__codelineno-0-1069" name="__codelineno-0-1069"></a>        <span class="c1"># Read file</span>
<a id="__codelineno-0-1070" name="__codelineno-0-1070"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1071" name="__codelineno-0-1071"></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path_str</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
<a id="__codelineno-0-1072" name="__codelineno-0-1072"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-1073" name="__codelineno-0-1073"></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;file not found&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1074" name="__codelineno-0-1074"></a>
<a id="__codelineno-0-1075" name="__codelineno-0-1075"></a>            <span class="c1"># Size check (max 10MB)</span>
<a id="__codelineno-0-1076" name="__codelineno-0-1076"></a>            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
<a id="__codelineno-0-1077" name="__codelineno-0-1077"></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;file too large (max 10MB)&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1078" name="__codelineno-0-1078"></a>
<a id="__codelineno-0-1079" name="__codelineno-0-1079"></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
<a id="__codelineno-0-1080" name="__codelineno-0-1080"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-1081" name="__codelineno-0-1081"></a>                <span class="s2">&quot;File read: spoke=</span><span class="si">%s</span><span class="s2"> path=</span><span class="si">%s</span><span class="s2"> size=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<a id="__codelineno-0-1082" name="__codelineno-0-1082"></a>            <span class="p">)</span>
<a id="__codelineno-0-1083" name="__codelineno-0-1083"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
<a id="__codelineno-0-1084" name="__codelineno-0-1084"></a>
<a id="__codelineno-0-1085" name="__codelineno-0-1085"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1086" name="__codelineno-0-1086"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-1087" name="__codelineno-0-1087"></a>                <span class="s2">&quot;File read failed: spoke=</span><span class="si">%s</span><span class="s2"> path=</span><span class="si">%s</span><span class="s2"> error=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">,</span> <span class="n">path_str</span><span class="p">,</span> <span class="n">e</span>
<a id="__codelineno-0-1088" name="__codelineno-0-1088"></a>            <span class="p">)</span>
<a id="__codelineno-0-1089" name="__codelineno-0-1089"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-0-1090" name="__codelineno-0-1090"></a>
<a id="__codelineno-0-1091" name="__codelineno-0-1091"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_write_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-1092" name="__codelineno-0-1092"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1093" name="__codelineno-0-1093"></a><span class="sd">        Handle write_file IPC command.</span>
<a id="__codelineno-0-1094" name="__codelineno-0-1094"></a>
<a id="__codelineno-0-1095" name="__codelineno-0-1095"></a><span class="sd">        Writes file with permission checking against fs_write patterns.</span>
<a id="__codelineno-0-1096" name="__codelineno-0-1096"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1097" name="__codelineno-0-1097"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<a id="__codelineno-0-1098" name="__codelineno-0-1098"></a>
<a id="__codelineno-0-1099" name="__codelineno-0-1099"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">permissions</span>
<a id="__codelineno-0-1100" name="__codelineno-0-1100"></a>
<a id="__codelineno-0-1101" name="__codelineno-0-1101"></a>        <span class="n">spoke_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spoke&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1102" name="__codelineno-0-1102"></a>        <span class="n">path_str</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1103" name="__codelineno-0-1103"></a>        <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1104" name="__codelineno-0-1104"></a>
<a id="__codelineno-0-1105" name="__codelineno-0-1105"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">path_str</span><span class="p">:</span>
<a id="__codelineno-0-1106" name="__codelineno-0-1106"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke and path required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1107" name="__codelineno-0-1107"></a>
<a id="__codelineno-0-1108" name="__codelineno-0-1108"></a>        <span class="c1"># Permission check</span>
<a id="__codelineno-0-1109" name="__codelineno-0-1109"></a>        <span class="n">spoke_perms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spoke_name</span><span class="p">)</span>
<a id="__codelineno-0-1110" name="__codelineno-0-1110"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_perms</span><span class="p">:</span>
<a id="__codelineno-0-1111" name="__codelineno-0-1111"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke not loaded&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1112" name="__codelineno-0-1112"></a>
<a id="__codelineno-0-1113" name="__codelineno-0-1113"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">permissions</span><span class="o">.</span><span class="n">check_permission</span><span class="p">(</span>
<a id="__codelineno-0-1114" name="__codelineno-0-1114"></a>            <span class="n">spoke_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;fs_write:</span><span class="si">{</span><span class="n">path_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spoke_perms</span>
<a id="__codelineno-0-1115" name="__codelineno-0-1115"></a>        <span class="p">):</span>
<a id="__codelineno-0-1116" name="__codelineno-0-1116"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;permission denied: fs_write&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1117" name="__codelineno-0-1117"></a>
<a id="__codelineno-0-1118" name="__codelineno-0-1118"></a>        <span class="c1"># Write file</span>
<a id="__codelineno-0-1119" name="__codelineno-0-1119"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1120" name="__codelineno-0-1120"></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path_str</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
<a id="__codelineno-0-1121" name="__codelineno-0-1121"></a>            <span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1122" name="__codelineno-0-1122"></a>            <span class="n">path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<a id="__codelineno-0-1123" name="__codelineno-0-1123"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-1124" name="__codelineno-0-1124"></a>                <span class="s2">&quot;File written: spoke=</span><span class="si">%s</span><span class="s2"> path=</span><span class="si">%s</span><span class="s2"> size=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<a id="__codelineno-0-1125" name="__codelineno-0-1125"></a>            <span class="p">)</span>
<a id="__codelineno-0-1126" name="__codelineno-0-1126"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-1127" name="__codelineno-0-1127"></a>
<a id="__codelineno-0-1128" name="__codelineno-0-1128"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1129" name="__codelineno-0-1129"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-1130" name="__codelineno-0-1130"></a>                <span class="s2">&quot;File write failed: spoke=</span><span class="si">%s</span><span class="s2"> path=</span><span class="si">%s</span><span class="s2"> error=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">,</span> <span class="n">path_str</span><span class="p">,</span> <span class="n">e</span>
<a id="__codelineno-0-1131" name="__codelineno-0-1131"></a>            <span class="p">)</span>
<a id="__codelineno-0-1132" name="__codelineno-0-1132"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-0-1133" name="__codelineno-0-1133"></a>
<a id="__codelineno-0-1134" name="__codelineno-0-1134"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_write_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-1135" name="__codelineno-0-1135"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle write_log IPC command.&quot;&quot;&quot;</span>
<a id="__codelineno-0-1136" name="__codelineno-0-1136"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<a id="__codelineno-0-1137" name="__codelineno-0-1137"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<a id="__codelineno-0-1138" name="__codelineno-0-1138"></a>
<a id="__codelineno-0-1139" name="__codelineno-0-1139"></a>        <span class="n">spoke_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spoke&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1140" name="__codelineno-0-1140"></a>        <span class="n">message</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1141" name="__codelineno-0-1141"></a>        <span class="n">level</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<a id="__codelineno-0-1142" name="__codelineno-0-1142"></a>
<a id="__codelineno-0-1143" name="__codelineno-0-1143"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
<a id="__codelineno-0-1144" name="__codelineno-0-1144"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke and message required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1145" name="__codelineno-0-1145"></a>
<a id="__codelineno-0-1146" name="__codelineno-0-1146"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1147" name="__codelineno-0-1147"></a>            <span class="n">log_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.config&quot;</span> <span class="o">/</span> <span class="s2">&quot;axium&quot;</span> <span class="o">/</span> <span class="s2">&quot;logs&quot;</span>
<a id="__codelineno-0-1148" name="__codelineno-0-1148"></a>            <span class="n">log_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1149" name="__codelineno-0-1149"></a>
<a id="__codelineno-0-1150" name="__codelineno-0-1150"></a>            <span class="n">log_file</span> <span class="o">=</span> <span class="n">log_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spoke_name</span><span class="si">}</span><span class="s2">.log&quot;</span>
<a id="__codelineno-0-1151" name="__codelineno-0-1151"></a>            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S UTC&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1152" name="__codelineno-0-1152"></a>            <span class="n">log_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">] [</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-1153" name="__codelineno-0-1153"></a>
<a id="__codelineno-0-1154" name="__codelineno-0-1154"></a>            <span class="k">with</span> <span class="n">log_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-1155" name="__codelineno-0-1155"></a>                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_line</span><span class="p">)</span>
<a id="__codelineno-0-1156" name="__codelineno-0-1156"></a>
<a id="__codelineno-0-1157" name="__codelineno-0-1157"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Log written: spoke=</span><span class="si">%s</span><span class="s2"> level=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
<a id="__codelineno-0-1158" name="__codelineno-0-1158"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-1159" name="__codelineno-0-1159"></a>
<a id="__codelineno-0-1160" name="__codelineno-0-1160"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1161" name="__codelineno-0-1161"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;write_log failed: spoke=</span><span class="si">%s</span><span class="s2"> error=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1162" name="__codelineno-0-1162"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-0-1163" name="__codelineno-0-1163"></a>
<a id="__codelineno-0-1164" name="__codelineno-0-1164"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_register_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-1165" name="__codelineno-0-1165"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1166" name="__codelineno-0-1166"></a><span class="sd">        Handle register_prefix IPC command.</span>
<a id="__codelineno-0-1167" name="__codelineno-0-1167"></a>
<a id="__codelineno-0-1168" name="__codelineno-0-1168"></a><span class="sd">        Registers prefix rule with conflict detection.</span>
<a id="__codelineno-0-1169" name="__codelineno-0-1169"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1170" name="__codelineno-0-1170"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">prefix</span>
<a id="__codelineno-0-1171" name="__codelineno-0-1171"></a>
<a id="__codelineno-0-1172" name="__codelineno-0-1172"></a>        <span class="n">spoke_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spoke&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1173" name="__codelineno-0-1173"></a>        <span class="n">command</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1174" name="__codelineno-0-1174"></a>        <span class="n">wrapper</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wrapper&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1175" name="__codelineno-0-1175"></a>
<a id="__codelineno-0-1176" name="__codelineno-0-1176"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">spoke_name</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">]):</span>
<a id="__codelineno-0-1177" name="__codelineno-0-1177"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke, command, and wrapper required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1178" name="__codelineno-0-1178"></a>
<a id="__codelineno-0-1179" name="__codelineno-0-1179"></a>        <span class="c1"># Check for existing owner</span>
<a id="__codelineno-0-1180" name="__codelineno-0-1180"></a>        <span class="n">existing_owner</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">get_rule_owner</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<a id="__codelineno-0-1181" name="__codelineno-0-1181"></a>        <span class="k">if</span> <span class="n">existing_owner</span> <span class="ow">and</span> <span class="n">existing_owner</span> <span class="o">!=</span> <span class="n">spoke_name</span><span class="p">:</span>
<a id="__codelineno-0-1182" name="__codelineno-0-1182"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-1183" name="__codelineno-0-1183"></a>                <span class="s2">&quot;Prefix conflict: </span><span class="si">%s</span><span class="s2"> tried to register &#39;</span><span class="si">%s</span><span class="s2">&#39; but owned by </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1184" name="__codelineno-0-1184"></a>                <span class="n">spoke_name</span><span class="p">,</span>
<a id="__codelineno-0-1185" name="__codelineno-0-1185"></a>                <span class="n">command</span><span class="p">,</span>
<a id="__codelineno-0-1186" name="__codelineno-0-1186"></a>                <span class="n">existing_owner</span><span class="p">,</span>
<a id="__codelineno-0-1187" name="__codelineno-0-1187"></a>            <span class="p">)</span>
<a id="__codelineno-0-1188" name="__codelineno-0-1188"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-1189" name="__codelineno-0-1189"></a>                <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1190" name="__codelineno-0-1190"></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;command already registered by </span><span class="si">{</span><span class="n">existing_owner</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1191" name="__codelineno-0-1191"></a>                <span class="s2">&quot;conflict&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1192" name="__codelineno-0-1192"></a>            <span class="p">}</span>
<a id="__codelineno-0-1193" name="__codelineno-0-1193"></a>
<a id="__codelineno-0-1194" name="__codelineno-0-1194"></a>        <span class="c1"># Register</span>
<a id="__codelineno-0-1195" name="__codelineno-0-1195"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1196" name="__codelineno-0-1196"></a>            <span class="n">success</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">register_prefix_rule</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">)</span>
<a id="__codelineno-0-1197" name="__codelineno-0-1197"></a>            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
<a id="__codelineno-0-1198" name="__codelineno-0-1198"></a>                <span class="c1"># Regenerate state cache</span>
<a id="__codelineno-0-1199" name="__codelineno-0-1199"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_write_state_cache</span><span class="p">()</span>
<a id="__codelineno-0-1200" name="__codelineno-0-1200"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-1201" name="__codelineno-0-1201"></a>                    <span class="s2">&quot;Prefix registered: spoke=</span><span class="si">%s</span><span class="s2"> command=</span><span class="si">%s</span><span class="s2"> wrapper=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1202" name="__codelineno-0-1202"></a>                    <span class="n">spoke_name</span><span class="p">,</span>
<a id="__codelineno-0-1203" name="__codelineno-0-1203"></a>                    <span class="n">command</span><span class="p">,</span>
<a id="__codelineno-0-1204" name="__codelineno-0-1204"></a>                    <span class="n">wrapper</span><span class="p">,</span>
<a id="__codelineno-0-1205" name="__codelineno-0-1205"></a>                <span class="p">)</span>
<a id="__codelineno-0-1206" name="__codelineno-0-1206"></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-1207" name="__codelineno-0-1207"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1208" name="__codelineno-0-1208"></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;registration failed&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1209" name="__codelineno-0-1209"></a>
<a id="__codelineno-0-1210" name="__codelineno-0-1210"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1211" name="__codelineno-0-1211"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Prefix registration failed: spoke=</span><span class="si">%s</span><span class="s2"> error=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1212" name="__codelineno-0-1212"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-0-1213" name="__codelineno-0-1213"></a>
<a id="__codelineno-0-1214" name="__codelineno-0-1214"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_get_hud_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-1215" name="__codelineno-0-1215"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1216" name="__codelineno-0-1216"></a><span class="sd">        Handle get_hud_segments IPC command.</span>
<a id="__codelineno-0-1217" name="__codelineno-0-1217"></a>
<a id="__codelineno-0-1218" name="__codelineno-0-1218"></a><span class="sd">        Returns list of all registered HUD segments with their metadata.</span>
<a id="__codelineno-0-1219" name="__codelineno-0-1219"></a>
<a id="__codelineno-0-1220" name="__codelineno-0-1220"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-1221" name="__codelineno-0-1221"></a><span class="sd">            {&quot;ok&quot;: True, &quot;segments&quot;: [{&quot;name&quot;: &quot;...&quot;, &quot;priority&quot;: 10, &quot;spoke&quot;: &quot;...&quot;}]}</span>
<a id="__codelineno-0-1222" name="__codelineno-0-1222"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1223" name="__codelineno-0-1223"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1224" name="__codelineno-0-1224"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">.hud</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_registry</span>
<a id="__codelineno-0-1225" name="__codelineno-0-1225"></a>
<a id="__codelineno-0-1226" name="__codelineno-0-1226"></a>            <span class="n">registry</span> <span class="o">=</span> <span class="n">get_registry</span><span class="p">()</span>
<a id="__codelineno-0-1227" name="__codelineno-0-1227"></a>            <span class="n">segments</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1228" name="__codelineno-0-1228"></a>
<a id="__codelineno-0-1229" name="__codelineno-0-1229"></a>            <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">registry</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
<a id="__codelineno-0-1230" name="__codelineno-0-1230"></a>                <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-1231" name="__codelineno-0-1231"></a>                    <span class="p">{</span>
<a id="__codelineno-0-1232" name="__codelineno-0-1232"></a>                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">segment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-1233" name="__codelineno-0-1233"></a>                        <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="n">segment</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span>
<a id="__codelineno-0-1234" name="__codelineno-0-1234"></a>                        <span class="s2">&quot;spoke&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="s2">&quot;spoke&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;core&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1235" name="__codelineno-0-1235"></a>                    <span class="p">}</span>
<a id="__codelineno-0-1236" name="__codelineno-0-1236"></a>                <span class="p">)</span>
<a id="__codelineno-0-1237" name="__codelineno-0-1237"></a>
<a id="__codelineno-0-1238" name="__codelineno-0-1238"></a>            <span class="c1"># Sort by priority</span>
<a id="__codelineno-0-1239" name="__codelineno-0-1239"></a>            <span class="n">segments</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;priority&quot;</span><span class="p">])</span>
<a id="__codelineno-0-1240" name="__codelineno-0-1240"></a>
<a id="__codelineno-0-1241" name="__codelineno-0-1241"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;segments&quot;</span><span class="p">:</span> <span class="n">segments</span><span class="p">}</span>
<a id="__codelineno-0-1242" name="__codelineno-0-1242"></a>
<a id="__codelineno-0-1243" name="__codelineno-0-1243"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1244" name="__codelineno-0-1244"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;get_hud_segments failed: error=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1245" name="__codelineno-0-1245"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-0-1246" name="__codelineno-0-1246"></a>
<a id="__codelineno-0-1247" name="__codelineno-0-1247"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_client</span><span class="p">(</span>
<a id="__codelineno-0-1248" name="__codelineno-0-1248"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">StreamReader</span><span class="p">,</span> <span class="n">writer</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">StreamWriter</span>
<a id="__codelineno-0-1249" name="__codelineno-0-1249"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1250" name="__codelineno-0-1250"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1251" name="__codelineno-0-1251"></a><span class="sd">        Handle an IPC request from a client.</span>
<a id="__codelineno-0-1252" name="__codelineno-0-1252"></a>
<a id="__codelineno-0-1253" name="__codelineno-0-1253"></a><span class="sd">        Reads JSON request from socket, processes command, sends JSON response.</span>
<a id="__codelineno-0-1254" name="__codelineno-0-1254"></a><span class="sd">        Each command is handled synchronously but multiple clients can connect</span>
<a id="__codelineno-0-1255" name="__codelineno-0-1255"></a><span class="sd">        concurrently.</span>
<a id="__codelineno-0-1256" name="__codelineno-0-1256"></a>
<a id="__codelineno-0-1257" name="__codelineno-0-1257"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-1258" name="__codelineno-0-1258"></a><span class="sd">            reader: asyncio StreamReader for reading request</span>
<a id="__codelineno-0-1259" name="__codelineno-0-1259"></a><span class="sd">            writer: asyncio StreamWriter for sending response</span>
<a id="__codelineno-0-1260" name="__codelineno-0-1260"></a>
<a id="__codelineno-0-1261" name="__codelineno-0-1261"></a><span class="sd">        IPC Request Format:</span>
<a id="__codelineno-0-1262" name="__codelineno-0-1262"></a><span class="sd">            ```json</span>
<a id="__codelineno-0-1263" name="__codelineno-0-1263"></a><span class="sd">            {&quot;cmd&quot;: &quot;command_name&quot;, &quot;arg1&quot;: &quot;value&quot;, ...}</span>
<a id="__codelineno-0-1264" name="__codelineno-0-1264"></a><span class="sd">            ```</span>
<a id="__codelineno-0-1265" name="__codelineno-0-1265"></a>
<a id="__codelineno-0-1266" name="__codelineno-0-1266"></a><span class="sd">        IPC Response Format:</span>
<a id="__codelineno-0-1267" name="__codelineno-0-1267"></a><span class="sd">            ```json</span>
<a id="__codelineno-0-1268" name="__codelineno-0-1268"></a><span class="sd">            {&quot;ok&quot;: true, &quot;result&quot;: ...}</span>
<a id="__codelineno-0-1269" name="__codelineno-0-1269"></a><span class="sd">            // or</span>
<a id="__codelineno-0-1270" name="__codelineno-0-1270"></a><span class="sd">            {&quot;ok&quot;: false, &quot;error&quot;: &quot;message&quot;}</span>
<a id="__codelineno-0-1271" name="__codelineno-0-1271"></a><span class="sd">            ```</span>
<a id="__codelineno-0-1272" name="__codelineno-0-1272"></a>
<a id="__codelineno-0-1273" name="__codelineno-0-1273"></a><span class="sd">        Supported Commands:</span>
<a id="__codelineno-0-1274" name="__codelineno-0-1274"></a><span class="sd">            ```json</span>
<a id="__codelineno-0-1275" name="__codelineno-0-1275"></a><span class="sd">            ping: {&quot;cmd&quot;: &quot;ping&quot;} → {&quot;ok&quot;: true, &quot;pong&quot;: true}</span>
<a id="__codelineno-0-1276" name="__codelineno-0-1276"></a>
<a id="__codelineno-0-1277" name="__codelineno-0-1277"></a><span class="sd">            get_state: {&quot;cmd&quot;: &quot;get_state&quot;} → {&quot;ok&quot;: true, &quot;state&quot;: {...}}</span>
<a id="__codelineno-0-1278" name="__codelineno-0-1278"></a>
<a id="__codelineno-0-1279" name="__codelineno-0-1279"></a><span class="sd">            set_env: {&quot;cmd&quot;: &quot;set_env&quot;, &quot;value&quot;: &quot;prod&quot;}</span>
<a id="__codelineno-0-1280" name="__codelineno-0-1280"></a><span class="sd">                   → {&quot;ok&quot;: true}</span>
<a id="__codelineno-0-1281" name="__codelineno-0-1281"></a><span class="sd">                   Side effect: Emits env_change event to Spokes</span>
<a id="__codelineno-0-1282" name="__codelineno-0-1282"></a>
<a id="__codelineno-0-1283" name="__codelineno-0-1283"></a><span class="sd">            set_pane_env: {&quot;cmd&quot;: &quot;set_pane_env&quot;, &quot;pane&quot;: &quot;%1&quot;, &quot;value&quot;: &quot;prod&quot;}</span>
<a id="__codelineno-0-1284" name="__codelineno-0-1284"></a><span class="sd">                        → {&quot;ok&quot;: true}</span>
<a id="__codelineno-0-1285" name="__codelineno-0-1285"></a><span class="sd">                        Side effect: Emits env_change event with pane context</span>
<a id="__codelineno-0-1286" name="__codelineno-0-1286"></a>
<a id="__codelineno-0-1287" name="__codelineno-0-1287"></a><span class="sd">            get_hud: {&quot;cmd&quot;: &quot;get_hud&quot;, &quot;pane&quot;: &quot;%1&quot;}</span>
<a id="__codelineno-0-1288" name="__codelineno-0-1288"></a><span class="sd">                   → {&quot;ok&quot;: true, &quot;hud&quot;: &quot;[axium] pane:%1  env:prod  uptime:2h15m&quot;}</span>
<a id="__codelineno-0-1289" name="__codelineno-0-1289"></a><span class="sd">                   Fast path: Returns pre-rendered HUD string from cache</span>
<a id="__codelineno-0-1290" name="__codelineno-0-1290"></a>
<a id="__codelineno-0-1291" name="__codelineno-0-1291"></a><span class="sd">            get_pane_env: {&quot;cmd&quot;: &quot;get_pane_env&quot;, &quot;pane&quot;: &quot;%1&quot;}</span>
<a id="__codelineno-0-1292" name="__codelineno-0-1292"></a><span class="sd">                        → {&quot;ok&quot;: true, &quot;env&quot;: &quot;prod&quot;}</span>
<a id="__codelineno-0-1293" name="__codelineno-0-1293"></a>
<a id="__codelineno-0-1294" name="__codelineno-0-1294"></a><span class="sd">            clear_pane_env: {&quot;cmd&quot;: &quot;clear_pane_env&quot;, &quot;pane&quot;: &quot;%1&quot;}</span>
<a id="__codelineno-0-1295" name="__codelineno-0-1295"></a><span class="sd">                          → {&quot;ok&quot;: true}</span>
<a id="__codelineno-0-1296" name="__codelineno-0-1296"></a>
<a id="__codelineno-0-1297" name="__codelineno-0-1297"></a><span class="sd">            reload: {&quot;cmd&quot;: &quot;reload&quot;} → {&quot;ok&quot;: true, &quot;reloaded&quot;: true}</span>
<a id="__codelineno-0-1298" name="__codelineno-0-1298"></a><span class="sd">                   Side effect: Reloads state from disk</span>
<a id="__codelineno-0-1299" name="__codelineno-0-1299"></a>
<a id="__codelineno-0-1300" name="__codelineno-0-1300"></a><span class="sd">            apply_prefixes: {&quot;cmd&quot;: &quot;apply_prefixes&quot;, &quot;command&quot;: &quot;aws&quot;,</span>
<a id="__codelineno-0-1301" name="__codelineno-0-1301"></a><span class="sd">                            &quot;args&quot;: [&quot;s3&quot;, &quot;ls&quot;], &quot;context&quot;: {...}}</span>
<a id="__codelineno-0-1302" name="__codelineno-0-1302"></a><span class="sd">                          → {&quot;ok&quot;: true, &quot;command&quot;: [...], &quot;env_vars&quot;: {...}}</span>
<a id="__codelineno-0-1303" name="__codelineno-0-1303"></a>
<a id="__codelineno-0-1304" name="__codelineno-0-1304"></a><span class="sd">            list_prefixed_commands: {&quot;cmd&quot;: &quot;list_prefixed_commands&quot;}</span>
<a id="__codelineno-0-1305" name="__codelineno-0-1305"></a><span class="sd">                                  → {&quot;ok&quot;: true, &quot;commands&quot;: [&quot;aws&quot;, &quot;terraform&quot;, ...]}</span>
<a id="__codelineno-0-1306" name="__codelineno-0-1306"></a>
<a id="__codelineno-0-1307" name="__codelineno-0-1307"></a><span class="sd">            stop: {&quot;cmd&quot;: &quot;stop&quot;} → {&quot;ok&quot;: true, &quot;stopping&quot;: True}</span>
<a id="__codelineno-0-1308" name="__codelineno-0-1308"></a><span class="sd">                 Side effect: Triggers graceful shutdown</span>
<a id="__codelineno-0-1309" name="__codelineno-0-1309"></a><span class="sd">            ```</span>
<a id="__codelineno-0-1310" name="__codelineno-0-1310"></a>
<a id="__codelineno-0-1311" name="__codelineno-0-1311"></a><span class="sd">        Note:</span>
<a id="__codelineno-0-1312" name="__codelineno-0-1312"></a><span class="sd">            Errors are caught and returned as {&quot;ok&quot;: false, &quot;error&quot;: &quot;message&quot;}</span>
<a id="__codelineno-0-1313" name="__codelineno-0-1313"></a><span class="sd">            Connection is closed after each request (no persistent connections)</span>
<a id="__codelineno-0-1314" name="__codelineno-0-1314"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1315" name="__codelineno-0-1315"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1316" name="__codelineno-0-1316"></a>            <span class="n">raw</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reader</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
<a id="__codelineno-0-1317" name="__codelineno-0-1317"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
<a id="__codelineno-0-1318" name="__codelineno-0-1318"></a>                <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-1319" name="__codelineno-0-1319"></a>                <span class="k">return</span>
<a id="__codelineno-0-1320" name="__codelineno-0-1320"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
<a id="__codelineno-0-1321" name="__codelineno-0-1321"></a>            <span class="n">cmd</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cmd&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1322" name="__codelineno-0-1322"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received IPC command: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
<a id="__codelineno-0-1323" name="__codelineno-0-1323"></a>
<a id="__codelineno-0-1324" name="__codelineno-0-1324"></a>            <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;ping&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1325" name="__codelineno-0-1325"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;pong&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-1326" name="__codelineno-0-1326"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;get_state&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1327" name="__codelineno-0-1327"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">}</span>
<a id="__codelineno-0-1328" name="__codelineno-0-1328"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;set_env&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1329" name="__codelineno-0-1329"></a>                <span class="n">new_env</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1330" name="__codelineno-0-1330"></a>
<a id="__codelineno-0-1331" name="__codelineno-0-1331"></a>                <span class="c1"># Validate environment name before setting</span>
<a id="__codelineno-0-1332" name="__codelineno-0-1332"></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">env</span> <span class="k">as</span> <span class="n">env_module</span>
<a id="__codelineno-0-1333" name="__codelineno-0-1333"></a>
<a id="__codelineno-0-1334" name="__codelineno-0-1334"></a>                <span class="n">is_valid</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">env_module</span><span class="o">.</span><span class="n">validate_env_name</span><span class="p">(</span><span class="n">new_env</span><span class="p">)</span>
<a id="__codelineno-0-1335" name="__codelineno-0-1335"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
<a id="__codelineno-0-1336" name="__codelineno-0-1336"></a>                    <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">}</span>
<a id="__codelineno-0-1337" name="__codelineno-0-1337"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1338" name="__codelineno-0-1338"></a>                    <span class="n">old_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;active_env&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1339" name="__codelineno-0-1339"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;active_env&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_env</span>
<a id="__codelineno-0-1340" name="__codelineno-0-1340"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_state</span><span class="p">()</span>
<a id="__codelineno-0-1341" name="__codelineno-0-1341"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Environment set to: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_env</span><span class="p">)</span>
<a id="__codelineno-0-1342" name="__codelineno-0-1342"></a>
<a id="__codelineno-0-1343" name="__codelineno-0-1343"></a>                    <span class="c1"># Invalidate all config caches (env-aware configs need refresh)</span>
<a id="__codelineno-0-1344" name="__codelineno-0-1344"></a>                    <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>
<a id="__codelineno-0-1345" name="__codelineno-0-1345"></a>
<a id="__codelineno-0-1346" name="__codelineno-0-1346"></a>                    <span class="n">config</span><span class="o">.</span><span class="n">invalidate_cache</span><span class="p">()</span>
<a id="__codelineno-0-1347" name="__codelineno-0-1347"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Invalidated all config caches due to env change&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1348" name="__codelineno-0-1348"></a>
<a id="__codelineno-0-1349" name="__codelineno-0-1349"></a>                    <span class="c1"># Emit env_change event</span>
<a id="__codelineno-0-1350" name="__codelineno-0-1350"></a>                    <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">spokes</span>
<a id="__codelineno-0-1351" name="__codelineno-0-1351"></a>
<a id="__codelineno-0-1352" name="__codelineno-0-1352"></a>                    <span class="n">spokes</span><span class="o">.</span><span class="n">get_event_bus</span><span class="p">()</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;env_change&quot;</span><span class="p">,</span> <span class="n">new_env</span><span class="p">,</span> <span class="n">old_env</span><span class="p">)</span>
<a id="__codelineno-0-1353" name="__codelineno-0-1353"></a>
<a id="__codelineno-0-1354" name="__codelineno-0-1354"></a>                    <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-1355" name="__codelineno-0-1355"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;get_hud&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1356" name="__codelineno-0-1356"></a>                <span class="c1"># Render HUD fresh each time (includes dynamic uptime)</span>
<a id="__codelineno-0-1357" name="__codelineno-0-1357"></a>                <span class="n">pane_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pane&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1358" name="__codelineno-0-1358"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">pane_id</span><span class="p">:</span>
<a id="__codelineno-0-1359" name="__codelineno-0-1359"></a>                    <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;pane ID required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1360" name="__codelineno-0-1360"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1361" name="__codelineno-0-1361"></a>                    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1362" name="__codelineno-0-1362"></a>                        <span class="c1"># Always render fresh to get current uptime</span>
<a id="__codelineno-0-1363" name="__codelineno-0-1363"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Rendering HUD for pane </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pane_id</span><span class="p">)</span>
<a id="__codelineno-0-1364" name="__codelineno-0-1364"></a>                        <span class="n">hud_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_hud_for_pane</span><span class="p">(</span><span class="n">pane_id</span><span class="p">)</span>
<a id="__codelineno-0-1365" name="__codelineno-0-1365"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;HUD rendered: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">hud_str</span><span class="p">)</span>
<a id="__codelineno-0-1366" name="__codelineno-0-1366"></a>                        <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;hud&quot;</span><span class="p">:</span> <span class="n">hud_str</span><span class="p">}</span>
<a id="__codelineno-0-1367" name="__codelineno-0-1367"></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1368" name="__codelineno-0-1368"></a>                        <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<a id="__codelineno-0-1369" name="__codelineno-0-1369"></a>
<a id="__codelineno-0-1370" name="__codelineno-0-1370"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-1371" name="__codelineno-0-1371"></a>                            <span class="s2">&quot;Error rendering HUD for pane </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1372" name="__codelineno-0-1372"></a>                            <span class="n">pane_id</span><span class="p">,</span>
<a id="__codelineno-0-1373" name="__codelineno-0-1373"></a>                            <span class="n">e</span><span class="p">,</span>
<a id="__codelineno-0-1374" name="__codelineno-0-1374"></a>                            <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span>
<a id="__codelineno-0-1375" name="__codelineno-0-1375"></a>                        <span class="p">)</span>
<a id="__codelineno-0-1376" name="__codelineno-0-1376"></a>                        <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;hud&quot;</span><span class="p">:</span> <span class="s2">&quot;[axium] inactive&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1377" name="__codelineno-0-1377"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;set_pane_env&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1378" name="__codelineno-0-1378"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_set_pane_env</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1379" name="__codelineno-0-1379"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;get_pane_env&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1380" name="__codelineno-0-1380"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_get_pane_env</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1381" name="__codelineno-0-1381"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;clear_pane_env&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1382" name="__codelineno-0-1382"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_clear_pane_env</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1383" name="__codelineno-0-1383"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;reload&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1384" name="__codelineno-0-1384"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reload command received&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1385" name="__codelineno-0-1385"></a>                <span class="c1"># Reload state from disk</span>
<a id="__codelineno-0-1386" name="__codelineno-0-1386"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_load_state</span><span class="p">()</span>
<a id="__codelineno-0-1387" name="__codelineno-0-1387"></a>                <span class="c1"># Reload HUD configuration</span>
<a id="__codelineno-0-1388" name="__codelineno-0-1388"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_load_hud_config</span><span class="p">()</span>
<a id="__codelineno-0-1389" name="__codelineno-0-1389"></a>                <span class="c1"># Reload prefix configuration</span>
<a id="__codelineno-0-1390" name="__codelineno-0-1390"></a>                <span class="n">prefix</span><span class="o">.</span><span class="n">reload_config</span><span class="p">()</span>
<a id="__codelineno-0-1391" name="__codelineno-0-1391"></a>                <span class="c1"># Reload all spoke configurations</span>
<a id="__codelineno-0-1392" name="__codelineno-0-1392"></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>
<a id="__codelineno-0-1393" name="__codelineno-0-1393"></a>
<a id="__codelineno-0-1394" name="__codelineno-0-1394"></a>                <span class="n">config</span><span class="o">.</span><span class="n">reload_all_configs</span><span class="p">()</span>
<a id="__codelineno-0-1395" name="__codelineno-0-1395"></a>                <span class="c1"># Regenerate state cache in case prefix rules changed</span>
<a id="__codelineno-0-1396" name="__codelineno-0-1396"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_write_state_cache</span><span class="p">()</span>
<a id="__codelineno-0-1397" name="__codelineno-0-1397"></a>                <span class="c1"># Refresh HUD cache for all panes</span>
<a id="__codelineno-0-1398" name="__codelineno-0-1398"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_all_hud_caches</span><span class="p">()</span>
<a id="__codelineno-0-1399" name="__codelineno-0-1399"></a>                <span class="c1"># Emit post-reload events</span>
<a id="__codelineno-0-1400" name="__codelineno-0-1400"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;hud_refresh&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1401" name="__codelineno-0-1401"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;daemon_reload&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1402" name="__codelineno-0-1402"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;config_reloaded&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1403" name="__codelineno-0-1403"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;reloaded&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-1404" name="__codelineno-0-1404"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;apply_prefixes&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1405" name="__codelineno-0-1405"></a>                <span class="c1"># Apply prefix rules to a command</span>
<a id="__codelineno-0-1406" name="__codelineno-0-1406"></a>                <span class="n">command</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1407" name="__codelineno-0-1407"></a>                <span class="n">args</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-1408" name="__codelineno-0-1408"></a>                <span class="n">context</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-1409" name="__codelineno-0-1409"></a>
<a id="__codelineno-0-1410" name="__codelineno-0-1410"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1411" name="__codelineno-0-1411"></a>                    <span class="n">final_cmd</span><span class="p">,</span> <span class="n">env_vars</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">apply_prefixes</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-1412" name="__codelineno-0-1412"></a>                    <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1413" name="__codelineno-0-1413"></a>                        <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1414" name="__codelineno-0-1414"></a>                        <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">final_cmd</span><span class="p">,</span>
<a id="__codelineno-0-1415" name="__codelineno-0-1415"></a>                        <span class="s2">&quot;env_vars&quot;</span><span class="p">:</span> <span class="n">env_vars</span><span class="p">,</span>
<a id="__codelineno-0-1416" name="__codelineno-0-1416"></a>                    <span class="p">}</span>
<a id="__codelineno-0-1417" name="__codelineno-0-1417"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1418" name="__codelineno-0-1418"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to apply prefixes: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1419" name="__codelineno-0-1419"></a>                    <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-0-1420" name="__codelineno-0-1420"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;list_prefixed_commands&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1421" name="__codelineno-0-1421"></a>                <span class="c1"># List all commands that have prefix rules</span>
<a id="__codelineno-0-1422" name="__codelineno-0-1422"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1423" name="__codelineno-0-1423"></a>                    <span class="n">commands</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">get_prefixed_commands</span><span class="p">()</span>
<a id="__codelineno-0-1424" name="__codelineno-0-1424"></a>                    <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="n">commands</span><span class="p">}</span>
<a id="__codelineno-0-1425" name="__codelineno-0-1425"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1426" name="__codelineno-0-1426"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to list prefixed commands: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1427" name="__codelineno-0-1427"></a>                    <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-0-1428" name="__codelineno-0-1428"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;notify&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1429" name="__codelineno-0-1429"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_notify</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1430" name="__codelineno-0-1430"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;daemon_exec&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1431" name="__codelineno-0-1431"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_daemon_exec</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1432" name="__codelineno-0-1432"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;notify_drain&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1433" name="__codelineno-0-1433"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_notify_drain</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1434" name="__codelineno-0-1434"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;get_permissions&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1435" name="__codelineno-0-1435"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_get_permissions</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1436" name="__codelineno-0-1436"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;load_spoke_permissions&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1437" name="__codelineno-0-1437"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_load_spoke_permissions</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1438" name="__codelineno-0-1438"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;get_config&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1439" name="__codelineno-0-1439"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_get_config</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1440" name="__codelineno-0-1440"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;tmux_split_run&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1441" name="__codelineno-0-1441"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_tmux_split_run</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1442" name="__codelineno-0-1442"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;tmux_send_keys&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1443" name="__codelineno-0-1443"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_tmux_send_keys</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1444" name="__codelineno-0-1444"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;tmux_capture_pane&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1445" name="__codelineno-0-1445"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_tmux_capture_pane</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1446" name="__codelineno-0-1446"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;read_file&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1447" name="__codelineno-0-1447"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_read_file</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1448" name="__codelineno-0-1448"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;write_file&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1449" name="__codelineno-0-1449"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_write_file</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1450" name="__codelineno-0-1450"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;write_log&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1451" name="__codelineno-0-1451"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_write_log</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1452" name="__codelineno-0-1452"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;register_prefix&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1453" name="__codelineno-0-1453"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_register_prefix</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1454" name="__codelineno-0-1454"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;get_hud_segments&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1455" name="__codelineno-0-1455"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_get_hud_segments</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1456" name="__codelineno-0-1456"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;daemon_status&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1457" name="__codelineno-0-1457"></a>                <span class="c1"># Return daemon status information</span>
<a id="__codelineno-0-1458" name="__codelineno-0-1458"></a>                <span class="n">uptime_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span><span class="p">)</span>
<a id="__codelineno-0-1459" name="__codelineno-0-1459"></a>                <span class="c1"># Format uptime as &quot;Xh Ym Zs&quot;</span>
<a id="__codelineno-0-1460" name="__codelineno-0-1460"></a>                <span class="n">hours</span> <span class="o">=</span> <span class="n">uptime_seconds</span> <span class="o">//</span> <span class="mi">3600</span>
<a id="__codelineno-0-1461" name="__codelineno-0-1461"></a>                <span class="n">minutes</span> <span class="o">=</span> <span class="p">(</span><span class="n">uptime_seconds</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">//</span> <span class="mi">60</span>
<a id="__codelineno-0-1462" name="__codelineno-0-1462"></a>                <span class="n">seconds</span> <span class="o">=</span> <span class="n">uptime_seconds</span> <span class="o">%</span> <span class="mi">60</span>
<a id="__codelineno-0-1463" name="__codelineno-0-1463"></a>
<a id="__codelineno-0-1464" name="__codelineno-0-1464"></a>                <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1465" name="__codelineno-0-1465"></a>                <span class="k">if</span> <span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1466" name="__codelineno-0-1466"></a>                    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2">h&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1467" name="__codelineno-0-1467"></a>                <span class="k">if</span> <span class="n">minutes</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Show minutes if we have hours</span>
<a id="__codelineno-0-1468" name="__codelineno-0-1468"></a>                    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">minutes</span><span class="si">}</span><span class="s2">m&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1469" name="__codelineno-0-1469"></a>                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">seconds</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1470" name="__codelineno-0-1470"></a>                <span class="n">uptime_str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
<a id="__codelineno-0-1471" name="__codelineno-0-1471"></a>
<a id="__codelineno-0-1472" name="__codelineno-0-1472"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1473" name="__codelineno-0-1473"></a>                    <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1474" name="__codelineno-0-1474"></a>                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-1475" name="__codelineno-0-1475"></a>                        <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1476" name="__codelineno-0-1476"></a>                        <span class="s2">&quot;uptime&quot;</span><span class="p">:</span> <span class="n">uptime_str</span><span class="p">,</span>
<a id="__codelineno-0-1477" name="__codelineno-0-1477"></a>                        <span class="s2">&quot;active_env&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;active_env&quot;</span><span class="p">),</span>
<a id="__codelineno-0-1478" name="__codelineno-0-1478"></a>                        <span class="s2">&quot;panes&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;panes&quot;</span><span class="p">,</span> <span class="p">{})),</span>
<a id="__codelineno-0-1479" name="__codelineno-0-1479"></a>                    <span class="p">},</span>
<a id="__codelineno-0-1480" name="__codelineno-0-1480"></a>                <span class="p">}</span>
<a id="__codelineno-0-1481" name="__codelineno-0-1481"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;reload_spoke&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1482" name="__codelineno-0-1482"></a>                <span class="c1"># Reload a specific spoke - daemon performs the action</span>
<a id="__codelineno-0-1483" name="__codelineno-0-1483"></a>                <span class="n">spoke_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spoke&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1484" name="__codelineno-0-1484"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_name</span><span class="p">:</span>
<a id="__codelineno-0-1485" name="__codelineno-0-1485"></a>                    <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke name required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1486" name="__codelineno-0-1486"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1487" name="__codelineno-0-1487"></a>                    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1488" name="__codelineno-0-1488"></a>                        <span class="c1"># PERFORM THE ACTION (don&#39;t just emit event)</span>
<a id="__codelineno-0-1489" name="__codelineno-0-1489"></a>                        <span class="kn">from</span><span class="w"> </span><span class="nn">axium.core.spokes</span><span class="w"> </span><span class="kn">import</span> <span class="n">reload_spokes</span>
<a id="__codelineno-0-1490" name="__codelineno-0-1490"></a>
<a id="__codelineno-0-1491" name="__codelineno-0-1491"></a>                        <span class="n">reloaded</span> <span class="o">=</span> <span class="n">reload_spokes</span><span class="p">(</span><span class="n">spoke_name</span><span class="p">)</span>
<a id="__codelineno-0-1492" name="__codelineno-0-1492"></a>
<a id="__codelineno-0-1493" name="__codelineno-0-1493"></a>                        <span class="k">if</span> <span class="n">reloaded</span><span class="p">:</span>
<a id="__codelineno-0-1494" name="__codelineno-0-1494"></a>                            <span class="c1"># THEN emit post-action notification</span>
<a id="__codelineno-0-1495" name="__codelineno-0-1495"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;spoke_reloaded&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="o">=</span><span class="n">spoke_name</span><span class="p">)</span>
<a id="__codelineno-0-1496" name="__codelineno-0-1496"></a>                            <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;spoke&quot;</span><span class="p">:</span> <span class="n">spoke_name</span><span class="p">}</span>
<a id="__codelineno-0-1497" name="__codelineno-0-1497"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1498" name="__codelineno-0-1498"></a>                            <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1499" name="__codelineno-0-1499"></a>                                <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1500" name="__codelineno-0-1500"></a>                                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;failed to reload spoke: </span><span class="si">{</span><span class="n">spoke_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1501" name="__codelineno-0-1501"></a>                            <span class="p">}</span>
<a id="__codelineno-0-1502" name="__codelineno-0-1502"></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1503" name="__codelineno-0-1503"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Spoke reload failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1504" name="__codelineno-0-1504"></a>                        <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-0-1505" name="__codelineno-0-1505"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;reload_spokes&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1506" name="__codelineno-0-1506"></a>                <span class="c1"># Reload all spokes - daemon performs the action</span>
<a id="__codelineno-0-1507" name="__codelineno-0-1507"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1508" name="__codelineno-0-1508"></a>                    <span class="kn">from</span><span class="w"> </span><span class="nn">axium.core.spokes</span><span class="w"> </span><span class="kn">import</span> <span class="n">reload_spokes</span>
<a id="__codelineno-0-1509" name="__codelineno-0-1509"></a>
<a id="__codelineno-0-1510" name="__codelineno-0-1510"></a>                    <span class="n">reloaded_list</span> <span class="o">=</span> <span class="n">reload_spokes</span><span class="p">()</span>  <span class="c1"># Reload all</span>
<a id="__codelineno-0-1511" name="__codelineno-0-1511"></a>
<a id="__codelineno-0-1512" name="__codelineno-0-1512"></a>                    <span class="c1"># Emit post-action event for EACH reloaded spoke</span>
<a id="__codelineno-0-1513" name="__codelineno-0-1513"></a>                    <span class="k">for</span> <span class="n">spoke_name</span> <span class="ow">in</span> <span class="n">reloaded_list</span><span class="p">:</span>
<a id="__codelineno-0-1514" name="__codelineno-0-1514"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;spoke_reloaded&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="o">=</span><span class="n">spoke_name</span><span class="p">)</span>
<a id="__codelineno-0-1515" name="__codelineno-0-1515"></a>
<a id="__codelineno-0-1516" name="__codelineno-0-1516"></a>                    <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;spokes&quot;</span><span class="p">:</span> <span class="n">reloaded_list</span><span class="p">}</span>
<a id="__codelineno-0-1517" name="__codelineno-0-1517"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1518" name="__codelineno-0-1518"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Spokes reload failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1519" name="__codelineno-0-1519"></a>                    <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s2">&quot;spokes&quot;</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-0-1520" name="__codelineno-0-1520"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;stop&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1521" name="__codelineno-0-1521"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stop command received&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1522" name="__codelineno-0-1522"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;stopping&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-1523" name="__codelineno-0-1523"></a>                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<a id="__codelineno-0-1524" name="__codelineno-0-1524"></a>                <span class="k">await</span> <span class="n">writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
<a id="__codelineno-0-1525" name="__codelineno-0-1525"></a>                <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-1526" name="__codelineno-0-1526"></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
<a id="__codelineno-0-1527" name="__codelineno-0-1527"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<a id="__codelineno-0-1528" name="__codelineno-0-1528"></a>                <span class="k">return</span>
<a id="__codelineno-0-1529" name="__codelineno-0-1529"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1530" name="__codelineno-0-1530"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown command received: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
<a id="__codelineno-0-1531" name="__codelineno-0-1531"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown command&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1532" name="__codelineno-0-1532"></a>            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<a id="__codelineno-0-1533" name="__codelineno-0-1533"></a>            <span class="k">await</span> <span class="n">writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
<a id="__codelineno-0-1534" name="__codelineno-0-1534"></a>            <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-1535" name="__codelineno-0-1535"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1536" name="__codelineno-0-1536"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error handling IPC request: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1537" name="__codelineno-0-1537"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1538" name="__codelineno-0-1538"></a>                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-0-1539" name="__codelineno-0-1539"></a>                    <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<a id="__codelineno-0-1540" name="__codelineno-0-1540"></a>                <span class="p">)</span>
<a id="__codelineno-0-1541" name="__codelineno-0-1541"></a>                <span class="k">await</span> <span class="n">writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
<a id="__codelineno-0-1542" name="__codelineno-0-1542"></a>                <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-1543" name="__codelineno-0-1543"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-1544" name="__codelineno-0-1544"></a>                <span class="k">pass</span>
<a id="__codelineno-0-1545" name="__codelineno-0-1545"></a>
<a id="__codelineno-0-1546" name="__codelineno-0-1546"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_periodic_segment_update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1547" name="__codelineno-0-1547"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1548" name="__codelineno-0-1548"></a><span class="sd">        Periodically update cached HUD segments.</span>
<a id="__codelineno-0-1549" name="__codelineno-0-1549"></a>
<a id="__codelineno-0-1550" name="__codelineno-0-1550"></a><span class="sd">        Runs every 5 minutes to refresh expensive segments like credential checks.</span>
<a id="__codelineno-0-1551" name="__codelineno-0-1551"></a><span class="sd">        This ensures segments stay up-to-date even without explicit events.</span>
<a id="__codelineno-0-1552" name="__codelineno-0-1552"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1553" name="__codelineno-0-1553"></a>        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
<a id="__codelineno-0-1554" name="__codelineno-0-1554"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1555" name="__codelineno-0-1555"></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># 5 minutes</span>
<a id="__codelineno-0-1556" name="__codelineno-0-1556"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
<a id="__codelineno-0-1557" name="__codelineno-0-1557"></a>                    <span class="k">break</span>
<a id="__codelineno-0-1558" name="__codelineno-0-1558"></a>
<a id="__codelineno-0-1559" name="__codelineno-0-1559"></a>                <span class="c1"># Update all cached segments</span>
<a id="__codelineno-0-1560" name="__codelineno-0-1560"></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">.hud</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_registry</span>
<a id="__codelineno-0-1561" name="__codelineno-0-1561"></a>
<a id="__codelineno-0-1562" name="__codelineno-0-1562"></a>                <span class="n">registry</span> <span class="o">=</span> <span class="n">get_registry</span><span class="p">()</span>
<a id="__codelineno-0-1563" name="__codelineno-0-1563"></a>                <span class="n">env_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1564" name="__codelineno-0-1564"></a>                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="n">env_name</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">}</span>
<a id="__codelineno-0-1565" name="__codelineno-0-1565"></a>                <span class="n">registry</span><span class="o">.</span><span class="n">update_cached_segments</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-1566" name="__codelineno-0-1566"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Periodic cached segment update complete&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1567" name="__codelineno-0-1567"></a>
<a id="__codelineno-0-1568" name="__codelineno-0-1568"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1569" name="__codelineno-0-1569"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in periodic segment update: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1570" name="__codelineno-0-1570"></a>
<a id="__codelineno-0-1571" name="__codelineno-0-1571"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1572" name="__codelineno-0-1572"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1573" name="__codelineno-0-1573"></a><span class="sd">        Run the daemon event loop.</span>
<a id="__codelineno-0-1574" name="__codelineno-0-1574"></a>
<a id="__codelineno-0-1575" name="__codelineno-0-1575"></a><span class="sd">        Starts UNIX socket server and waits for shutdown signal.</span>
<a id="__codelineno-0-1576" name="__codelineno-0-1576"></a><span class="sd">        Cleans up socket file on exit.</span>
<a id="__codelineno-0-1577" name="__codelineno-0-1577"></a>
<a id="__codelineno-0-1578" name="__codelineno-0-1578"></a><span class="sd">        The server accepts connections on /tmp/axiumd.sock and handles</span>
<a id="__codelineno-0-1579" name="__codelineno-0-1579"></a><span class="sd">        each client in a separate task via handle_client().</span>
<a id="__codelineno-0-1580" name="__codelineno-0-1580"></a>
<a id="__codelineno-0-1581" name="__codelineno-0-1581"></a><span class="sd">        Blocks until _stop event is set (via stop command or signal).</span>
<a id="__codelineno-0-1582" name="__codelineno-0-1582"></a>
<a id="__codelineno-0-1583" name="__codelineno-0-1583"></a><span class="sd">        Side Effects:</span>
<a id="__codelineno-0-1584" name="__codelineno-0-1584"></a><span class="sd">            - Creates UNIX socket at /tmp/axiumd.sock</span>
<a id="__codelineno-0-1585" name="__codelineno-0-1585"></a><span class="sd">            - Removes existing socket if present</span>
<a id="__codelineno-0-1586" name="__codelineno-0-1586"></a><span class="sd">            - Cleans up socket on exit</span>
<a id="__codelineno-0-1587" name="__codelineno-0-1587"></a><span class="sd">            - Starts periodic cached segment updates every 5 minutes</span>
<a id="__codelineno-0-1588" name="__codelineno-0-1588"></a>
<a id="__codelineno-0-1589" name="__codelineno-0-1589"></a><span class="sd">        Note:</span>
<a id="__codelineno-0-1590" name="__codelineno-0-1590"></a><span class="sd">            This should be run via asyncio.run() in the main process.</span>
<a id="__codelineno-0-1591" name="__codelineno-0-1591"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1592" name="__codelineno-0-1592"></a>        <span class="k">if</span> <span class="n">SOCKET_PATH</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-1593" name="__codelineno-0-1593"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1594" name="__codelineno-0-1594"></a>                <span class="n">SOCKET_PATH</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
<a id="__codelineno-0-1595" name="__codelineno-0-1595"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removed existing socket at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">SOCKET_PATH</span><span class="p">)</span>
<a id="__codelineno-0-1596" name="__codelineno-0-1596"></a>            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
<a id="__codelineno-0-1597" name="__codelineno-0-1597"></a>                <span class="k">pass</span>
<a id="__codelineno-0-1598" name="__codelineno-0-1598"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Unix socket server at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">SOCKET_PATH</span><span class="p">)</span>
<a id="__codelineno-0-1599" name="__codelineno-0-1599"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">start_unix_server</span><span class="p">(</span>
<a id="__codelineno-0-1600" name="__codelineno-0-1600"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">handle_client</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">SOCKET_PATH</span><span class="p">)</span>
<a id="__codelineno-0-1601" name="__codelineno-0-1601"></a>        <span class="p">)</span>
<a id="__codelineno-0-1602" name="__codelineno-0-1602"></a>
<a id="__codelineno-0-1603" name="__codelineno-0-1603"></a>        <span class="c1"># Start periodic segment update task</span>
<a id="__codelineno-0-1604" name="__codelineno-0-1604"></a>        <span class="n">update_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_periodic_segment_update</span><span class="p">())</span>
<a id="__codelineno-0-1605" name="__codelineno-0-1605"></a>
<a id="__codelineno-0-1606" name="__codelineno-0-1606"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1607" name="__codelineno-0-1607"></a>            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">:</span>
<a id="__codelineno-0-1608" name="__codelineno-0-1608"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Daemon ready, waiting for connections&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1609" name="__codelineno-0-1609"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<a id="__codelineno-0-1610" name="__codelineno-0-1610"></a>        <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-0-1611" name="__codelineno-0-1611"></a>            <span class="c1"># Cancel periodic task</span>
<a id="__codelineno-0-1612" name="__codelineno-0-1612"></a>            <span class="n">update_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<a id="__codelineno-0-1613" name="__codelineno-0-1613"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1614" name="__codelineno-0-1614"></a>                <span class="k">await</span> <span class="n">update_task</span>
<a id="__codelineno-0-1615" name="__codelineno-0-1615"></a>            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
<a id="__codelineno-0-1616" name="__codelineno-0-1616"></a>                <span class="k">pass</span>
<a id="__codelineno-0-1617" name="__codelineno-0-1617"></a>
<a id="__codelineno-0-1618" name="__codelineno-0-1618"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up socket&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1619" name="__codelineno-0-1619"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1620" name="__codelineno-0-1620"></a>            <span class="n">SOCKET_PATH</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
<a id="__codelineno-0-1621" name="__codelineno-0-1621"></a>        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
<a id="__codelineno-0-1622" name="__codelineno-0-1622"></a>            <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="axium.core.daemon.AxiumDaemon.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">()</span></code>

<a href="#axium.core.daemon.AxiumDaemon.__init__" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Initialize daemon with default state.</p>
<p>Loads persistent state from state.json if it exists, otherwise
initializes with defaults. Creates empty event registry.</p>


            <details class="quote">
              <summary>Source code in <code>axium/core/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">    Initialize daemon with default state.</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">    Loads persistent state from state.json if it exists, otherwise</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">    initializes with defaults. Creates empty event registry.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="c1"># Runtime-only state (not persisted)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="s2">&quot;active_env&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="s2">&quot;panes&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># Per-pane environment mapping: {&quot;%1&quot;: &quot;root&quot;, &quot;%2&quot;: &quot;builder&quot;}</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="s2">&quot;hud_cache&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># Pre-rendered HUD strings: {&quot;%1&quot;: &quot;[axium] pane:%1 ...&quot;}</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="s2">&quot;tmux_pane&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TMUX_PANE&quot;</span><span class="p">),</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="s2">&quot;started&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+00:00&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">),</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="p">}</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># Unix timestamp for fast uptime calculations</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="p">{}</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="p">)</span>  <span class="c1"># Effective permissions per spoke: {spoke_name: SpokePermissions}</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">notification_queue</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="p">[]</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="p">)</span>  <span class="c1"># Queued notifications: [{&quot;title&quot;: ..., &quot;body&quot;: ..., &quot;spoke&quot;: ...}]</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">hud_config</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># HUD layout configuration from hud.yaml</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>    <span class="c1"># Initialize EventBus for spoke coordination</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">axium.core.spokes</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_event_bus</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">get_event_bus</span><span class="p">()</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="c1"># Set up completion cache event listeners</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;spoke_loaded&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_spoke_loaded</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;spoke_reloaded&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_spoke_reloaded</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;spoke_unloaded&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_spoke_unloaded</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;gear_loaded&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_gear_loaded</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;gear_unloaded&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_gear_unloaded</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;daemon_reload&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_daemon_reload</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_load_state</span><span class="p">()</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_load_hud_config</span><span class="p">()</span>  <span class="c1"># Load HUD layout from hud.yaml</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_write_state_cache</span><span class="p">()</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_all_hud_caches</span><span class="p">()</span>  <span class="c1"># Pre-render HUD for all panes</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="c1"># Load gears for daemon IPC operations</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="c1"># Note: Gears are also loaded in CLI for command registration</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="c1"># This loads them in daemon context for IPC permission enforcement</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_load_gears_for_daemon</span><span class="p">()</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="c1"># Generate initial completion cache</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_regenerate_completions</span><span class="p">(</span><span class="s2">&quot;daemon_init&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="axium.core.daemon.AxiumDaemon.handle_client" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">handle_client</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#axium.core.daemon.AxiumDaemon.handle_client" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Handle an IPC request from a client.</p>
<p>Reads JSON request from socket, processes command, sends JSON response.
Each command is handled synchronously but multiple clients can connect
concurrently.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>reader</code>
            </td>
            <td>
                  <code><span title="asyncio.StreamReader">StreamReader</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>asyncio StreamReader for reading request</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>writer</code>
            </td>
            <td>
                  <code><span title="asyncio.StreamWriter">StreamWriter</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>asyncio StreamWriter for sending response</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="ipc-request-format" open>
  <summary>IPC Request Format</summary>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="p">{</span><span class="nt">&quot;cmd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;command_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;arg1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">...</span><span class="p">}</span>
</code></pre></div>
</details>

<details class="ipc-response-format" open>
  <summary>IPC Response Format</summary>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;result&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">...</span><span class="p">}</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="c1">// or</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;message&quot;</span><span class="p">}</span>
</code></pre></div>
</details>

<details class="supported-commands" open>
  <summary>Supported Commands</summary>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="err">pi</span><span class="kc">n</span><span class="err">g</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;cmd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ping&quot;</span><span class="p">}</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;pong&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="err">ge</span><span class="kc">t</span><span class="err">_s</span><span class="kc">tate</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;cmd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;get_state&quot;</span><span class="p">}</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;state&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">}}</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="err">se</span><span class="kc">t</span><span class="err">_e</span><span class="kc">n</span><span class="err">v</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;cmd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;set_env&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prod&quot;</span><span class="p">}</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">       </span><span class="err">→</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">       </span><span class="err">Side</span><span class="w"> </span><span class="err">e</span><span class="kc">ffe</span><span class="err">c</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Emi</span><span class="kc">ts</span><span class="w"> </span><span class="err">e</span><span class="kc">n</span><span class="err">v_cha</span><span class="kc">n</span><span class="err">ge</span><span class="w"> </span><span class="err">eve</span><span class="kc">nt</span><span class="w"> </span><span class="kc">t</span><span class="err">o</span><span class="w"> </span><span class="err">Spokes</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="err">se</span><span class="kc">t</span><span class="err">_pa</span><span class="kc">ne</span><span class="err">_e</span><span class="kc">n</span><span class="err">v</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;cmd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;set_pane_env&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;pane&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;%1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prod&quot;</span><span class="p">}</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">            </span><span class="err">→</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">            </span><span class="err">Side</span><span class="w"> </span><span class="err">e</span><span class="kc">ffe</span><span class="err">c</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Emi</span><span class="kc">ts</span><span class="w"> </span><span class="err">e</span><span class="kc">n</span><span class="err">v_cha</span><span class="kc">n</span><span class="err">ge</span><span class="w"> </span><span class="err">eve</span><span class="kc">nt</span><span class="w"> </span><span class="err">wi</span><span class="kc">t</span><span class="err">h</span><span class="w"> </span><span class="err">pa</span><span class="kc">ne</span><span class="w"> </span><span class="err">co</span><span class="kc">nte</span><span class="err">x</span><span class="kc">t</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="err">ge</span><span class="kc">t</span><span class="err">_hud</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;cmd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;get_hud&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;pane&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;%1&quot;</span><span class="p">}</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">       </span><span class="err">→</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;hud&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;[axium] pane:%1  env:prod  uptime:2h15m&quot;</span><span class="p">}</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">       </span><span class="err">Fas</span><span class="kc">t</span><span class="w"> </span><span class="err">pa</span><span class="kc">t</span><span class="err">h</span><span class="p">:</span><span class="w"> </span><span class="err">Re</span><span class="kc">turns</span><span class="w"> </span><span class="err">pre</span><span class="mi">-</span><span class="err">re</span><span class="kc">n</span><span class="err">dered</span><span class="w"> </span><span class="err">HUD</span><span class="w"> </span><span class="err">s</span><span class="kc">tr</span><span class="err">i</span><span class="kc">n</span><span class="err">g</span><span class="w"> </span><span class="kc">fr</span><span class="err">om</span><span class="w"> </span><span class="err">cache</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="err">ge</span><span class="kc">t</span><span class="err">_pa</span><span class="kc">ne</span><span class="err">_e</span><span class="kc">n</span><span class="err">v</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;cmd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;get_pane_env&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;pane&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;%1&quot;</span><span class="p">}</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">            </span><span class="err">→</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;env&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prod&quot;</span><span class="p">}</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="err">clear_pa</span><span class="kc">ne</span><span class="err">_e</span><span class="kc">n</span><span class="err">v</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;cmd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;clear_pane_env&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;pane&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;%1&quot;</span><span class="p">}</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">              </span><span class="err">→</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="err">reload</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;cmd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;reload&quot;</span><span class="p">}</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;reloaded&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="w">       </span><span class="err">Side</span><span class="w"> </span><span class="err">e</span><span class="kc">ffe</span><span class="err">c</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Reloads</span><span class="w"> </span><span class="err">s</span><span class="kc">tate</span><span class="w"> </span><span class="kc">fr</span><span class="err">om</span><span class="w"> </span><span class="err">disk</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="err">apply_pre</span><span class="kc">f</span><span class="err">ixes</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;cmd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;apply_prefixes&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;command&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;aws&quot;</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="w">                </span><span class="nt">&quot;args&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;s3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ls&quot;</span><span class="p">],</span><span class="w"> </span><span class="nt">&quot;context&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">}}</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="w">              </span><span class="err">→</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;command&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">...</span><span class="p">],</span><span class="w"> </span><span class="nt">&quot;env_vars&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">}}</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="err">lis</span><span class="kc">t</span><span class="err">_pre</span><span class="kc">f</span><span class="err">ixed_comma</span><span class="kc">n</span><span class="err">ds</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;cmd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;list_prefixed_commands&quot;</span><span class="p">}</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="w">                      </span><span class="err">→</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;commands&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;aws&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;terraform&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">...</span><span class="p">]}</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="err">s</span><span class="kc">t</span><span class="err">op</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;cmd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;stop&quot;</span><span class="p">}</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;stopping&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">True</span><span class="p">}</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="w">     </span><span class="err">Side</span><span class="w"> </span><span class="err">e</span><span class="kc">ffe</span><span class="err">c</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">Triggers</span><span class="w"> </span><span class="err">grace</span><span class="kc">ful</span><span class="w"> </span><span class="err">shu</span><span class="kc">t</span><span class="err">dow</span><span class="kc">n</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>Errors are caught and returned as {"ok": false, "error": "message"}
Connection is closed after each request (no persistent connections)</p>
</details>

            <details class="quote">
              <summary>Source code in <code>axium/core/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1247">1247</a></span>
<span class="normal"><a href="#__codelineno-0-1248">1248</a></span>
<span class="normal"><a href="#__codelineno-0-1249">1249</a></span>
<span class="normal"><a href="#__codelineno-0-1250">1250</a></span>
<span class="normal"><a href="#__codelineno-0-1251">1251</a></span>
<span class="normal"><a href="#__codelineno-0-1252">1252</a></span>
<span class="normal"><a href="#__codelineno-0-1253">1253</a></span>
<span class="normal"><a href="#__codelineno-0-1254">1254</a></span>
<span class="normal"><a href="#__codelineno-0-1255">1255</a></span>
<span class="normal"><a href="#__codelineno-0-1256">1256</a></span>
<span class="normal"><a href="#__codelineno-0-1257">1257</a></span>
<span class="normal"><a href="#__codelineno-0-1258">1258</a></span>
<span class="normal"><a href="#__codelineno-0-1259">1259</a></span>
<span class="normal"><a href="#__codelineno-0-1260">1260</a></span>
<span class="normal"><a href="#__codelineno-0-1261">1261</a></span>
<span class="normal"><a href="#__codelineno-0-1262">1262</a></span>
<span class="normal"><a href="#__codelineno-0-1263">1263</a></span>
<span class="normal"><a href="#__codelineno-0-1264">1264</a></span>
<span class="normal"><a href="#__codelineno-0-1265">1265</a></span>
<span class="normal"><a href="#__codelineno-0-1266">1266</a></span>
<span class="normal"><a href="#__codelineno-0-1267">1267</a></span>
<span class="normal"><a href="#__codelineno-0-1268">1268</a></span>
<span class="normal"><a href="#__codelineno-0-1269">1269</a></span>
<span class="normal"><a href="#__codelineno-0-1270">1270</a></span>
<span class="normal"><a href="#__codelineno-0-1271">1271</a></span>
<span class="normal"><a href="#__codelineno-0-1272">1272</a></span>
<span class="normal"><a href="#__codelineno-0-1273">1273</a></span>
<span class="normal"><a href="#__codelineno-0-1274">1274</a></span>
<span class="normal"><a href="#__codelineno-0-1275">1275</a></span>
<span class="normal"><a href="#__codelineno-0-1276">1276</a></span>
<span class="normal"><a href="#__codelineno-0-1277">1277</a></span>
<span class="normal"><a href="#__codelineno-0-1278">1278</a></span>
<span class="normal"><a href="#__codelineno-0-1279">1279</a></span>
<span class="normal"><a href="#__codelineno-0-1280">1280</a></span>
<span class="normal"><a href="#__codelineno-0-1281">1281</a></span>
<span class="normal"><a href="#__codelineno-0-1282">1282</a></span>
<span class="normal"><a href="#__codelineno-0-1283">1283</a></span>
<span class="normal"><a href="#__codelineno-0-1284">1284</a></span>
<span class="normal"><a href="#__codelineno-0-1285">1285</a></span>
<span class="normal"><a href="#__codelineno-0-1286">1286</a></span>
<span class="normal"><a href="#__codelineno-0-1287">1287</a></span>
<span class="normal"><a href="#__codelineno-0-1288">1288</a></span>
<span class="normal"><a href="#__codelineno-0-1289">1289</a></span>
<span class="normal"><a href="#__codelineno-0-1290">1290</a></span>
<span class="normal"><a href="#__codelineno-0-1291">1291</a></span>
<span class="normal"><a href="#__codelineno-0-1292">1292</a></span>
<span class="normal"><a href="#__codelineno-0-1293">1293</a></span>
<span class="normal"><a href="#__codelineno-0-1294">1294</a></span>
<span class="normal"><a href="#__codelineno-0-1295">1295</a></span>
<span class="normal"><a href="#__codelineno-0-1296">1296</a></span>
<span class="normal"><a href="#__codelineno-0-1297">1297</a></span>
<span class="normal"><a href="#__codelineno-0-1298">1298</a></span>
<span class="normal"><a href="#__codelineno-0-1299">1299</a></span>
<span class="normal"><a href="#__codelineno-0-1300">1300</a></span>
<span class="normal"><a href="#__codelineno-0-1301">1301</a></span>
<span class="normal"><a href="#__codelineno-0-1302">1302</a></span>
<span class="normal"><a href="#__codelineno-0-1303">1303</a></span>
<span class="normal"><a href="#__codelineno-0-1304">1304</a></span>
<span class="normal"><a href="#__codelineno-0-1305">1305</a></span>
<span class="normal"><a href="#__codelineno-0-1306">1306</a></span>
<span class="normal"><a href="#__codelineno-0-1307">1307</a></span>
<span class="normal"><a href="#__codelineno-0-1308">1308</a></span>
<span class="normal"><a href="#__codelineno-0-1309">1309</a></span>
<span class="normal"><a href="#__codelineno-0-1310">1310</a></span>
<span class="normal"><a href="#__codelineno-0-1311">1311</a></span>
<span class="normal"><a href="#__codelineno-0-1312">1312</a></span>
<span class="normal"><a href="#__codelineno-0-1313">1313</a></span>
<span class="normal"><a href="#__codelineno-0-1314">1314</a></span>
<span class="normal"><a href="#__codelineno-0-1315">1315</a></span>
<span class="normal"><a href="#__codelineno-0-1316">1316</a></span>
<span class="normal"><a href="#__codelineno-0-1317">1317</a></span>
<span class="normal"><a href="#__codelineno-0-1318">1318</a></span>
<span class="normal"><a href="#__codelineno-0-1319">1319</a></span>
<span class="normal"><a href="#__codelineno-0-1320">1320</a></span>
<span class="normal"><a href="#__codelineno-0-1321">1321</a></span>
<span class="normal"><a href="#__codelineno-0-1322">1322</a></span>
<span class="normal"><a href="#__codelineno-0-1323">1323</a></span>
<span class="normal"><a href="#__codelineno-0-1324">1324</a></span>
<span class="normal"><a href="#__codelineno-0-1325">1325</a></span>
<span class="normal"><a href="#__codelineno-0-1326">1326</a></span>
<span class="normal"><a href="#__codelineno-0-1327">1327</a></span>
<span class="normal"><a href="#__codelineno-0-1328">1328</a></span>
<span class="normal"><a href="#__codelineno-0-1329">1329</a></span>
<span class="normal"><a href="#__codelineno-0-1330">1330</a></span>
<span class="normal"><a href="#__codelineno-0-1331">1331</a></span>
<span class="normal"><a href="#__codelineno-0-1332">1332</a></span>
<span class="normal"><a href="#__codelineno-0-1333">1333</a></span>
<span class="normal"><a href="#__codelineno-0-1334">1334</a></span>
<span class="normal"><a href="#__codelineno-0-1335">1335</a></span>
<span class="normal"><a href="#__codelineno-0-1336">1336</a></span>
<span class="normal"><a href="#__codelineno-0-1337">1337</a></span>
<span class="normal"><a href="#__codelineno-0-1338">1338</a></span>
<span class="normal"><a href="#__codelineno-0-1339">1339</a></span>
<span class="normal"><a href="#__codelineno-0-1340">1340</a></span>
<span class="normal"><a href="#__codelineno-0-1341">1341</a></span>
<span class="normal"><a href="#__codelineno-0-1342">1342</a></span>
<span class="normal"><a href="#__codelineno-0-1343">1343</a></span>
<span class="normal"><a href="#__codelineno-0-1344">1344</a></span>
<span class="normal"><a href="#__codelineno-0-1345">1345</a></span>
<span class="normal"><a href="#__codelineno-0-1346">1346</a></span>
<span class="normal"><a href="#__codelineno-0-1347">1347</a></span>
<span class="normal"><a href="#__codelineno-0-1348">1348</a></span>
<span class="normal"><a href="#__codelineno-0-1349">1349</a></span>
<span class="normal"><a href="#__codelineno-0-1350">1350</a></span>
<span class="normal"><a href="#__codelineno-0-1351">1351</a></span>
<span class="normal"><a href="#__codelineno-0-1352">1352</a></span>
<span class="normal"><a href="#__codelineno-0-1353">1353</a></span>
<span class="normal"><a href="#__codelineno-0-1354">1354</a></span>
<span class="normal"><a href="#__codelineno-0-1355">1355</a></span>
<span class="normal"><a href="#__codelineno-0-1356">1356</a></span>
<span class="normal"><a href="#__codelineno-0-1357">1357</a></span>
<span class="normal"><a href="#__codelineno-0-1358">1358</a></span>
<span class="normal"><a href="#__codelineno-0-1359">1359</a></span>
<span class="normal"><a href="#__codelineno-0-1360">1360</a></span>
<span class="normal"><a href="#__codelineno-0-1361">1361</a></span>
<span class="normal"><a href="#__codelineno-0-1362">1362</a></span>
<span class="normal"><a href="#__codelineno-0-1363">1363</a></span>
<span class="normal"><a href="#__codelineno-0-1364">1364</a></span>
<span class="normal"><a href="#__codelineno-0-1365">1365</a></span>
<span class="normal"><a href="#__codelineno-0-1366">1366</a></span>
<span class="normal"><a href="#__codelineno-0-1367">1367</a></span>
<span class="normal"><a href="#__codelineno-0-1368">1368</a></span>
<span class="normal"><a href="#__codelineno-0-1369">1369</a></span>
<span class="normal"><a href="#__codelineno-0-1370">1370</a></span>
<span class="normal"><a href="#__codelineno-0-1371">1371</a></span>
<span class="normal"><a href="#__codelineno-0-1372">1372</a></span>
<span class="normal"><a href="#__codelineno-0-1373">1373</a></span>
<span class="normal"><a href="#__codelineno-0-1374">1374</a></span>
<span class="normal"><a href="#__codelineno-0-1375">1375</a></span>
<span class="normal"><a href="#__codelineno-0-1376">1376</a></span>
<span class="normal"><a href="#__codelineno-0-1377">1377</a></span>
<span class="normal"><a href="#__codelineno-0-1378">1378</a></span>
<span class="normal"><a href="#__codelineno-0-1379">1379</a></span>
<span class="normal"><a href="#__codelineno-0-1380">1380</a></span>
<span class="normal"><a href="#__codelineno-0-1381">1381</a></span>
<span class="normal"><a href="#__codelineno-0-1382">1382</a></span>
<span class="normal"><a href="#__codelineno-0-1383">1383</a></span>
<span class="normal"><a href="#__codelineno-0-1384">1384</a></span>
<span class="normal"><a href="#__codelineno-0-1385">1385</a></span>
<span class="normal"><a href="#__codelineno-0-1386">1386</a></span>
<span class="normal"><a href="#__codelineno-0-1387">1387</a></span>
<span class="normal"><a href="#__codelineno-0-1388">1388</a></span>
<span class="normal"><a href="#__codelineno-0-1389">1389</a></span>
<span class="normal"><a href="#__codelineno-0-1390">1390</a></span>
<span class="normal"><a href="#__codelineno-0-1391">1391</a></span>
<span class="normal"><a href="#__codelineno-0-1392">1392</a></span>
<span class="normal"><a href="#__codelineno-0-1393">1393</a></span>
<span class="normal"><a href="#__codelineno-0-1394">1394</a></span>
<span class="normal"><a href="#__codelineno-0-1395">1395</a></span>
<span class="normal"><a href="#__codelineno-0-1396">1396</a></span>
<span class="normal"><a href="#__codelineno-0-1397">1397</a></span>
<span class="normal"><a href="#__codelineno-0-1398">1398</a></span>
<span class="normal"><a href="#__codelineno-0-1399">1399</a></span>
<span class="normal"><a href="#__codelineno-0-1400">1400</a></span>
<span class="normal"><a href="#__codelineno-0-1401">1401</a></span>
<span class="normal"><a href="#__codelineno-0-1402">1402</a></span>
<span class="normal"><a href="#__codelineno-0-1403">1403</a></span>
<span class="normal"><a href="#__codelineno-0-1404">1404</a></span>
<span class="normal"><a href="#__codelineno-0-1405">1405</a></span>
<span class="normal"><a href="#__codelineno-0-1406">1406</a></span>
<span class="normal"><a href="#__codelineno-0-1407">1407</a></span>
<span class="normal"><a href="#__codelineno-0-1408">1408</a></span>
<span class="normal"><a href="#__codelineno-0-1409">1409</a></span>
<span class="normal"><a href="#__codelineno-0-1410">1410</a></span>
<span class="normal"><a href="#__codelineno-0-1411">1411</a></span>
<span class="normal"><a href="#__codelineno-0-1412">1412</a></span>
<span class="normal"><a href="#__codelineno-0-1413">1413</a></span>
<span class="normal"><a href="#__codelineno-0-1414">1414</a></span>
<span class="normal"><a href="#__codelineno-0-1415">1415</a></span>
<span class="normal"><a href="#__codelineno-0-1416">1416</a></span>
<span class="normal"><a href="#__codelineno-0-1417">1417</a></span>
<span class="normal"><a href="#__codelineno-0-1418">1418</a></span>
<span class="normal"><a href="#__codelineno-0-1419">1419</a></span>
<span class="normal"><a href="#__codelineno-0-1420">1420</a></span>
<span class="normal"><a href="#__codelineno-0-1421">1421</a></span>
<span class="normal"><a href="#__codelineno-0-1422">1422</a></span>
<span class="normal"><a href="#__codelineno-0-1423">1423</a></span>
<span class="normal"><a href="#__codelineno-0-1424">1424</a></span>
<span class="normal"><a href="#__codelineno-0-1425">1425</a></span>
<span class="normal"><a href="#__codelineno-0-1426">1426</a></span>
<span class="normal"><a href="#__codelineno-0-1427">1427</a></span>
<span class="normal"><a href="#__codelineno-0-1428">1428</a></span>
<span class="normal"><a href="#__codelineno-0-1429">1429</a></span>
<span class="normal"><a href="#__codelineno-0-1430">1430</a></span>
<span class="normal"><a href="#__codelineno-0-1431">1431</a></span>
<span class="normal"><a href="#__codelineno-0-1432">1432</a></span>
<span class="normal"><a href="#__codelineno-0-1433">1433</a></span>
<span class="normal"><a href="#__codelineno-0-1434">1434</a></span>
<span class="normal"><a href="#__codelineno-0-1435">1435</a></span>
<span class="normal"><a href="#__codelineno-0-1436">1436</a></span>
<span class="normal"><a href="#__codelineno-0-1437">1437</a></span>
<span class="normal"><a href="#__codelineno-0-1438">1438</a></span>
<span class="normal"><a href="#__codelineno-0-1439">1439</a></span>
<span class="normal"><a href="#__codelineno-0-1440">1440</a></span>
<span class="normal"><a href="#__codelineno-0-1441">1441</a></span>
<span class="normal"><a href="#__codelineno-0-1442">1442</a></span>
<span class="normal"><a href="#__codelineno-0-1443">1443</a></span>
<span class="normal"><a href="#__codelineno-0-1444">1444</a></span>
<span class="normal"><a href="#__codelineno-0-1445">1445</a></span>
<span class="normal"><a href="#__codelineno-0-1446">1446</a></span>
<span class="normal"><a href="#__codelineno-0-1447">1447</a></span>
<span class="normal"><a href="#__codelineno-0-1448">1448</a></span>
<span class="normal"><a href="#__codelineno-0-1449">1449</a></span>
<span class="normal"><a href="#__codelineno-0-1450">1450</a></span>
<span class="normal"><a href="#__codelineno-0-1451">1451</a></span>
<span class="normal"><a href="#__codelineno-0-1452">1452</a></span>
<span class="normal"><a href="#__codelineno-0-1453">1453</a></span>
<span class="normal"><a href="#__codelineno-0-1454">1454</a></span>
<span class="normal"><a href="#__codelineno-0-1455">1455</a></span>
<span class="normal"><a href="#__codelineno-0-1456">1456</a></span>
<span class="normal"><a href="#__codelineno-0-1457">1457</a></span>
<span class="normal"><a href="#__codelineno-0-1458">1458</a></span>
<span class="normal"><a href="#__codelineno-0-1459">1459</a></span>
<span class="normal"><a href="#__codelineno-0-1460">1460</a></span>
<span class="normal"><a href="#__codelineno-0-1461">1461</a></span>
<span class="normal"><a href="#__codelineno-0-1462">1462</a></span>
<span class="normal"><a href="#__codelineno-0-1463">1463</a></span>
<span class="normal"><a href="#__codelineno-0-1464">1464</a></span>
<span class="normal"><a href="#__codelineno-0-1465">1465</a></span>
<span class="normal"><a href="#__codelineno-0-1466">1466</a></span>
<span class="normal"><a href="#__codelineno-0-1467">1467</a></span>
<span class="normal"><a href="#__codelineno-0-1468">1468</a></span>
<span class="normal"><a href="#__codelineno-0-1469">1469</a></span>
<span class="normal"><a href="#__codelineno-0-1470">1470</a></span>
<span class="normal"><a href="#__codelineno-0-1471">1471</a></span>
<span class="normal"><a href="#__codelineno-0-1472">1472</a></span>
<span class="normal"><a href="#__codelineno-0-1473">1473</a></span>
<span class="normal"><a href="#__codelineno-0-1474">1474</a></span>
<span class="normal"><a href="#__codelineno-0-1475">1475</a></span>
<span class="normal"><a href="#__codelineno-0-1476">1476</a></span>
<span class="normal"><a href="#__codelineno-0-1477">1477</a></span>
<span class="normal"><a href="#__codelineno-0-1478">1478</a></span>
<span class="normal"><a href="#__codelineno-0-1479">1479</a></span>
<span class="normal"><a href="#__codelineno-0-1480">1480</a></span>
<span class="normal"><a href="#__codelineno-0-1481">1481</a></span>
<span class="normal"><a href="#__codelineno-0-1482">1482</a></span>
<span class="normal"><a href="#__codelineno-0-1483">1483</a></span>
<span class="normal"><a href="#__codelineno-0-1484">1484</a></span>
<span class="normal"><a href="#__codelineno-0-1485">1485</a></span>
<span class="normal"><a href="#__codelineno-0-1486">1486</a></span>
<span class="normal"><a href="#__codelineno-0-1487">1487</a></span>
<span class="normal"><a href="#__codelineno-0-1488">1488</a></span>
<span class="normal"><a href="#__codelineno-0-1489">1489</a></span>
<span class="normal"><a href="#__codelineno-0-1490">1490</a></span>
<span class="normal"><a href="#__codelineno-0-1491">1491</a></span>
<span class="normal"><a href="#__codelineno-0-1492">1492</a></span>
<span class="normal"><a href="#__codelineno-0-1493">1493</a></span>
<span class="normal"><a href="#__codelineno-0-1494">1494</a></span>
<span class="normal"><a href="#__codelineno-0-1495">1495</a></span>
<span class="normal"><a href="#__codelineno-0-1496">1496</a></span>
<span class="normal"><a href="#__codelineno-0-1497">1497</a></span>
<span class="normal"><a href="#__codelineno-0-1498">1498</a></span>
<span class="normal"><a href="#__codelineno-0-1499">1499</a></span>
<span class="normal"><a href="#__codelineno-0-1500">1500</a></span>
<span class="normal"><a href="#__codelineno-0-1501">1501</a></span>
<span class="normal"><a href="#__codelineno-0-1502">1502</a></span>
<span class="normal"><a href="#__codelineno-0-1503">1503</a></span>
<span class="normal"><a href="#__codelineno-0-1504">1504</a></span>
<span class="normal"><a href="#__codelineno-0-1505">1505</a></span>
<span class="normal"><a href="#__codelineno-0-1506">1506</a></span>
<span class="normal"><a href="#__codelineno-0-1507">1507</a></span>
<span class="normal"><a href="#__codelineno-0-1508">1508</a></span>
<span class="normal"><a href="#__codelineno-0-1509">1509</a></span>
<span class="normal"><a href="#__codelineno-0-1510">1510</a></span>
<span class="normal"><a href="#__codelineno-0-1511">1511</a></span>
<span class="normal"><a href="#__codelineno-0-1512">1512</a></span>
<span class="normal"><a href="#__codelineno-0-1513">1513</a></span>
<span class="normal"><a href="#__codelineno-0-1514">1514</a></span>
<span class="normal"><a href="#__codelineno-0-1515">1515</a></span>
<span class="normal"><a href="#__codelineno-0-1516">1516</a></span>
<span class="normal"><a href="#__codelineno-0-1517">1517</a></span>
<span class="normal"><a href="#__codelineno-0-1518">1518</a></span>
<span class="normal"><a href="#__codelineno-0-1519">1519</a></span>
<span class="normal"><a href="#__codelineno-0-1520">1520</a></span>
<span class="normal"><a href="#__codelineno-0-1521">1521</a></span>
<span class="normal"><a href="#__codelineno-0-1522">1522</a></span>
<span class="normal"><a href="#__codelineno-0-1523">1523</a></span>
<span class="normal"><a href="#__codelineno-0-1524">1524</a></span>
<span class="normal"><a href="#__codelineno-0-1525">1525</a></span>
<span class="normal"><a href="#__codelineno-0-1526">1526</a></span>
<span class="normal"><a href="#__codelineno-0-1527">1527</a></span>
<span class="normal"><a href="#__codelineno-0-1528">1528</a></span>
<span class="normal"><a href="#__codelineno-0-1529">1529</a></span>
<span class="normal"><a href="#__codelineno-0-1530">1530</a></span>
<span class="normal"><a href="#__codelineno-0-1531">1531</a></span>
<span class="normal"><a href="#__codelineno-0-1532">1532</a></span>
<span class="normal"><a href="#__codelineno-0-1533">1533</a></span>
<span class="normal"><a href="#__codelineno-0-1534">1534</a></span>
<span class="normal"><a href="#__codelineno-0-1535">1535</a></span>
<span class="normal"><a href="#__codelineno-0-1536">1536</a></span>
<span class="normal"><a href="#__codelineno-0-1537">1537</a></span>
<span class="normal"><a href="#__codelineno-0-1538">1538</a></span>
<span class="normal"><a href="#__codelineno-0-1539">1539</a></span>
<span class="normal"><a href="#__codelineno-0-1540">1540</a></span>
<span class="normal"><a href="#__codelineno-0-1541">1541</a></span>
<span class="normal"><a href="#__codelineno-0-1542">1542</a></span>
<span class="normal"><a href="#__codelineno-0-1543">1543</a></span>
<span class="normal"><a href="#__codelineno-0-1544">1544</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1247" name="__codelineno-0-1247"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_client</span><span class="p">(</span>
<a id="__codelineno-0-1248" name="__codelineno-0-1248"></a>    <span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">StreamReader</span><span class="p">,</span> <span class="n">writer</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">StreamWriter</span>
<a id="__codelineno-0-1249" name="__codelineno-0-1249"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1250" name="__codelineno-0-1250"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1251" name="__codelineno-0-1251"></a><span class="sd">    Handle an IPC request from a client.</span>
<a id="__codelineno-0-1252" name="__codelineno-0-1252"></a>
<a id="__codelineno-0-1253" name="__codelineno-0-1253"></a><span class="sd">    Reads JSON request from socket, processes command, sends JSON response.</span>
<a id="__codelineno-0-1254" name="__codelineno-0-1254"></a><span class="sd">    Each command is handled synchronously but multiple clients can connect</span>
<a id="__codelineno-0-1255" name="__codelineno-0-1255"></a><span class="sd">    concurrently.</span>
<a id="__codelineno-0-1256" name="__codelineno-0-1256"></a>
<a id="__codelineno-0-1257" name="__codelineno-0-1257"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1258" name="__codelineno-0-1258"></a><span class="sd">        reader: asyncio StreamReader for reading request</span>
<a id="__codelineno-0-1259" name="__codelineno-0-1259"></a><span class="sd">        writer: asyncio StreamWriter for sending response</span>
<a id="__codelineno-0-1260" name="__codelineno-0-1260"></a>
<a id="__codelineno-0-1261" name="__codelineno-0-1261"></a><span class="sd">    IPC Request Format:</span>
<a id="__codelineno-0-1262" name="__codelineno-0-1262"></a><span class="sd">        ```json</span>
<a id="__codelineno-0-1263" name="__codelineno-0-1263"></a><span class="sd">        {&quot;cmd&quot;: &quot;command_name&quot;, &quot;arg1&quot;: &quot;value&quot;, ...}</span>
<a id="__codelineno-0-1264" name="__codelineno-0-1264"></a><span class="sd">        ```</span>
<a id="__codelineno-0-1265" name="__codelineno-0-1265"></a>
<a id="__codelineno-0-1266" name="__codelineno-0-1266"></a><span class="sd">    IPC Response Format:</span>
<a id="__codelineno-0-1267" name="__codelineno-0-1267"></a><span class="sd">        ```json</span>
<a id="__codelineno-0-1268" name="__codelineno-0-1268"></a><span class="sd">        {&quot;ok&quot;: true, &quot;result&quot;: ...}</span>
<a id="__codelineno-0-1269" name="__codelineno-0-1269"></a><span class="sd">        // or</span>
<a id="__codelineno-0-1270" name="__codelineno-0-1270"></a><span class="sd">        {&quot;ok&quot;: false, &quot;error&quot;: &quot;message&quot;}</span>
<a id="__codelineno-0-1271" name="__codelineno-0-1271"></a><span class="sd">        ```</span>
<a id="__codelineno-0-1272" name="__codelineno-0-1272"></a>
<a id="__codelineno-0-1273" name="__codelineno-0-1273"></a><span class="sd">    Supported Commands:</span>
<a id="__codelineno-0-1274" name="__codelineno-0-1274"></a><span class="sd">        ```json</span>
<a id="__codelineno-0-1275" name="__codelineno-0-1275"></a><span class="sd">        ping: {&quot;cmd&quot;: &quot;ping&quot;} → {&quot;ok&quot;: true, &quot;pong&quot;: true}</span>
<a id="__codelineno-0-1276" name="__codelineno-0-1276"></a>
<a id="__codelineno-0-1277" name="__codelineno-0-1277"></a><span class="sd">        get_state: {&quot;cmd&quot;: &quot;get_state&quot;} → {&quot;ok&quot;: true, &quot;state&quot;: {...}}</span>
<a id="__codelineno-0-1278" name="__codelineno-0-1278"></a>
<a id="__codelineno-0-1279" name="__codelineno-0-1279"></a><span class="sd">        set_env: {&quot;cmd&quot;: &quot;set_env&quot;, &quot;value&quot;: &quot;prod&quot;}</span>
<a id="__codelineno-0-1280" name="__codelineno-0-1280"></a><span class="sd">               → {&quot;ok&quot;: true}</span>
<a id="__codelineno-0-1281" name="__codelineno-0-1281"></a><span class="sd">               Side effect: Emits env_change event to Spokes</span>
<a id="__codelineno-0-1282" name="__codelineno-0-1282"></a>
<a id="__codelineno-0-1283" name="__codelineno-0-1283"></a><span class="sd">        set_pane_env: {&quot;cmd&quot;: &quot;set_pane_env&quot;, &quot;pane&quot;: &quot;%1&quot;, &quot;value&quot;: &quot;prod&quot;}</span>
<a id="__codelineno-0-1284" name="__codelineno-0-1284"></a><span class="sd">                    → {&quot;ok&quot;: true}</span>
<a id="__codelineno-0-1285" name="__codelineno-0-1285"></a><span class="sd">                    Side effect: Emits env_change event with pane context</span>
<a id="__codelineno-0-1286" name="__codelineno-0-1286"></a>
<a id="__codelineno-0-1287" name="__codelineno-0-1287"></a><span class="sd">        get_hud: {&quot;cmd&quot;: &quot;get_hud&quot;, &quot;pane&quot;: &quot;%1&quot;}</span>
<a id="__codelineno-0-1288" name="__codelineno-0-1288"></a><span class="sd">               → {&quot;ok&quot;: true, &quot;hud&quot;: &quot;[axium] pane:%1  env:prod  uptime:2h15m&quot;}</span>
<a id="__codelineno-0-1289" name="__codelineno-0-1289"></a><span class="sd">               Fast path: Returns pre-rendered HUD string from cache</span>
<a id="__codelineno-0-1290" name="__codelineno-0-1290"></a>
<a id="__codelineno-0-1291" name="__codelineno-0-1291"></a><span class="sd">        get_pane_env: {&quot;cmd&quot;: &quot;get_pane_env&quot;, &quot;pane&quot;: &quot;%1&quot;}</span>
<a id="__codelineno-0-1292" name="__codelineno-0-1292"></a><span class="sd">                    → {&quot;ok&quot;: true, &quot;env&quot;: &quot;prod&quot;}</span>
<a id="__codelineno-0-1293" name="__codelineno-0-1293"></a>
<a id="__codelineno-0-1294" name="__codelineno-0-1294"></a><span class="sd">        clear_pane_env: {&quot;cmd&quot;: &quot;clear_pane_env&quot;, &quot;pane&quot;: &quot;%1&quot;}</span>
<a id="__codelineno-0-1295" name="__codelineno-0-1295"></a><span class="sd">                      → {&quot;ok&quot;: true}</span>
<a id="__codelineno-0-1296" name="__codelineno-0-1296"></a>
<a id="__codelineno-0-1297" name="__codelineno-0-1297"></a><span class="sd">        reload: {&quot;cmd&quot;: &quot;reload&quot;} → {&quot;ok&quot;: true, &quot;reloaded&quot;: true}</span>
<a id="__codelineno-0-1298" name="__codelineno-0-1298"></a><span class="sd">               Side effect: Reloads state from disk</span>
<a id="__codelineno-0-1299" name="__codelineno-0-1299"></a>
<a id="__codelineno-0-1300" name="__codelineno-0-1300"></a><span class="sd">        apply_prefixes: {&quot;cmd&quot;: &quot;apply_prefixes&quot;, &quot;command&quot;: &quot;aws&quot;,</span>
<a id="__codelineno-0-1301" name="__codelineno-0-1301"></a><span class="sd">                        &quot;args&quot;: [&quot;s3&quot;, &quot;ls&quot;], &quot;context&quot;: {...}}</span>
<a id="__codelineno-0-1302" name="__codelineno-0-1302"></a><span class="sd">                      → {&quot;ok&quot;: true, &quot;command&quot;: [...], &quot;env_vars&quot;: {...}}</span>
<a id="__codelineno-0-1303" name="__codelineno-0-1303"></a>
<a id="__codelineno-0-1304" name="__codelineno-0-1304"></a><span class="sd">        list_prefixed_commands: {&quot;cmd&quot;: &quot;list_prefixed_commands&quot;}</span>
<a id="__codelineno-0-1305" name="__codelineno-0-1305"></a><span class="sd">                              → {&quot;ok&quot;: true, &quot;commands&quot;: [&quot;aws&quot;, &quot;terraform&quot;, ...]}</span>
<a id="__codelineno-0-1306" name="__codelineno-0-1306"></a>
<a id="__codelineno-0-1307" name="__codelineno-0-1307"></a><span class="sd">        stop: {&quot;cmd&quot;: &quot;stop&quot;} → {&quot;ok&quot;: true, &quot;stopping&quot;: True}</span>
<a id="__codelineno-0-1308" name="__codelineno-0-1308"></a><span class="sd">             Side effect: Triggers graceful shutdown</span>
<a id="__codelineno-0-1309" name="__codelineno-0-1309"></a><span class="sd">        ```</span>
<a id="__codelineno-0-1310" name="__codelineno-0-1310"></a>
<a id="__codelineno-0-1311" name="__codelineno-0-1311"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-1312" name="__codelineno-0-1312"></a><span class="sd">        Errors are caught and returned as {&quot;ok&quot;: false, &quot;error&quot;: &quot;message&quot;}</span>
<a id="__codelineno-0-1313" name="__codelineno-0-1313"></a><span class="sd">        Connection is closed after each request (no persistent connections)</span>
<a id="__codelineno-0-1314" name="__codelineno-0-1314"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1315" name="__codelineno-0-1315"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1316" name="__codelineno-0-1316"></a>        <span class="n">raw</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reader</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
<a id="__codelineno-0-1317" name="__codelineno-0-1317"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
<a id="__codelineno-0-1318" name="__codelineno-0-1318"></a>            <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-1319" name="__codelineno-0-1319"></a>            <span class="k">return</span>
<a id="__codelineno-0-1320" name="__codelineno-0-1320"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
<a id="__codelineno-0-1321" name="__codelineno-0-1321"></a>        <span class="n">cmd</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cmd&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1322" name="__codelineno-0-1322"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received IPC command: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
<a id="__codelineno-0-1323" name="__codelineno-0-1323"></a>
<a id="__codelineno-0-1324" name="__codelineno-0-1324"></a>        <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;ping&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1325" name="__codelineno-0-1325"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;pong&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-1326" name="__codelineno-0-1326"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;get_state&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1327" name="__codelineno-0-1327"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">}</span>
<a id="__codelineno-0-1328" name="__codelineno-0-1328"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;set_env&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1329" name="__codelineno-0-1329"></a>            <span class="n">new_env</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1330" name="__codelineno-0-1330"></a>
<a id="__codelineno-0-1331" name="__codelineno-0-1331"></a>            <span class="c1"># Validate environment name before setting</span>
<a id="__codelineno-0-1332" name="__codelineno-0-1332"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">env</span> <span class="k">as</span> <span class="n">env_module</span>
<a id="__codelineno-0-1333" name="__codelineno-0-1333"></a>
<a id="__codelineno-0-1334" name="__codelineno-0-1334"></a>            <span class="n">is_valid</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">env_module</span><span class="o">.</span><span class="n">validate_env_name</span><span class="p">(</span><span class="n">new_env</span><span class="p">)</span>
<a id="__codelineno-0-1335" name="__codelineno-0-1335"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
<a id="__codelineno-0-1336" name="__codelineno-0-1336"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">}</span>
<a id="__codelineno-0-1337" name="__codelineno-0-1337"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1338" name="__codelineno-0-1338"></a>                <span class="n">old_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;active_env&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1339" name="__codelineno-0-1339"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;active_env&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_env</span>
<a id="__codelineno-0-1340" name="__codelineno-0-1340"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_save_state</span><span class="p">()</span>
<a id="__codelineno-0-1341" name="__codelineno-0-1341"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Environment set to: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_env</span><span class="p">)</span>
<a id="__codelineno-0-1342" name="__codelineno-0-1342"></a>
<a id="__codelineno-0-1343" name="__codelineno-0-1343"></a>                <span class="c1"># Invalidate all config caches (env-aware configs need refresh)</span>
<a id="__codelineno-0-1344" name="__codelineno-0-1344"></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>
<a id="__codelineno-0-1345" name="__codelineno-0-1345"></a>
<a id="__codelineno-0-1346" name="__codelineno-0-1346"></a>                <span class="n">config</span><span class="o">.</span><span class="n">invalidate_cache</span><span class="p">()</span>
<a id="__codelineno-0-1347" name="__codelineno-0-1347"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Invalidated all config caches due to env change&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1348" name="__codelineno-0-1348"></a>
<a id="__codelineno-0-1349" name="__codelineno-0-1349"></a>                <span class="c1"># Emit env_change event</span>
<a id="__codelineno-0-1350" name="__codelineno-0-1350"></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">spokes</span>
<a id="__codelineno-0-1351" name="__codelineno-0-1351"></a>
<a id="__codelineno-0-1352" name="__codelineno-0-1352"></a>                <span class="n">spokes</span><span class="o">.</span><span class="n">get_event_bus</span><span class="p">()</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;env_change&quot;</span><span class="p">,</span> <span class="n">new_env</span><span class="p">,</span> <span class="n">old_env</span><span class="p">)</span>
<a id="__codelineno-0-1353" name="__codelineno-0-1353"></a>
<a id="__codelineno-0-1354" name="__codelineno-0-1354"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-1355" name="__codelineno-0-1355"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;get_hud&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1356" name="__codelineno-0-1356"></a>            <span class="c1"># Render HUD fresh each time (includes dynamic uptime)</span>
<a id="__codelineno-0-1357" name="__codelineno-0-1357"></a>            <span class="n">pane_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pane&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1358" name="__codelineno-0-1358"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">pane_id</span><span class="p">:</span>
<a id="__codelineno-0-1359" name="__codelineno-0-1359"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;pane ID required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1360" name="__codelineno-0-1360"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1361" name="__codelineno-0-1361"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1362" name="__codelineno-0-1362"></a>                    <span class="c1"># Always render fresh to get current uptime</span>
<a id="__codelineno-0-1363" name="__codelineno-0-1363"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Rendering HUD for pane </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pane_id</span><span class="p">)</span>
<a id="__codelineno-0-1364" name="__codelineno-0-1364"></a>                    <span class="n">hud_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_hud_for_pane</span><span class="p">(</span><span class="n">pane_id</span><span class="p">)</span>
<a id="__codelineno-0-1365" name="__codelineno-0-1365"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;HUD rendered: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">hud_str</span><span class="p">)</span>
<a id="__codelineno-0-1366" name="__codelineno-0-1366"></a>                    <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;hud&quot;</span><span class="p">:</span> <span class="n">hud_str</span><span class="p">}</span>
<a id="__codelineno-0-1367" name="__codelineno-0-1367"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1368" name="__codelineno-0-1368"></a>                    <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<a id="__codelineno-0-1369" name="__codelineno-0-1369"></a>
<a id="__codelineno-0-1370" name="__codelineno-0-1370"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-1371" name="__codelineno-0-1371"></a>                        <span class="s2">&quot;Error rendering HUD for pane </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1372" name="__codelineno-0-1372"></a>                        <span class="n">pane_id</span><span class="p">,</span>
<a id="__codelineno-0-1373" name="__codelineno-0-1373"></a>                        <span class="n">e</span><span class="p">,</span>
<a id="__codelineno-0-1374" name="__codelineno-0-1374"></a>                        <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span>
<a id="__codelineno-0-1375" name="__codelineno-0-1375"></a>                    <span class="p">)</span>
<a id="__codelineno-0-1376" name="__codelineno-0-1376"></a>                    <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;hud&quot;</span><span class="p">:</span> <span class="s2">&quot;[axium] inactive&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1377" name="__codelineno-0-1377"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;set_pane_env&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1378" name="__codelineno-0-1378"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_set_pane_env</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1379" name="__codelineno-0-1379"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;get_pane_env&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1380" name="__codelineno-0-1380"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_get_pane_env</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1381" name="__codelineno-0-1381"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;clear_pane_env&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1382" name="__codelineno-0-1382"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_clear_pane_env</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1383" name="__codelineno-0-1383"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;reload&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1384" name="__codelineno-0-1384"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reload command received&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1385" name="__codelineno-0-1385"></a>            <span class="c1"># Reload state from disk</span>
<a id="__codelineno-0-1386" name="__codelineno-0-1386"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_load_state</span><span class="p">()</span>
<a id="__codelineno-0-1387" name="__codelineno-0-1387"></a>            <span class="c1"># Reload HUD configuration</span>
<a id="__codelineno-0-1388" name="__codelineno-0-1388"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_load_hud_config</span><span class="p">()</span>
<a id="__codelineno-0-1389" name="__codelineno-0-1389"></a>            <span class="c1"># Reload prefix configuration</span>
<a id="__codelineno-0-1390" name="__codelineno-0-1390"></a>            <span class="n">prefix</span><span class="o">.</span><span class="n">reload_config</span><span class="p">()</span>
<a id="__codelineno-0-1391" name="__codelineno-0-1391"></a>            <span class="c1"># Reload all spoke configurations</span>
<a id="__codelineno-0-1392" name="__codelineno-0-1392"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>
<a id="__codelineno-0-1393" name="__codelineno-0-1393"></a>
<a id="__codelineno-0-1394" name="__codelineno-0-1394"></a>            <span class="n">config</span><span class="o">.</span><span class="n">reload_all_configs</span><span class="p">()</span>
<a id="__codelineno-0-1395" name="__codelineno-0-1395"></a>            <span class="c1"># Regenerate state cache in case prefix rules changed</span>
<a id="__codelineno-0-1396" name="__codelineno-0-1396"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_write_state_cache</span><span class="p">()</span>
<a id="__codelineno-0-1397" name="__codelineno-0-1397"></a>            <span class="c1"># Refresh HUD cache for all panes</span>
<a id="__codelineno-0-1398" name="__codelineno-0-1398"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_all_hud_caches</span><span class="p">()</span>
<a id="__codelineno-0-1399" name="__codelineno-0-1399"></a>            <span class="c1"># Emit post-reload events</span>
<a id="__codelineno-0-1400" name="__codelineno-0-1400"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;hud_refresh&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1401" name="__codelineno-0-1401"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;daemon_reload&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1402" name="__codelineno-0-1402"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;config_reloaded&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1403" name="__codelineno-0-1403"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;reloaded&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-1404" name="__codelineno-0-1404"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;apply_prefixes&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1405" name="__codelineno-0-1405"></a>            <span class="c1"># Apply prefix rules to a command</span>
<a id="__codelineno-0-1406" name="__codelineno-0-1406"></a>            <span class="n">command</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1407" name="__codelineno-0-1407"></a>            <span class="n">args</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-1408" name="__codelineno-0-1408"></a>            <span class="n">context</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-1409" name="__codelineno-0-1409"></a>
<a id="__codelineno-0-1410" name="__codelineno-0-1410"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1411" name="__codelineno-0-1411"></a>                <span class="n">final_cmd</span><span class="p">,</span> <span class="n">env_vars</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">apply_prefixes</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-1412" name="__codelineno-0-1412"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1413" name="__codelineno-0-1413"></a>                    <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1414" name="__codelineno-0-1414"></a>                    <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">final_cmd</span><span class="p">,</span>
<a id="__codelineno-0-1415" name="__codelineno-0-1415"></a>                    <span class="s2">&quot;env_vars&quot;</span><span class="p">:</span> <span class="n">env_vars</span><span class="p">,</span>
<a id="__codelineno-0-1416" name="__codelineno-0-1416"></a>                <span class="p">}</span>
<a id="__codelineno-0-1417" name="__codelineno-0-1417"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1418" name="__codelineno-0-1418"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to apply prefixes: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1419" name="__codelineno-0-1419"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-0-1420" name="__codelineno-0-1420"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;list_prefixed_commands&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1421" name="__codelineno-0-1421"></a>            <span class="c1"># List all commands that have prefix rules</span>
<a id="__codelineno-0-1422" name="__codelineno-0-1422"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1423" name="__codelineno-0-1423"></a>                <span class="n">commands</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">get_prefixed_commands</span><span class="p">()</span>
<a id="__codelineno-0-1424" name="__codelineno-0-1424"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="n">commands</span><span class="p">}</span>
<a id="__codelineno-0-1425" name="__codelineno-0-1425"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1426" name="__codelineno-0-1426"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to list prefixed commands: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1427" name="__codelineno-0-1427"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-0-1428" name="__codelineno-0-1428"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;notify&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1429" name="__codelineno-0-1429"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_notify</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1430" name="__codelineno-0-1430"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;daemon_exec&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1431" name="__codelineno-0-1431"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_daemon_exec</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1432" name="__codelineno-0-1432"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;notify_drain&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1433" name="__codelineno-0-1433"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_notify_drain</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1434" name="__codelineno-0-1434"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;get_permissions&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1435" name="__codelineno-0-1435"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_get_permissions</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1436" name="__codelineno-0-1436"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;load_spoke_permissions&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1437" name="__codelineno-0-1437"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_load_spoke_permissions</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1438" name="__codelineno-0-1438"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;get_config&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1439" name="__codelineno-0-1439"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_get_config</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1440" name="__codelineno-0-1440"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;tmux_split_run&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1441" name="__codelineno-0-1441"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_tmux_split_run</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1442" name="__codelineno-0-1442"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;tmux_send_keys&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1443" name="__codelineno-0-1443"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_tmux_send_keys</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1444" name="__codelineno-0-1444"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;tmux_capture_pane&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1445" name="__codelineno-0-1445"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_tmux_capture_pane</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1446" name="__codelineno-0-1446"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;read_file&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1447" name="__codelineno-0-1447"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_read_file</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1448" name="__codelineno-0-1448"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;write_file&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1449" name="__codelineno-0-1449"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_write_file</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1450" name="__codelineno-0-1450"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;write_log&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1451" name="__codelineno-0-1451"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_write_log</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1452" name="__codelineno-0-1452"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;register_prefix&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1453" name="__codelineno-0-1453"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_register_prefix</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1454" name="__codelineno-0-1454"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;get_hud_segments&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1455" name="__codelineno-0-1455"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_get_hud_segments</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-1456" name="__codelineno-0-1456"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;daemon_status&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1457" name="__codelineno-0-1457"></a>            <span class="c1"># Return daemon status information</span>
<a id="__codelineno-0-1458" name="__codelineno-0-1458"></a>            <span class="n">uptime_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span><span class="p">)</span>
<a id="__codelineno-0-1459" name="__codelineno-0-1459"></a>            <span class="c1"># Format uptime as &quot;Xh Ym Zs&quot;</span>
<a id="__codelineno-0-1460" name="__codelineno-0-1460"></a>            <span class="n">hours</span> <span class="o">=</span> <span class="n">uptime_seconds</span> <span class="o">//</span> <span class="mi">3600</span>
<a id="__codelineno-0-1461" name="__codelineno-0-1461"></a>            <span class="n">minutes</span> <span class="o">=</span> <span class="p">(</span><span class="n">uptime_seconds</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">//</span> <span class="mi">60</span>
<a id="__codelineno-0-1462" name="__codelineno-0-1462"></a>            <span class="n">seconds</span> <span class="o">=</span> <span class="n">uptime_seconds</span> <span class="o">%</span> <span class="mi">60</span>
<a id="__codelineno-0-1463" name="__codelineno-0-1463"></a>
<a id="__codelineno-0-1464" name="__codelineno-0-1464"></a>            <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1465" name="__codelineno-0-1465"></a>            <span class="k">if</span> <span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1466" name="__codelineno-0-1466"></a>                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2">h&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1467" name="__codelineno-0-1467"></a>            <span class="k">if</span> <span class="n">minutes</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">hours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Show minutes if we have hours</span>
<a id="__codelineno-0-1468" name="__codelineno-0-1468"></a>                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">minutes</span><span class="si">}</span><span class="s2">m&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1469" name="__codelineno-0-1469"></a>            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">seconds</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1470" name="__codelineno-0-1470"></a>            <span class="n">uptime_str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
<a id="__codelineno-0-1471" name="__codelineno-0-1471"></a>
<a id="__codelineno-0-1472" name="__codelineno-0-1472"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1473" name="__codelineno-0-1473"></a>                <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1474" name="__codelineno-0-1474"></a>                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-1475" name="__codelineno-0-1475"></a>                    <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1476" name="__codelineno-0-1476"></a>                    <span class="s2">&quot;uptime&quot;</span><span class="p">:</span> <span class="n">uptime_str</span><span class="p">,</span>
<a id="__codelineno-0-1477" name="__codelineno-0-1477"></a>                    <span class="s2">&quot;active_env&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;active_env&quot;</span><span class="p">),</span>
<a id="__codelineno-0-1478" name="__codelineno-0-1478"></a>                    <span class="s2">&quot;panes&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;panes&quot;</span><span class="p">,</span> <span class="p">{})),</span>
<a id="__codelineno-0-1479" name="__codelineno-0-1479"></a>                <span class="p">},</span>
<a id="__codelineno-0-1480" name="__codelineno-0-1480"></a>            <span class="p">}</span>
<a id="__codelineno-0-1481" name="__codelineno-0-1481"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;reload_spoke&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1482" name="__codelineno-0-1482"></a>            <span class="c1"># Reload a specific spoke - daemon performs the action</span>
<a id="__codelineno-0-1483" name="__codelineno-0-1483"></a>            <span class="n">spoke_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spoke&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1484" name="__codelineno-0-1484"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">spoke_name</span><span class="p">:</span>
<a id="__codelineno-0-1485" name="__codelineno-0-1485"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;spoke name required&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1486" name="__codelineno-0-1486"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1487" name="__codelineno-0-1487"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1488" name="__codelineno-0-1488"></a>                    <span class="c1"># PERFORM THE ACTION (don&#39;t just emit event)</span>
<a id="__codelineno-0-1489" name="__codelineno-0-1489"></a>                    <span class="kn">from</span><span class="w"> </span><span class="nn">axium.core.spokes</span><span class="w"> </span><span class="kn">import</span> <span class="n">reload_spokes</span>
<a id="__codelineno-0-1490" name="__codelineno-0-1490"></a>
<a id="__codelineno-0-1491" name="__codelineno-0-1491"></a>                    <span class="n">reloaded</span> <span class="o">=</span> <span class="n">reload_spokes</span><span class="p">(</span><span class="n">spoke_name</span><span class="p">)</span>
<a id="__codelineno-0-1492" name="__codelineno-0-1492"></a>
<a id="__codelineno-0-1493" name="__codelineno-0-1493"></a>                    <span class="k">if</span> <span class="n">reloaded</span><span class="p">:</span>
<a id="__codelineno-0-1494" name="__codelineno-0-1494"></a>                        <span class="c1"># THEN emit post-action notification</span>
<a id="__codelineno-0-1495" name="__codelineno-0-1495"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;spoke_reloaded&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="o">=</span><span class="n">spoke_name</span><span class="p">)</span>
<a id="__codelineno-0-1496" name="__codelineno-0-1496"></a>                        <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;spoke&quot;</span><span class="p">:</span> <span class="n">spoke_name</span><span class="p">}</span>
<a id="__codelineno-0-1497" name="__codelineno-0-1497"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1498" name="__codelineno-0-1498"></a>                        <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1499" name="__codelineno-0-1499"></a>                            <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1500" name="__codelineno-0-1500"></a>                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;failed to reload spoke: </span><span class="si">{</span><span class="n">spoke_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1501" name="__codelineno-0-1501"></a>                        <span class="p">}</span>
<a id="__codelineno-0-1502" name="__codelineno-0-1502"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1503" name="__codelineno-0-1503"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Spoke reload failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1504" name="__codelineno-0-1504"></a>                    <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
<a id="__codelineno-0-1505" name="__codelineno-0-1505"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;reload_spokes&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1506" name="__codelineno-0-1506"></a>            <span class="c1"># Reload all spokes - daemon performs the action</span>
<a id="__codelineno-0-1507" name="__codelineno-0-1507"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1508" name="__codelineno-0-1508"></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">axium.core.spokes</span><span class="w"> </span><span class="kn">import</span> <span class="n">reload_spokes</span>
<a id="__codelineno-0-1509" name="__codelineno-0-1509"></a>
<a id="__codelineno-0-1510" name="__codelineno-0-1510"></a>                <span class="n">reloaded_list</span> <span class="o">=</span> <span class="n">reload_spokes</span><span class="p">()</span>  <span class="c1"># Reload all</span>
<a id="__codelineno-0-1511" name="__codelineno-0-1511"></a>
<a id="__codelineno-0-1512" name="__codelineno-0-1512"></a>                <span class="c1"># Emit post-action event for EACH reloaded spoke</span>
<a id="__codelineno-0-1513" name="__codelineno-0-1513"></a>                <span class="k">for</span> <span class="n">spoke_name</span> <span class="ow">in</span> <span class="n">reloaded_list</span><span class="p">:</span>
<a id="__codelineno-0-1514" name="__codelineno-0-1514"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;spoke_reloaded&quot;</span><span class="p">,</span> <span class="n">spoke_name</span><span class="o">=</span><span class="n">spoke_name</span><span class="p">)</span>
<a id="__codelineno-0-1515" name="__codelineno-0-1515"></a>
<a id="__codelineno-0-1516" name="__codelineno-0-1516"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;spokes&quot;</span><span class="p">:</span> <span class="n">reloaded_list</span><span class="p">}</span>
<a id="__codelineno-0-1517" name="__codelineno-0-1517"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1518" name="__codelineno-0-1518"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Spokes reload failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1519" name="__codelineno-0-1519"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s2">&quot;spokes&quot;</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-0-1520" name="__codelineno-0-1520"></a>        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;stop&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1521" name="__codelineno-0-1521"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stop command received&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1522" name="__codelineno-0-1522"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;stopping&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-1523" name="__codelineno-0-1523"></a>            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<a id="__codelineno-0-1524" name="__codelineno-0-1524"></a>            <span class="k">await</span> <span class="n">writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
<a id="__codelineno-0-1525" name="__codelineno-0-1525"></a>            <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-1526" name="__codelineno-0-1526"></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
<a id="__codelineno-0-1527" name="__codelineno-0-1527"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<a id="__codelineno-0-1528" name="__codelineno-0-1528"></a>            <span class="k">return</span>
<a id="__codelineno-0-1529" name="__codelineno-0-1529"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1530" name="__codelineno-0-1530"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown command received: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
<a id="__codelineno-0-1531" name="__codelineno-0-1531"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown command&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1532" name="__codelineno-0-1532"></a>        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<a id="__codelineno-0-1533" name="__codelineno-0-1533"></a>        <span class="k">await</span> <span class="n">writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
<a id="__codelineno-0-1534" name="__codelineno-0-1534"></a>        <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-1535" name="__codelineno-0-1535"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1536" name="__codelineno-0-1536"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error handling IPC request: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1537" name="__codelineno-0-1537"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1538" name="__codelineno-0-1538"></a>            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-0-1539" name="__codelineno-0-1539"></a>                <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<a id="__codelineno-0-1540" name="__codelineno-0-1540"></a>            <span class="p">)</span>
<a id="__codelineno-0-1541" name="__codelineno-0-1541"></a>            <span class="k">await</span> <span class="n">writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
<a id="__codelineno-0-1542" name="__codelineno-0-1542"></a>            <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-1543" name="__codelineno-0-1543"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-1544" name="__codelineno-0-1544"></a>            <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="axium.core.daemon.AxiumDaemon.run" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#axium.core.daemon.AxiumDaemon.run" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Run the daemon event loop.</p>
<p>Starts UNIX socket server and waits for shutdown signal.
Cleans up socket file on exit.</p>
<p>The server accepts connections on /tmp/axiumd.sock and handles
each client in a separate task via handle_client().</p>
<p>Blocks until _stop event is set (via stop command or signal).</p>


<details class="side-effects" open>
  <summary>Side Effects</summary>
  <ul>
<li>Creates UNIX socket at /tmp/axiumd.sock</li>
<li>Removes existing socket if present</li>
<li>Cleans up socket on exit</li>
<li>Starts periodic cached segment updates every 5 minutes</li>
</ul>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>This should be run via asyncio.run() in the main process.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>axium/core/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1571">1571</a></span>
<span class="normal"><a href="#__codelineno-0-1572">1572</a></span>
<span class="normal"><a href="#__codelineno-0-1573">1573</a></span>
<span class="normal"><a href="#__codelineno-0-1574">1574</a></span>
<span class="normal"><a href="#__codelineno-0-1575">1575</a></span>
<span class="normal"><a href="#__codelineno-0-1576">1576</a></span>
<span class="normal"><a href="#__codelineno-0-1577">1577</a></span>
<span class="normal"><a href="#__codelineno-0-1578">1578</a></span>
<span class="normal"><a href="#__codelineno-0-1579">1579</a></span>
<span class="normal"><a href="#__codelineno-0-1580">1580</a></span>
<span class="normal"><a href="#__codelineno-0-1581">1581</a></span>
<span class="normal"><a href="#__codelineno-0-1582">1582</a></span>
<span class="normal"><a href="#__codelineno-0-1583">1583</a></span>
<span class="normal"><a href="#__codelineno-0-1584">1584</a></span>
<span class="normal"><a href="#__codelineno-0-1585">1585</a></span>
<span class="normal"><a href="#__codelineno-0-1586">1586</a></span>
<span class="normal"><a href="#__codelineno-0-1587">1587</a></span>
<span class="normal"><a href="#__codelineno-0-1588">1588</a></span>
<span class="normal"><a href="#__codelineno-0-1589">1589</a></span>
<span class="normal"><a href="#__codelineno-0-1590">1590</a></span>
<span class="normal"><a href="#__codelineno-0-1591">1591</a></span>
<span class="normal"><a href="#__codelineno-0-1592">1592</a></span>
<span class="normal"><a href="#__codelineno-0-1593">1593</a></span>
<span class="normal"><a href="#__codelineno-0-1594">1594</a></span>
<span class="normal"><a href="#__codelineno-0-1595">1595</a></span>
<span class="normal"><a href="#__codelineno-0-1596">1596</a></span>
<span class="normal"><a href="#__codelineno-0-1597">1597</a></span>
<span class="normal"><a href="#__codelineno-0-1598">1598</a></span>
<span class="normal"><a href="#__codelineno-0-1599">1599</a></span>
<span class="normal"><a href="#__codelineno-0-1600">1600</a></span>
<span class="normal"><a href="#__codelineno-0-1601">1601</a></span>
<span class="normal"><a href="#__codelineno-0-1602">1602</a></span>
<span class="normal"><a href="#__codelineno-0-1603">1603</a></span>
<span class="normal"><a href="#__codelineno-0-1604">1604</a></span>
<span class="normal"><a href="#__codelineno-0-1605">1605</a></span>
<span class="normal"><a href="#__codelineno-0-1606">1606</a></span>
<span class="normal"><a href="#__codelineno-0-1607">1607</a></span>
<span class="normal"><a href="#__codelineno-0-1608">1608</a></span>
<span class="normal"><a href="#__codelineno-0-1609">1609</a></span>
<span class="normal"><a href="#__codelineno-0-1610">1610</a></span>
<span class="normal"><a href="#__codelineno-0-1611">1611</a></span>
<span class="normal"><a href="#__codelineno-0-1612">1612</a></span>
<span class="normal"><a href="#__codelineno-0-1613">1613</a></span>
<span class="normal"><a href="#__codelineno-0-1614">1614</a></span>
<span class="normal"><a href="#__codelineno-0-1615">1615</a></span>
<span class="normal"><a href="#__codelineno-0-1616">1616</a></span>
<span class="normal"><a href="#__codelineno-0-1617">1617</a></span>
<span class="normal"><a href="#__codelineno-0-1618">1618</a></span>
<span class="normal"><a href="#__codelineno-0-1619">1619</a></span>
<span class="normal"><a href="#__codelineno-0-1620">1620</a></span>
<span class="normal"><a href="#__codelineno-0-1621">1621</a></span>
<span class="normal"><a href="#__codelineno-0-1622">1622</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1571" name="__codelineno-0-1571"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1572" name="__codelineno-0-1572"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1573" name="__codelineno-0-1573"></a><span class="sd">    Run the daemon event loop.</span>
<a id="__codelineno-0-1574" name="__codelineno-0-1574"></a>
<a id="__codelineno-0-1575" name="__codelineno-0-1575"></a><span class="sd">    Starts UNIX socket server and waits for shutdown signal.</span>
<a id="__codelineno-0-1576" name="__codelineno-0-1576"></a><span class="sd">    Cleans up socket file on exit.</span>
<a id="__codelineno-0-1577" name="__codelineno-0-1577"></a>
<a id="__codelineno-0-1578" name="__codelineno-0-1578"></a><span class="sd">    The server accepts connections on /tmp/axiumd.sock and handles</span>
<a id="__codelineno-0-1579" name="__codelineno-0-1579"></a><span class="sd">    each client in a separate task via handle_client().</span>
<a id="__codelineno-0-1580" name="__codelineno-0-1580"></a>
<a id="__codelineno-0-1581" name="__codelineno-0-1581"></a><span class="sd">    Blocks until _stop event is set (via stop command or signal).</span>
<a id="__codelineno-0-1582" name="__codelineno-0-1582"></a>
<a id="__codelineno-0-1583" name="__codelineno-0-1583"></a><span class="sd">    Side Effects:</span>
<a id="__codelineno-0-1584" name="__codelineno-0-1584"></a><span class="sd">        - Creates UNIX socket at /tmp/axiumd.sock</span>
<a id="__codelineno-0-1585" name="__codelineno-0-1585"></a><span class="sd">        - Removes existing socket if present</span>
<a id="__codelineno-0-1586" name="__codelineno-0-1586"></a><span class="sd">        - Cleans up socket on exit</span>
<a id="__codelineno-0-1587" name="__codelineno-0-1587"></a><span class="sd">        - Starts periodic cached segment updates every 5 minutes</span>
<a id="__codelineno-0-1588" name="__codelineno-0-1588"></a>
<a id="__codelineno-0-1589" name="__codelineno-0-1589"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-1590" name="__codelineno-0-1590"></a><span class="sd">        This should be run via asyncio.run() in the main process.</span>
<a id="__codelineno-0-1591" name="__codelineno-0-1591"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1592" name="__codelineno-0-1592"></a>    <span class="k">if</span> <span class="n">SOCKET_PATH</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-1593" name="__codelineno-0-1593"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1594" name="__codelineno-0-1594"></a>            <span class="n">SOCKET_PATH</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
<a id="__codelineno-0-1595" name="__codelineno-0-1595"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removed existing socket at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">SOCKET_PATH</span><span class="p">)</span>
<a id="__codelineno-0-1596" name="__codelineno-0-1596"></a>        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
<a id="__codelineno-0-1597" name="__codelineno-0-1597"></a>            <span class="k">pass</span>
<a id="__codelineno-0-1598" name="__codelineno-0-1598"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Unix socket server at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">SOCKET_PATH</span><span class="p">)</span>
<a id="__codelineno-0-1599" name="__codelineno-0-1599"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">start_unix_server</span><span class="p">(</span>
<a id="__codelineno-0-1600" name="__codelineno-0-1600"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">handle_client</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">SOCKET_PATH</span><span class="p">)</span>
<a id="__codelineno-0-1601" name="__codelineno-0-1601"></a>    <span class="p">)</span>
<a id="__codelineno-0-1602" name="__codelineno-0-1602"></a>
<a id="__codelineno-0-1603" name="__codelineno-0-1603"></a>    <span class="c1"># Start periodic segment update task</span>
<a id="__codelineno-0-1604" name="__codelineno-0-1604"></a>    <span class="n">update_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_periodic_segment_update</span><span class="p">())</span>
<a id="__codelineno-0-1605" name="__codelineno-0-1605"></a>
<a id="__codelineno-0-1606" name="__codelineno-0-1606"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1607" name="__codelineno-0-1607"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">:</span>
<a id="__codelineno-0-1608" name="__codelineno-0-1608"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Daemon ready, waiting for connections&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1609" name="__codelineno-0-1609"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<a id="__codelineno-0-1610" name="__codelineno-0-1610"></a>    <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-0-1611" name="__codelineno-0-1611"></a>        <span class="c1"># Cancel periodic task</span>
<a id="__codelineno-0-1612" name="__codelineno-0-1612"></a>        <span class="n">update_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<a id="__codelineno-0-1613" name="__codelineno-0-1613"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1614" name="__codelineno-0-1614"></a>            <span class="k">await</span> <span class="n">update_task</span>
<a id="__codelineno-0-1615" name="__codelineno-0-1615"></a>        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
<a id="__codelineno-0-1616" name="__codelineno-0-1616"></a>            <span class="k">pass</span>
<a id="__codelineno-0-1617" name="__codelineno-0-1617"></a>
<a id="__codelineno-0-1618" name="__codelineno-0-1618"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up socket&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1619" name="__codelineno-0-1619"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1620" name="__codelineno-0-1620"></a>        <span class="n">SOCKET_PATH</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
<a id="__codelineno-0-1621" name="__codelineno-0-1621"></a>    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
<a id="__codelineno-0-1622" name="__codelineno-0-1622"></a>        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="axium.core.daemon.kill_daemon_pid" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">kill_daemon_pid</span><span class="p">()</span></code>

<a href="#axium.core.daemon.kill_daemon_pid" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Kill daemon process by PID from file.</p>
<p>Reads PID from axiumd.pid and sends SIGTERM. If process doesn't exist,
removes stale PID file.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if process was killed or didn't exist, False on error</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="side-effects" open>
  <summary>Side Effects</summary>
  <ul>
<li>Sends SIGTERM to daemon process</li>
<li>Removes axiumd.pid file</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>axium/core/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1714">1714</a></span>
<span class="normal"><a href="#__codelineno-0-1715">1715</a></span>
<span class="normal"><a href="#__codelineno-0-1716">1716</a></span>
<span class="normal"><a href="#__codelineno-0-1717">1717</a></span>
<span class="normal"><a href="#__codelineno-0-1718">1718</a></span>
<span class="normal"><a href="#__codelineno-0-1719">1719</a></span>
<span class="normal"><a href="#__codelineno-0-1720">1720</a></span>
<span class="normal"><a href="#__codelineno-0-1721">1721</a></span>
<span class="normal"><a href="#__codelineno-0-1722">1722</a></span>
<span class="normal"><a href="#__codelineno-0-1723">1723</a></span>
<span class="normal"><a href="#__codelineno-0-1724">1724</a></span>
<span class="normal"><a href="#__codelineno-0-1725">1725</a></span>
<span class="normal"><a href="#__codelineno-0-1726">1726</a></span>
<span class="normal"><a href="#__codelineno-0-1727">1727</a></span>
<span class="normal"><a href="#__codelineno-0-1728">1728</a></span>
<span class="normal"><a href="#__codelineno-0-1729">1729</a></span>
<span class="normal"><a href="#__codelineno-0-1730">1730</a></span>
<span class="normal"><a href="#__codelineno-0-1731">1731</a></span>
<span class="normal"><a href="#__codelineno-0-1732">1732</a></span>
<span class="normal"><a href="#__codelineno-0-1733">1733</a></span>
<span class="normal"><a href="#__codelineno-0-1734">1734</a></span>
<span class="normal"><a href="#__codelineno-0-1735">1735</a></span>
<span class="normal"><a href="#__codelineno-0-1736">1736</a></span>
<span class="normal"><a href="#__codelineno-0-1737">1737</a></span>
<span class="normal"><a href="#__codelineno-0-1738">1738</a></span>
<span class="normal"><a href="#__codelineno-0-1739">1739</a></span>
<span class="normal"><a href="#__codelineno-0-1740">1740</a></span>
<span class="normal"><a href="#__codelineno-0-1741">1741</a></span>
<span class="normal"><a href="#__codelineno-0-1742">1742</a></span>
<span class="normal"><a href="#__codelineno-0-1743">1743</a></span>
<span class="normal"><a href="#__codelineno-0-1744">1744</a></span>
<span class="normal"><a href="#__codelineno-0-1745">1745</a></span>
<span class="normal"><a href="#__codelineno-0-1746">1746</a></span>
<span class="normal"><a href="#__codelineno-0-1747">1747</a></span>
<span class="normal"><a href="#__codelineno-0-1748">1748</a></span>
<span class="normal"><a href="#__codelineno-0-1749">1749</a></span>
<span class="normal"><a href="#__codelineno-0-1750">1750</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1714" name="__codelineno-0-1714"></a><span class="k">def</span><span class="w"> </span><span class="nf">kill_daemon_pid</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-1715" name="__codelineno-0-1715"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1716" name="__codelineno-0-1716"></a><span class="sd">    Kill daemon process by PID from file.</span>
<a id="__codelineno-0-1717" name="__codelineno-0-1717"></a>
<a id="__codelineno-0-1718" name="__codelineno-0-1718"></a><span class="sd">    Reads PID from axiumd.pid and sends SIGTERM. If process doesn&#39;t exist,</span>
<a id="__codelineno-0-1719" name="__codelineno-0-1719"></a><span class="sd">    removes stale PID file.</span>
<a id="__codelineno-0-1720" name="__codelineno-0-1720"></a>
<a id="__codelineno-0-1721" name="__codelineno-0-1721"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1722" name="__codelineno-0-1722"></a><span class="sd">        True if process was killed or didn&#39;t exist, False on error</span>
<a id="__codelineno-0-1723" name="__codelineno-0-1723"></a>
<a id="__codelineno-0-1724" name="__codelineno-0-1724"></a><span class="sd">    Side Effects:</span>
<a id="__codelineno-0-1725" name="__codelineno-0-1725"></a><span class="sd">        - Sends SIGTERM to daemon process</span>
<a id="__codelineno-0-1726" name="__codelineno-0-1726"></a><span class="sd">        - Removes axiumd.pid file</span>
<a id="__codelineno-0-1727" name="__codelineno-0-1727"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1728" name="__codelineno-0-1728"></a>    <span class="n">pid</span> <span class="o">=</span> <span class="n">_read_pid</span><span class="p">()</span>
<a id="__codelineno-0-1729" name="__codelineno-0-1729"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">pid</span><span class="p">:</span>
<a id="__codelineno-0-1730" name="__codelineno-0-1730"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-1731" name="__codelineno-0-1731"></a>
<a id="__codelineno-0-1732" name="__codelineno-0-1732"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1733" name="__codelineno-0-1733"></a>        <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
<a id="__codelineno-0-1734" name="__codelineno-0-1734"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sent SIGTERM to daemon PID </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
<a id="__codelineno-0-1735" name="__codelineno-0-1735"></a>        <span class="c1"># Wait briefly for process to exit</span>
<a id="__codelineno-0-1736" name="__codelineno-0-1736"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
<a id="__codelineno-0-1737" name="__codelineno-0-1737"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1738" name="__codelineno-0-1738"></a>                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Check if process exists</span>
<a id="__codelineno-0-1739" name="__codelineno-0-1739"></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<a id="__codelineno-0-1740" name="__codelineno-0-1740"></a>            <span class="k">except</span> <span class="ne">ProcessLookupError</span><span class="p">:</span>
<a id="__codelineno-0-1741" name="__codelineno-0-1741"></a>                <span class="k">break</span>
<a id="__codelineno-0-1742" name="__codelineno-0-1742"></a>        <span class="n">PID_PATH</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1743" name="__codelineno-0-1743"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-1744" name="__codelineno-0-1744"></a>    <span class="k">except</span> <span class="ne">ProcessLookupError</span><span class="p">:</span>
<a id="__codelineno-0-1745" name="__codelineno-0-1745"></a>        <span class="c1"># Process doesn&#39;t exist, clean up PID file</span>
<a id="__codelineno-0-1746" name="__codelineno-0-1746"></a>        <span class="n">PID_PATH</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1747" name="__codelineno-0-1747"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-1748" name="__codelineno-0-1748"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1749" name="__codelineno-0-1749"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to kill daemon PID </span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1750" name="__codelineno-0-1750"></a>        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="axium.core.daemon.cleanup_zombie_daemons" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">cleanup_zombie_daemons</span><span class="p">()</span></code>

<a href="#axium.core.daemon.cleanup_zombie_daemons" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Clean up zombie axium daemon processes.</p>
<p>Finds all running "axium daemon start" processes and kills them,
except for the current process and the legitimate daemon from PID file.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of processes killed</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>Uses pgrep to find and terminate zombie daemon processes.
Protects the legitimate daemon PID from the PID file.
Skips cleanup if PYTEST_CURRENT_TEST environment variable is set.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>axium/core/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1753">1753</a></span>
<span class="normal"><a href="#__codelineno-0-1754">1754</a></span>
<span class="normal"><a href="#__codelineno-0-1755">1755</a></span>
<span class="normal"><a href="#__codelineno-0-1756">1756</a></span>
<span class="normal"><a href="#__codelineno-0-1757">1757</a></span>
<span class="normal"><a href="#__codelineno-0-1758">1758</a></span>
<span class="normal"><a href="#__codelineno-0-1759">1759</a></span>
<span class="normal"><a href="#__codelineno-0-1760">1760</a></span>
<span class="normal"><a href="#__codelineno-0-1761">1761</a></span>
<span class="normal"><a href="#__codelineno-0-1762">1762</a></span>
<span class="normal"><a href="#__codelineno-0-1763">1763</a></span>
<span class="normal"><a href="#__codelineno-0-1764">1764</a></span>
<span class="normal"><a href="#__codelineno-0-1765">1765</a></span>
<span class="normal"><a href="#__codelineno-0-1766">1766</a></span>
<span class="normal"><a href="#__codelineno-0-1767">1767</a></span>
<span class="normal"><a href="#__codelineno-0-1768">1768</a></span>
<span class="normal"><a href="#__codelineno-0-1769">1769</a></span>
<span class="normal"><a href="#__codelineno-0-1770">1770</a></span>
<span class="normal"><a href="#__codelineno-0-1771">1771</a></span>
<span class="normal"><a href="#__codelineno-0-1772">1772</a></span>
<span class="normal"><a href="#__codelineno-0-1773">1773</a></span>
<span class="normal"><a href="#__codelineno-0-1774">1774</a></span>
<span class="normal"><a href="#__codelineno-0-1775">1775</a></span>
<span class="normal"><a href="#__codelineno-0-1776">1776</a></span>
<span class="normal"><a href="#__codelineno-0-1777">1777</a></span>
<span class="normal"><a href="#__codelineno-0-1778">1778</a></span>
<span class="normal"><a href="#__codelineno-0-1779">1779</a></span>
<span class="normal"><a href="#__codelineno-0-1780">1780</a></span>
<span class="normal"><a href="#__codelineno-0-1781">1781</a></span>
<span class="normal"><a href="#__codelineno-0-1782">1782</a></span>
<span class="normal"><a href="#__codelineno-0-1783">1783</a></span>
<span class="normal"><a href="#__codelineno-0-1784">1784</a></span>
<span class="normal"><a href="#__codelineno-0-1785">1785</a></span>
<span class="normal"><a href="#__codelineno-0-1786">1786</a></span>
<span class="normal"><a href="#__codelineno-0-1787">1787</a></span>
<span class="normal"><a href="#__codelineno-0-1788">1788</a></span>
<span class="normal"><a href="#__codelineno-0-1789">1789</a></span>
<span class="normal"><a href="#__codelineno-0-1790">1790</a></span>
<span class="normal"><a href="#__codelineno-0-1791">1791</a></span>
<span class="normal"><a href="#__codelineno-0-1792">1792</a></span>
<span class="normal"><a href="#__codelineno-0-1793">1793</a></span>
<span class="normal"><a href="#__codelineno-0-1794">1794</a></span>
<span class="normal"><a href="#__codelineno-0-1795">1795</a></span>
<span class="normal"><a href="#__codelineno-0-1796">1796</a></span>
<span class="normal"><a href="#__codelineno-0-1797">1797</a></span>
<span class="normal"><a href="#__codelineno-0-1798">1798</a></span>
<span class="normal"><a href="#__codelineno-0-1799">1799</a></span>
<span class="normal"><a href="#__codelineno-0-1800">1800</a></span>
<span class="normal"><a href="#__codelineno-0-1801">1801</a></span>
<span class="normal"><a href="#__codelineno-0-1802">1802</a></span>
<span class="normal"><a href="#__codelineno-0-1803">1803</a></span>
<span class="normal"><a href="#__codelineno-0-1804">1804</a></span>
<span class="normal"><a href="#__codelineno-0-1805">1805</a></span>
<span class="normal"><a href="#__codelineno-0-1806">1806</a></span>
<span class="normal"><a href="#__codelineno-0-1807">1807</a></span>
<span class="normal"><a href="#__codelineno-0-1808">1808</a></span>
<span class="normal"><a href="#__codelineno-0-1809">1809</a></span>
<span class="normal"><a href="#__codelineno-0-1810">1810</a></span>
<span class="normal"><a href="#__codelineno-0-1811">1811</a></span>
<span class="normal"><a href="#__codelineno-0-1812">1812</a></span>
<span class="normal"><a href="#__codelineno-0-1813">1813</a></span>
<span class="normal"><a href="#__codelineno-0-1814">1814</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1753" name="__codelineno-0-1753"></a><span class="k">def</span><span class="w"> </span><span class="nf">cleanup_zombie_daemons</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-1754" name="__codelineno-0-1754"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1755" name="__codelineno-0-1755"></a><span class="sd">    Clean up zombie axium daemon processes.</span>
<a id="__codelineno-0-1756" name="__codelineno-0-1756"></a>
<a id="__codelineno-0-1757" name="__codelineno-0-1757"></a><span class="sd">    Finds all running &quot;axium daemon start&quot; processes and kills them,</span>
<a id="__codelineno-0-1758" name="__codelineno-0-1758"></a><span class="sd">    except for the current process and the legitimate daemon from PID file.</span>
<a id="__codelineno-0-1759" name="__codelineno-0-1759"></a>
<a id="__codelineno-0-1760" name="__codelineno-0-1760"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1761" name="__codelineno-0-1761"></a><span class="sd">        Number of processes killed</span>
<a id="__codelineno-0-1762" name="__codelineno-0-1762"></a>
<a id="__codelineno-0-1763" name="__codelineno-0-1763"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-1764" name="__codelineno-0-1764"></a><span class="sd">        Uses pgrep to find and terminate zombie daemon processes.</span>
<a id="__codelineno-0-1765" name="__codelineno-0-1765"></a><span class="sd">        Protects the legitimate daemon PID from the PID file.</span>
<a id="__codelineno-0-1766" name="__codelineno-0-1766"></a><span class="sd">        Skips cleanup if PYTEST_CURRENT_TEST environment variable is set.</span>
<a id="__codelineno-0-1767" name="__codelineno-0-1767"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1768" name="__codelineno-0-1768"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<a id="__codelineno-0-1769" name="__codelineno-0-1769"></a>
<a id="__codelineno-0-1770" name="__codelineno-0-1770"></a>    <span class="c1"># Skip cleanup in test environment to avoid interfering with mocks</span>
<a id="__codelineno-0-1771" name="__codelineno-0-1771"></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PYTEST_CURRENT_TEST&quot;</span><span class="p">):</span>
<a id="__codelineno-0-1772" name="__codelineno-0-1772"></a>        <span class="k">return</span> <span class="mi">0</span>
<a id="__codelineno-0-1773" name="__codelineno-0-1773"></a>
<a id="__codelineno-0-1774" name="__codelineno-0-1774"></a>    <span class="n">killed</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-1775" name="__codelineno-0-1775"></a>
<a id="__codelineno-0-1776" name="__codelineno-0-1776"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1777" name="__codelineno-0-1777"></a>        <span class="c1"># Get current process PID to avoid killing ourselves</span>
<a id="__codelineno-0-1778" name="__codelineno-0-1778"></a>        <span class="n">current_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
<a id="__codelineno-0-1779" name="__codelineno-0-1779"></a>
<a id="__codelineno-0-1780" name="__codelineno-0-1780"></a>        <span class="c1"># Read legitimate daemon PID from file - must protect this!</span>
<a id="__codelineno-0-1781" name="__codelineno-0-1781"></a>        <span class="n">daemon_pid</span> <span class="o">=</span> <span class="n">_read_pid</span><span class="p">()</span>
<a id="__codelineno-0-1782" name="__codelineno-0-1782"></a>
<a id="__codelineno-0-1783" name="__codelineno-0-1783"></a>        <span class="c1"># Find all axium daemon processes</span>
<a id="__codelineno-0-1784" name="__codelineno-0-1784"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
<a id="__codelineno-0-1785" name="__codelineno-0-1785"></a>            <span class="p">[</span><span class="s2">&quot;pgrep&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;axium daemon start&quot;</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-0-1786" name="__codelineno-0-1786"></a>        <span class="p">)</span>
<a id="__codelineno-0-1787" name="__codelineno-0-1787"></a>
<a id="__codelineno-0-1788" name="__codelineno-0-1788"></a>        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1789" name="__codelineno-0-1789"></a>            <span class="n">pids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="p">]</span>
<a id="__codelineno-0-1790" name="__codelineno-0-1790"></a>            <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
<a id="__codelineno-0-1791" name="__codelineno-0-1791"></a>                <span class="c1"># Skip current process</span>
<a id="__codelineno-0-1792" name="__codelineno-0-1792"></a>                <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="n">current_pid</span><span class="p">:</span>
<a id="__codelineno-0-1793" name="__codelineno-0-1793"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-1794" name="__codelineno-0-1794"></a>
<a id="__codelineno-0-1795" name="__codelineno-0-1795"></a>                <span class="c1"># Skip the legitimate daemon from PID file</span>
<a id="__codelineno-0-1796" name="__codelineno-0-1796"></a>                <span class="c1"># This is the key fix - don&#39;t kill the running daemon!</span>
<a id="__codelineno-0-1797" name="__codelineno-0-1797"></a>                <span class="k">if</span> <span class="n">daemon_pid</span> <span class="ow">and</span> <span class="n">pid</span> <span class="o">==</span> <span class="n">daemon_pid</span><span class="p">:</span>
<a id="__codelineno-0-1798" name="__codelineno-0-1798"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-1799" name="__codelineno-0-1799"></a>                        <span class="s2">&quot;Skipping legitimate daemon PID </span><span class="si">%d</span><span class="s2"> (from PID file)&quot;</span><span class="p">,</span> <span class="n">pid</span>
<a id="__codelineno-0-1800" name="__codelineno-0-1800"></a>                    <span class="p">)</span>
<a id="__codelineno-0-1801" name="__codelineno-0-1801"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-1802" name="__codelineno-0-1802"></a>
<a id="__codelineno-0-1803" name="__codelineno-0-1803"></a>                <span class="c1"># This is an orphaned/zombie process - kill it</span>
<a id="__codelineno-0-1804" name="__codelineno-0-1804"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1805" name="__codelineno-0-1805"></a>                    <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
<a id="__codelineno-0-1806" name="__codelineno-0-1806"></a>                    <span class="n">killed</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-1807" name="__codelineno-0-1807"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Killed zombie daemon process PID </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
<a id="__codelineno-0-1808" name="__codelineno-0-1808"></a>                <span class="k">except</span> <span class="p">(</span><span class="ne">ProcessLookupError</span><span class="p">,</span> <span class="ne">PermissionError</span><span class="p">):</span>
<a id="__codelineno-0-1809" name="__codelineno-0-1809"></a>                    <span class="k">pass</span>
<a id="__codelineno-0-1810" name="__codelineno-0-1810"></a>
<a id="__codelineno-0-1811" name="__codelineno-0-1811"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1812" name="__codelineno-0-1812"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to cleanup zombie daemons: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1813" name="__codelineno-0-1813"></a>
<a id="__codelineno-0-1814" name="__codelineno-0-1814"></a>    <span class="k">return</span> <span class="n">killed</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="axium.core.daemon.start" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">start</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#axium.core.daemon.start" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Start the Axium daemon process.</p>
<p>In normal mode (debug=False), performs double fork to daemonize:
1. Fork once to detach from parent
2. Create new session (setsid)
3. Fork again to prevent zombie process
4. Parent exits, child continues as daemon</p>
<p>In debug mode (debug=True), runs in foreground with console logging.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>debug</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, run in foreground with logs to stdout.
   If False, daemonize and log to ~/.config/axium/axiumd.log.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if daemon started successfully (parent process in daemon mode).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>In debug mode, never returns (runs until stopped).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="side-effects" open>
  <summary>Side Effects</summary>
  <ul>
<li>Calls bootstrap.ensure_axium_config() to create config directory</li>
<li>Writes PID to ~/.config/axium/axiumd.pid</li>
<li>Creates UNIX socket at /tmp/axiumd.sock</li>
<li>Sets up signal handlers (SIGTERM, SIGINT)</li>
<li>Runs until stop command or signal received</li>
</ul>
</details>

<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># Background daemon</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">if</span> <span class="n">start</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Daemon started successfully&quot;</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="c1"># Foreground (for development)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="n">start</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Never returns</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>Parent process returns True immediately in daemon mode.
Child process runs until stopped (never returns).</p>
</details>

            <details class="quote">
              <summary>Source code in <code>axium/core/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1817">1817</a></span>
<span class="normal"><a href="#__codelineno-0-1818">1818</a></span>
<span class="normal"><a href="#__codelineno-0-1819">1819</a></span>
<span class="normal"><a href="#__codelineno-0-1820">1820</a></span>
<span class="normal"><a href="#__codelineno-0-1821">1821</a></span>
<span class="normal"><a href="#__codelineno-0-1822">1822</a></span>
<span class="normal"><a href="#__codelineno-0-1823">1823</a></span>
<span class="normal"><a href="#__codelineno-0-1824">1824</a></span>
<span class="normal"><a href="#__codelineno-0-1825">1825</a></span>
<span class="normal"><a href="#__codelineno-0-1826">1826</a></span>
<span class="normal"><a href="#__codelineno-0-1827">1827</a></span>
<span class="normal"><a href="#__codelineno-0-1828">1828</a></span>
<span class="normal"><a href="#__codelineno-0-1829">1829</a></span>
<span class="normal"><a href="#__codelineno-0-1830">1830</a></span>
<span class="normal"><a href="#__codelineno-0-1831">1831</a></span>
<span class="normal"><a href="#__codelineno-0-1832">1832</a></span>
<span class="normal"><a href="#__codelineno-0-1833">1833</a></span>
<span class="normal"><a href="#__codelineno-0-1834">1834</a></span>
<span class="normal"><a href="#__codelineno-0-1835">1835</a></span>
<span class="normal"><a href="#__codelineno-0-1836">1836</a></span>
<span class="normal"><a href="#__codelineno-0-1837">1837</a></span>
<span class="normal"><a href="#__codelineno-0-1838">1838</a></span>
<span class="normal"><a href="#__codelineno-0-1839">1839</a></span>
<span class="normal"><a href="#__codelineno-0-1840">1840</a></span>
<span class="normal"><a href="#__codelineno-0-1841">1841</a></span>
<span class="normal"><a href="#__codelineno-0-1842">1842</a></span>
<span class="normal"><a href="#__codelineno-0-1843">1843</a></span>
<span class="normal"><a href="#__codelineno-0-1844">1844</a></span>
<span class="normal"><a href="#__codelineno-0-1845">1845</a></span>
<span class="normal"><a href="#__codelineno-0-1846">1846</a></span>
<span class="normal"><a href="#__codelineno-0-1847">1847</a></span>
<span class="normal"><a href="#__codelineno-0-1848">1848</a></span>
<span class="normal"><a href="#__codelineno-0-1849">1849</a></span>
<span class="normal"><a href="#__codelineno-0-1850">1850</a></span>
<span class="normal"><a href="#__codelineno-0-1851">1851</a></span>
<span class="normal"><a href="#__codelineno-0-1852">1852</a></span>
<span class="normal"><a href="#__codelineno-0-1853">1853</a></span>
<span class="normal"><a href="#__codelineno-0-1854">1854</a></span>
<span class="normal"><a href="#__codelineno-0-1855">1855</a></span>
<span class="normal"><a href="#__codelineno-0-1856">1856</a></span>
<span class="normal"><a href="#__codelineno-0-1857">1857</a></span>
<span class="normal"><a href="#__codelineno-0-1858">1858</a></span>
<span class="normal"><a href="#__codelineno-0-1859">1859</a></span>
<span class="normal"><a href="#__codelineno-0-1860">1860</a></span>
<span class="normal"><a href="#__codelineno-0-1861">1861</a></span>
<span class="normal"><a href="#__codelineno-0-1862">1862</a></span>
<span class="normal"><a href="#__codelineno-0-1863">1863</a></span>
<span class="normal"><a href="#__codelineno-0-1864">1864</a></span>
<span class="normal"><a href="#__codelineno-0-1865">1865</a></span>
<span class="normal"><a href="#__codelineno-0-1866">1866</a></span>
<span class="normal"><a href="#__codelineno-0-1867">1867</a></span>
<span class="normal"><a href="#__codelineno-0-1868">1868</a></span>
<span class="normal"><a href="#__codelineno-0-1869">1869</a></span>
<span class="normal"><a href="#__codelineno-0-1870">1870</a></span>
<span class="normal"><a href="#__codelineno-0-1871">1871</a></span>
<span class="normal"><a href="#__codelineno-0-1872">1872</a></span>
<span class="normal"><a href="#__codelineno-0-1873">1873</a></span>
<span class="normal"><a href="#__codelineno-0-1874">1874</a></span>
<span class="normal"><a href="#__codelineno-0-1875">1875</a></span>
<span class="normal"><a href="#__codelineno-0-1876">1876</a></span>
<span class="normal"><a href="#__codelineno-0-1877">1877</a></span>
<span class="normal"><a href="#__codelineno-0-1878">1878</a></span>
<span class="normal"><a href="#__codelineno-0-1879">1879</a></span>
<span class="normal"><a href="#__codelineno-0-1880">1880</a></span>
<span class="normal"><a href="#__codelineno-0-1881">1881</a></span>
<span class="normal"><a href="#__codelineno-0-1882">1882</a></span>
<span class="normal"><a href="#__codelineno-0-1883">1883</a></span>
<span class="normal"><a href="#__codelineno-0-1884">1884</a></span>
<span class="normal"><a href="#__codelineno-0-1885">1885</a></span>
<span class="normal"><a href="#__codelineno-0-1886">1886</a></span>
<span class="normal"><a href="#__codelineno-0-1887">1887</a></span>
<span class="normal"><a href="#__codelineno-0-1888">1888</a></span>
<span class="normal"><a href="#__codelineno-0-1889">1889</a></span>
<span class="normal"><a href="#__codelineno-0-1890">1890</a></span>
<span class="normal"><a href="#__codelineno-0-1891">1891</a></span>
<span class="normal"><a href="#__codelineno-0-1892">1892</a></span>
<span class="normal"><a href="#__codelineno-0-1893">1893</a></span>
<span class="normal"><a href="#__codelineno-0-1894">1894</a></span>
<span class="normal"><a href="#__codelineno-0-1895">1895</a></span>
<span class="normal"><a href="#__codelineno-0-1896">1896</a></span>
<span class="normal"><a href="#__codelineno-0-1897">1897</a></span>
<span class="normal"><a href="#__codelineno-0-1898">1898</a></span>
<span class="normal"><a href="#__codelineno-0-1899">1899</a></span>
<span class="normal"><a href="#__codelineno-0-1900">1900</a></span>
<span class="normal"><a href="#__codelineno-0-1901">1901</a></span>
<span class="normal"><a href="#__codelineno-0-1902">1902</a></span>
<span class="normal"><a href="#__codelineno-0-1903">1903</a></span>
<span class="normal"><a href="#__codelineno-0-1904">1904</a></span>
<span class="normal"><a href="#__codelineno-0-1905">1905</a></span>
<span class="normal"><a href="#__codelineno-0-1906">1906</a></span>
<span class="normal"><a href="#__codelineno-0-1907">1907</a></span>
<span class="normal"><a href="#__codelineno-0-1908">1908</a></span>
<span class="normal"><a href="#__codelineno-0-1909">1909</a></span>
<span class="normal"><a href="#__codelineno-0-1910">1910</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1817" name="__codelineno-0-1817"></a><span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-1818" name="__codelineno-0-1818"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1819" name="__codelineno-0-1819"></a><span class="sd">    Start the Axium daemon process.</span>
<a id="__codelineno-0-1820" name="__codelineno-0-1820"></a>
<a id="__codelineno-0-1821" name="__codelineno-0-1821"></a><span class="sd">    In normal mode (debug=False), performs double fork to daemonize:</span>
<a id="__codelineno-0-1822" name="__codelineno-0-1822"></a><span class="sd">    1. Fork once to detach from parent</span>
<a id="__codelineno-0-1823" name="__codelineno-0-1823"></a><span class="sd">    2. Create new session (setsid)</span>
<a id="__codelineno-0-1824" name="__codelineno-0-1824"></a><span class="sd">    3. Fork again to prevent zombie process</span>
<a id="__codelineno-0-1825" name="__codelineno-0-1825"></a><span class="sd">    4. Parent exits, child continues as daemon</span>
<a id="__codelineno-0-1826" name="__codelineno-0-1826"></a>
<a id="__codelineno-0-1827" name="__codelineno-0-1827"></a><span class="sd">    In debug mode (debug=True), runs in foreground with console logging.</span>
<a id="__codelineno-0-1828" name="__codelineno-0-1828"></a>
<a id="__codelineno-0-1829" name="__codelineno-0-1829"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1830" name="__codelineno-0-1830"></a><span class="sd">        debug: If True, run in foreground with logs to stdout.</span>
<a id="__codelineno-0-1831" name="__codelineno-0-1831"></a><span class="sd">               If False, daemonize and log to ~/.config/axium/axiumd.log.</span>
<a id="__codelineno-0-1832" name="__codelineno-0-1832"></a>
<a id="__codelineno-0-1833" name="__codelineno-0-1833"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1834" name="__codelineno-0-1834"></a><span class="sd">        True if daemon started successfully (parent process in daemon mode).</span>
<a id="__codelineno-0-1835" name="__codelineno-0-1835"></a><span class="sd">        In debug mode, never returns (runs until stopped).</span>
<a id="__codelineno-0-1836" name="__codelineno-0-1836"></a>
<a id="__codelineno-0-1837" name="__codelineno-0-1837"></a><span class="sd">    Side Effects:</span>
<a id="__codelineno-0-1838" name="__codelineno-0-1838"></a><span class="sd">        - Calls bootstrap.ensure_axium_config() to create config directory</span>
<a id="__codelineno-0-1839" name="__codelineno-0-1839"></a><span class="sd">        - Writes PID to ~/.config/axium/axiumd.pid</span>
<a id="__codelineno-0-1840" name="__codelineno-0-1840"></a><span class="sd">        - Creates UNIX socket at /tmp/axiumd.sock</span>
<a id="__codelineno-0-1841" name="__codelineno-0-1841"></a><span class="sd">        - Sets up signal handlers (SIGTERM, SIGINT)</span>
<a id="__codelineno-0-1842" name="__codelineno-0-1842"></a><span class="sd">        - Runs until stop command or signal received</span>
<a id="__codelineno-0-1843" name="__codelineno-0-1843"></a>
<a id="__codelineno-0-1844" name="__codelineno-0-1844"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-1845" name="__codelineno-0-1845"></a><span class="sd">        ```python</span>
<a id="__codelineno-0-1846" name="__codelineno-0-1846"></a><span class="sd">        # Background daemon</span>
<a id="__codelineno-0-1847" name="__codelineno-0-1847"></a><span class="sd">        if start(debug=False):</span>
<a id="__codelineno-0-1848" name="__codelineno-0-1848"></a><span class="sd">            print(&quot;Daemon started successfully&quot;)</span>
<a id="__codelineno-0-1849" name="__codelineno-0-1849"></a>
<a id="__codelineno-0-1850" name="__codelineno-0-1850"></a><span class="sd">        # Foreground (for development)</span>
<a id="__codelineno-0-1851" name="__codelineno-0-1851"></a><span class="sd">        start(debug=True)  # Never returns</span>
<a id="__codelineno-0-1852" name="__codelineno-0-1852"></a><span class="sd">        ```</span>
<a id="__codelineno-0-1853" name="__codelineno-0-1853"></a>
<a id="__codelineno-0-1854" name="__codelineno-0-1854"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-1855" name="__codelineno-0-1855"></a><span class="sd">        Parent process returns True immediately in daemon mode.</span>
<a id="__codelineno-0-1856" name="__codelineno-0-1856"></a><span class="sd">        Child process runs until stopped (never returns).</span>
<a id="__codelineno-0-1857" name="__codelineno-0-1857"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1858" name="__codelineno-0-1858"></a>    <span class="c1"># Clean up any zombie daemon processes first</span>
<a id="__codelineno-0-1859" name="__codelineno-0-1859"></a>    <span class="n">killed</span> <span class="o">=</span> <span class="n">cleanup_zombie_daemons</span><span class="p">()</span>
<a id="__codelineno-0-1860" name="__codelineno-0-1860"></a>    <span class="k">if</span> <span class="n">killed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1861" name="__codelineno-0-1861"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cleaned up </span><span class="si">%d</span><span class="s2"> zombie daemon process(es)&quot;</span><span class="p">,</span> <span class="n">killed</span><span class="p">)</span>
<a id="__codelineno-0-1862" name="__codelineno-0-1862"></a>
<a id="__codelineno-0-1863" name="__codelineno-0-1863"></a>    <span class="c1"># Ensure config directory and files exist</span>
<a id="__codelineno-0-1864" name="__codelineno-0-1864"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">bootstrap</span>
<a id="__codelineno-0-1865" name="__codelineno-0-1865"></a>
<a id="__codelineno-0-1866" name="__codelineno-0-1866"></a>    <span class="n">bootstrap</span><span class="o">.</span><span class="n">ensure_axium_config</span><span class="p">()</span>
<a id="__codelineno-0-1867" name="__codelineno-0-1867"></a>
<a id="__codelineno-0-1868" name="__codelineno-0-1868"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">debug</span><span class="p">:</span>
<a id="__codelineno-0-1869" name="__codelineno-0-1869"></a>        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
<a id="__codelineno-0-1870" name="__codelineno-0-1870"></a>        <span class="k">if</span> <span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1871" name="__codelineno-0-1871"></a>            <span class="n">_write_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
<a id="__codelineno-0-1872" name="__codelineno-0-1872"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-1873" name="__codelineno-0-1873"></a>        <span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">()</span>
<a id="__codelineno-0-1874" name="__codelineno-0-1874"></a>        <span class="n">pid2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
<a id="__codelineno-0-1875" name="__codelineno-0-1875"></a>        <span class="k">if</span> <span class="n">pid2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1876" name="__codelineno-0-1876"></a>            <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1877" name="__codelineno-0-1877"></a>
<a id="__codelineno-0-1878" name="__codelineno-0-1878"></a>        <span class="c1"># Redirect stdin, stdout, stderr to /dev/null in daemon mode</span>
<a id="__codelineno-0-1879" name="__codelineno-0-1879"></a>        <span class="n">devnull</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="p">)</span>
<a id="__codelineno-0-1880" name="__codelineno-0-1880"></a>        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">devnull</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
<a id="__codelineno-0-1881" name="__codelineno-0-1881"></a>        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">devnull</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
<a id="__codelineno-0-1882" name="__codelineno-0-1882"></a>        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">devnull</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
<a id="__codelineno-0-1883" name="__codelineno-0-1883"></a>        <span class="k">if</span> <span class="n">devnull</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-1884" name="__codelineno-0-1884"></a>            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">devnull</span><span class="p">)</span>
<a id="__codelineno-0-1885" name="__codelineno-0-1885"></a>
<a id="__codelineno-0-1886" name="__codelineno-0-1886"></a>    <span class="n">_setup_logging</span><span class="p">(</span><span class="n">debug</span><span class="p">)</span>
<a id="__codelineno-0-1887" name="__codelineno-0-1887"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Axium daemon starting (debug=</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
<a id="__codelineno-0-1888" name="__codelineno-0-1888"></a>
<a id="__codelineno-0-1889" name="__codelineno-0-1889"></a>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
<a id="__codelineno-0-1890" name="__codelineno-0-1890"></a>    <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
<a id="__codelineno-0-1891" name="__codelineno-0-1891"></a>    <span class="n">daemon</span> <span class="o">=</span> <span class="n">AxiumDaemon</span><span class="p">()</span>
<a id="__codelineno-0-1892" name="__codelineno-0-1892"></a>
<a id="__codelineno-0-1893" name="__codelineno-0-1893"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_sig</span><span class="p">(</span><span class="n">_sig</span><span class="p">,</span> <span class="n">_frm</span><span class="p">):</span>
<a id="__codelineno-0-1894" name="__codelineno-0-1894"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received signal </span><span class="si">%s</span><span class="s2">, shutting down&quot;</span><span class="p">,</span> <span class="n">_sig</span><span class="p">)</span>
<a id="__codelineno-0-1895" name="__codelineno-0-1895"></a>        <span class="n">daemon</span><span class="o">.</span><span class="n">_stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<a id="__codelineno-0-1896" name="__codelineno-0-1896"></a>
<a id="__codelineno-0-1897" name="__codelineno-0-1897"></a>    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">handle_sig</span><span class="p">)</span>
<a id="__codelineno-0-1898" name="__codelineno-0-1898"></a>    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">handle_sig</span><span class="p">)</span>
<a id="__codelineno-0-1899" name="__codelineno-0-1899"></a>
<a id="__codelineno-0-1900" name="__codelineno-0-1900"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1901" name="__codelineno-0-1901"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting daemon event loop&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1902" name="__codelineno-0-1902"></a>        <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">daemon</span><span class="o">.</span><span class="n">run</span><span class="p">())</span>
<a id="__codelineno-0-1903" name="__codelineno-0-1903"></a>    <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-0-1904" name="__codelineno-0-1904"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Daemon stopped&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1905" name="__codelineno-0-1905"></a>        <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-1906" name="__codelineno-0-1906"></a>        <span class="k">if</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">PID_PATH</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-0-1907" name="__codelineno-0-1907"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1908" name="__codelineno-0-1908"></a>                <span class="n">PID_PATH</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
<a id="__codelineno-0-1909" name="__codelineno-0-1909"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-1910" name="__codelineno-0-1910"></a>                <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="axium.core.daemon.stop" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">stop</span><span class="p">()</span></code>

<a href="#axium.core.daemon.stop" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Stop the Axium daemon.</p>
<p>Attempts to stop daemon via IPC stop command. If that fails,
reads PID from axiumd.pid and sends SIGTERM. Also cleans up
any zombie daemon processes.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict with structure:
{"ok": true, "stopping": true} - IPC stop successful
{"ok": true, "signal": "SIGTERM"} - Sent SIGTERM to PID
{"ok": false, "error": "..."} - Failed to stop</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">stop</span><span class="p">()</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="p">{</span><span class="s1">&#39;ok&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;stopping&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>Does not wait for daemon to fully exit, just sends stop signal.
Check daemon status after calling to verify shutdown.
Cleans up zombie processes as a side effect.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>axium/core/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1913">1913</a></span>
<span class="normal"><a href="#__codelineno-0-1914">1914</a></span>
<span class="normal"><a href="#__codelineno-0-1915">1915</a></span>
<span class="normal"><a href="#__codelineno-0-1916">1916</a></span>
<span class="normal"><a href="#__codelineno-0-1917">1917</a></span>
<span class="normal"><a href="#__codelineno-0-1918">1918</a></span>
<span class="normal"><a href="#__codelineno-0-1919">1919</a></span>
<span class="normal"><a href="#__codelineno-0-1920">1920</a></span>
<span class="normal"><a href="#__codelineno-0-1921">1921</a></span>
<span class="normal"><a href="#__codelineno-0-1922">1922</a></span>
<span class="normal"><a href="#__codelineno-0-1923">1923</a></span>
<span class="normal"><a href="#__codelineno-0-1924">1924</a></span>
<span class="normal"><a href="#__codelineno-0-1925">1925</a></span>
<span class="normal"><a href="#__codelineno-0-1926">1926</a></span>
<span class="normal"><a href="#__codelineno-0-1927">1927</a></span>
<span class="normal"><a href="#__codelineno-0-1928">1928</a></span>
<span class="normal"><a href="#__codelineno-0-1929">1929</a></span>
<span class="normal"><a href="#__codelineno-0-1930">1930</a></span>
<span class="normal"><a href="#__codelineno-0-1931">1931</a></span>
<span class="normal"><a href="#__codelineno-0-1932">1932</a></span>
<span class="normal"><a href="#__codelineno-0-1933">1933</a></span>
<span class="normal"><a href="#__codelineno-0-1934">1934</a></span>
<span class="normal"><a href="#__codelineno-0-1935">1935</a></span>
<span class="normal"><a href="#__codelineno-0-1936">1936</a></span>
<span class="normal"><a href="#__codelineno-0-1937">1937</a></span>
<span class="normal"><a href="#__codelineno-0-1938">1938</a></span>
<span class="normal"><a href="#__codelineno-0-1939">1939</a></span>
<span class="normal"><a href="#__codelineno-0-1940">1940</a></span>
<span class="normal"><a href="#__codelineno-0-1941">1941</a></span>
<span class="normal"><a href="#__codelineno-0-1942">1942</a></span>
<span class="normal"><a href="#__codelineno-0-1943">1943</a></span>
<span class="normal"><a href="#__codelineno-0-1944">1944</a></span>
<span class="normal"><a href="#__codelineno-0-1945">1945</a></span>
<span class="normal"><a href="#__codelineno-0-1946">1946</a></span>
<span class="normal"><a href="#__codelineno-0-1947">1947</a></span>
<span class="normal"><a href="#__codelineno-0-1948">1948</a></span>
<span class="normal"><a href="#__codelineno-0-1949">1949</a></span>
<span class="normal"><a href="#__codelineno-0-1950">1950</a></span>
<span class="normal"><a href="#__codelineno-0-1951">1951</a></span>
<span class="normal"><a href="#__codelineno-0-1952">1952</a></span>
<span class="normal"><a href="#__codelineno-0-1953">1953</a></span>
<span class="normal"><a href="#__codelineno-0-1954">1954</a></span>
<span class="normal"><a href="#__codelineno-0-1955">1955</a></span>
<span class="normal"><a href="#__codelineno-0-1956">1956</a></span>
<span class="normal"><a href="#__codelineno-0-1957">1957</a></span>
<span class="normal"><a href="#__codelineno-0-1958">1958</a></span>
<span class="normal"><a href="#__codelineno-0-1959">1959</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1913" name="__codelineno-0-1913"></a><span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-1914" name="__codelineno-0-1914"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1915" name="__codelineno-0-1915"></a><span class="sd">    Stop the Axium daemon.</span>
<a id="__codelineno-0-1916" name="__codelineno-0-1916"></a>
<a id="__codelineno-0-1917" name="__codelineno-0-1917"></a><span class="sd">    Attempts to stop daemon via IPC stop command. If that fails,</span>
<a id="__codelineno-0-1918" name="__codelineno-0-1918"></a><span class="sd">    reads PID from axiumd.pid and sends SIGTERM. Also cleans up</span>
<a id="__codelineno-0-1919" name="__codelineno-0-1919"></a><span class="sd">    any zombie daemon processes.</span>
<a id="__codelineno-0-1920" name="__codelineno-0-1920"></a>
<a id="__codelineno-0-1921" name="__codelineno-0-1921"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1922" name="__codelineno-0-1922"></a><span class="sd">        dict with structure:</span>
<a id="__codelineno-0-1923" name="__codelineno-0-1923"></a><span class="sd">            {&quot;ok&quot;: true, &quot;stopping&quot;: true} - IPC stop successful</span>
<a id="__codelineno-0-1924" name="__codelineno-0-1924"></a><span class="sd">            {&quot;ok&quot;: true, &quot;signal&quot;: &quot;SIGTERM&quot;} - Sent SIGTERM to PID</span>
<a id="__codelineno-0-1925" name="__codelineno-0-1925"></a><span class="sd">            {&quot;ok&quot;: false, &quot;error&quot;: &quot;...&quot;} - Failed to stop</span>
<a id="__codelineno-0-1926" name="__codelineno-0-1926"></a>
<a id="__codelineno-0-1927" name="__codelineno-0-1927"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-1928" name="__codelineno-0-1928"></a><span class="sd">        ```python</span>
<a id="__codelineno-0-1929" name="__codelineno-0-1929"></a><span class="sd">        &gt;&gt;&gt; stop()</span>
<a id="__codelineno-0-1930" name="__codelineno-0-1930"></a><span class="sd">        {&#39;ok&#39;: True, &#39;stopping&#39;: True}</span>
<a id="__codelineno-0-1931" name="__codelineno-0-1931"></a><span class="sd">        ```</span>
<a id="__codelineno-0-1932" name="__codelineno-0-1932"></a>
<a id="__codelineno-0-1933" name="__codelineno-0-1933"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-1934" name="__codelineno-0-1934"></a><span class="sd">        Does not wait for daemon to fully exit, just sends stop signal.</span>
<a id="__codelineno-0-1935" name="__codelineno-0-1935"></a><span class="sd">        Check daemon status after calling to verify shutdown.</span>
<a id="__codelineno-0-1936" name="__codelineno-0-1936"></a><span class="sd">        Cleans up zombie processes as a side effect.</span>
<a id="__codelineno-0-1937" name="__codelineno-0-1937"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1938" name="__codelineno-0-1938"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1939" name="__codelineno-0-1939"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.ipc</span><span class="w"> </span><span class="kn">import</span> <span class="n">send_request_sync</span>
<a id="__codelineno-0-1940" name="__codelineno-0-1940"></a>
<a id="__codelineno-0-1941" name="__codelineno-0-1941"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">send_request_sync</span><span class="p">({</span><span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s2">&quot;stop&quot;</span><span class="p">})</span>
<a id="__codelineno-0-1942" name="__codelineno-0-1942"></a>        <span class="c1"># Clean up zombies after successful stop</span>
<a id="__codelineno-0-1943" name="__codelineno-0-1943"></a>        <span class="n">cleanup_zombie_daemons</span><span class="p">()</span>
<a id="__codelineno-0-1944" name="__codelineno-0-1944"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-1945" name="__codelineno-0-1945"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1946" name="__codelineno-0-1946"></a>        <span class="n">pid</span> <span class="o">=</span> <span class="n">_read_pid</span><span class="p">()</span>
<a id="__codelineno-0-1947" name="__codelineno-0-1947"></a>        <span class="k">if</span> <span class="n">pid</span><span class="p">:</span>
<a id="__codelineno-0-1948" name="__codelineno-0-1948"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1949" name="__codelineno-0-1949"></a>                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
<a id="__codelineno-0-1950" name="__codelineno-0-1950"></a>                <span class="c1"># Clean up zombies after signal</span>
<a id="__codelineno-0-1951" name="__codelineno-0-1951"></a>                <span class="n">cleanup_zombie_daemons</span><span class="p">()</span>
<a id="__codelineno-0-1952" name="__codelineno-0-1952"></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="s2">&quot;SIGTERM&quot;</span><span class="p">}</span>
<a id="__codelineno-0-1953" name="__codelineno-0-1953"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
<a id="__codelineno-0-1954" name="__codelineno-0-1954"></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)}</span>
<a id="__codelineno-0-1955" name="__codelineno-0-1955"></a>        <span class="c1"># Clean up zombies even if stop failed</span>
<a id="__codelineno-0-1956" name="__codelineno-0-1956"></a>        <span class="n">killed</span> <span class="o">=</span> <span class="n">cleanup_zombie_daemons</span><span class="p">()</span>
<a id="__codelineno-0-1957" name="__codelineno-0-1957"></a>        <span class="k">if</span> <span class="n">killed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1958" name="__codelineno-0-1958"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;cleaned_zombies&quot;</span><span class="p">:</span> <span class="n">killed</span><span class="p">}</span>
<a id="__codelineno-0-1959" name="__codelineno-0-1959"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;no pid (</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="axium.core.daemon.status" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">status</span><span class="p">()</span></code>

<a href="#axium.core.daemon.status" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get daemon status information.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict with structure:
{
    "pid": 12345 or None,
    "socket": "/tmp/axiumd.sock",
    "socket_exists": True or False
}</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">status</span><span class="p">()</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="p">{</span><span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="mi">12345</span><span class="p">,</span> <span class="s1">&#39;socket&#39;</span><span class="p">:</span> <span class="s1">&#39;/tmp/axiumd.sock&#39;</span><span class="p">,</span> <span class="s1">&#39;socket_exists&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>This only checks PID file and socket file existence.
Use send_request_sync({"cmd": "ping"}) to verify daemon is responsive.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>axium/core/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1962">1962</a></span>
<span class="normal"><a href="#__codelineno-0-1963">1963</a></span>
<span class="normal"><a href="#__codelineno-0-1964">1964</a></span>
<span class="normal"><a href="#__codelineno-0-1965">1965</a></span>
<span class="normal"><a href="#__codelineno-0-1966">1966</a></span>
<span class="normal"><a href="#__codelineno-0-1967">1967</a></span>
<span class="normal"><a href="#__codelineno-0-1968">1968</a></span>
<span class="normal"><a href="#__codelineno-0-1969">1969</a></span>
<span class="normal"><a href="#__codelineno-0-1970">1970</a></span>
<span class="normal"><a href="#__codelineno-0-1971">1971</a></span>
<span class="normal"><a href="#__codelineno-0-1972">1972</a></span>
<span class="normal"><a href="#__codelineno-0-1973">1973</a></span>
<span class="normal"><a href="#__codelineno-0-1974">1974</a></span>
<span class="normal"><a href="#__codelineno-0-1975">1975</a></span>
<span class="normal"><a href="#__codelineno-0-1976">1976</a></span>
<span class="normal"><a href="#__codelineno-0-1977">1977</a></span>
<span class="normal"><a href="#__codelineno-0-1978">1978</a></span>
<span class="normal"><a href="#__codelineno-0-1979">1979</a></span>
<span class="normal"><a href="#__codelineno-0-1980">1980</a></span>
<span class="normal"><a href="#__codelineno-0-1981">1981</a></span>
<span class="normal"><a href="#__codelineno-0-1982">1982</a></span>
<span class="normal"><a href="#__codelineno-0-1983">1983</a></span>
<span class="normal"><a href="#__codelineno-0-1984">1984</a></span>
<span class="normal"><a href="#__codelineno-0-1985">1985</a></span>
<span class="normal"><a href="#__codelineno-0-1986">1986</a></span>
<span class="normal"><a href="#__codelineno-0-1987">1987</a></span>
<span class="normal"><a href="#__codelineno-0-1988">1988</a></span>
<span class="normal"><a href="#__codelineno-0-1989">1989</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1962" name="__codelineno-0-1962"></a><span class="k">def</span><span class="w"> </span><span class="nf">status</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-1963" name="__codelineno-0-1963"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1964" name="__codelineno-0-1964"></a><span class="sd">    Get daemon status information.</span>
<a id="__codelineno-0-1965" name="__codelineno-0-1965"></a>
<a id="__codelineno-0-1966" name="__codelineno-0-1966"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1967" name="__codelineno-0-1967"></a><span class="sd">        dict with structure:</span>
<a id="__codelineno-0-1968" name="__codelineno-0-1968"></a><span class="sd">            {</span>
<a id="__codelineno-0-1969" name="__codelineno-0-1969"></a><span class="sd">                &quot;pid&quot;: 12345 or None,</span>
<a id="__codelineno-0-1970" name="__codelineno-0-1970"></a><span class="sd">                &quot;socket&quot;: &quot;/tmp/axiumd.sock&quot;,</span>
<a id="__codelineno-0-1971" name="__codelineno-0-1971"></a><span class="sd">                &quot;socket_exists&quot;: True or False</span>
<a id="__codelineno-0-1972" name="__codelineno-0-1972"></a><span class="sd">            }</span>
<a id="__codelineno-0-1973" name="__codelineno-0-1973"></a>
<a id="__codelineno-0-1974" name="__codelineno-0-1974"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-1975" name="__codelineno-0-1975"></a><span class="sd">        ```python</span>
<a id="__codelineno-0-1976" name="__codelineno-0-1976"></a><span class="sd">        &gt;&gt;&gt; status()</span>
<a id="__codelineno-0-1977" name="__codelineno-0-1977"></a><span class="sd">        {&#39;pid&#39;: 12345, &#39;socket&#39;: &#39;/tmp/axiumd.sock&#39;, &#39;socket_exists&#39;: True}</span>
<a id="__codelineno-0-1978" name="__codelineno-0-1978"></a><span class="sd">        ```</span>
<a id="__codelineno-0-1979" name="__codelineno-0-1979"></a>
<a id="__codelineno-0-1980" name="__codelineno-0-1980"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-1981" name="__codelineno-0-1981"></a><span class="sd">        This only checks PID file and socket file existence.</span>
<a id="__codelineno-0-1982" name="__codelineno-0-1982"></a><span class="sd">        Use send_request_sync({&quot;cmd&quot;: &quot;ping&quot;}) to verify daemon is responsive.</span>
<a id="__codelineno-0-1983" name="__codelineno-0-1983"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1984" name="__codelineno-0-1984"></a>    <span class="n">pid</span> <span class="o">=</span> <span class="n">_read_pid</span><span class="p">()</span>
<a id="__codelineno-0-1985" name="__codelineno-0-1985"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-1986" name="__codelineno-0-1986"></a>        <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span>
<a id="__codelineno-0-1987" name="__codelineno-0-1987"></a>        <span class="s2">&quot;socket&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">SOCKET_PATH</span><span class="p">),</span>
<a id="__codelineno-0-1988" name="__codelineno-0-1988"></a>        <span class="s2">&quot;socket_exists&quot;</span><span class="p">:</span> <span class="n">SOCKET_PATH</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span>
<a id="__codelineno-0-1989" name="__codelineno-0-1989"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="axium.core.daemon.ensure_daemon_running" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">ensure_daemon_running</span><span class="p">()</span></code>

<a href="#axium.core.daemon.ensure_daemon_running" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Ensure daemon is running, starting it automatically if needed.</p>
<p>Checks if daemon is responsive via ping with retry logic. If not responsive
or not running, verifies daemon is actually stopped before starting a new one.</p>
<p>This is called by the CLI on every command invocation to ensure the daemon
is always available for IPC operations, event handling, and completion cache
management.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if daemon is running (or successfully started), False on error</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">ensure_daemon_running</span><span class="p">()</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kc">True</span>  <span class="c1"># Daemon is now guaranteed to be running</span>
</code></pre></div>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>Uses 2-second timeout with 2 retry attempts for ping check to handle
cases where daemon is busy loading spokes/gears.
If ping fails after retries, checks PID file and process status before starting.
This prevents accidental restarts when daemon is running but slow.
If daemon start fails, logs warning but returns False (non-fatal).</p>
</details>

            <details class="quote">
              <summary>Source code in <code>axium/core/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1992">1992</a></span>
<span class="normal"><a href="#__codelineno-0-1993">1993</a></span>
<span class="normal"><a href="#__codelineno-0-1994">1994</a></span>
<span class="normal"><a href="#__codelineno-0-1995">1995</a></span>
<span class="normal"><a href="#__codelineno-0-1996">1996</a></span>
<span class="normal"><a href="#__codelineno-0-1997">1997</a></span>
<span class="normal"><a href="#__codelineno-0-1998">1998</a></span>
<span class="normal"><a href="#__codelineno-0-1999">1999</a></span>
<span class="normal"><a href="#__codelineno-0-2000">2000</a></span>
<span class="normal"><a href="#__codelineno-0-2001">2001</a></span>
<span class="normal"><a href="#__codelineno-0-2002">2002</a></span>
<span class="normal"><a href="#__codelineno-0-2003">2003</a></span>
<span class="normal"><a href="#__codelineno-0-2004">2004</a></span>
<span class="normal"><a href="#__codelineno-0-2005">2005</a></span>
<span class="normal"><a href="#__codelineno-0-2006">2006</a></span>
<span class="normal"><a href="#__codelineno-0-2007">2007</a></span>
<span class="normal"><a href="#__codelineno-0-2008">2008</a></span>
<span class="normal"><a href="#__codelineno-0-2009">2009</a></span>
<span class="normal"><a href="#__codelineno-0-2010">2010</a></span>
<span class="normal"><a href="#__codelineno-0-2011">2011</a></span>
<span class="normal"><a href="#__codelineno-0-2012">2012</a></span>
<span class="normal"><a href="#__codelineno-0-2013">2013</a></span>
<span class="normal"><a href="#__codelineno-0-2014">2014</a></span>
<span class="normal"><a href="#__codelineno-0-2015">2015</a></span>
<span class="normal"><a href="#__codelineno-0-2016">2016</a></span>
<span class="normal"><a href="#__codelineno-0-2017">2017</a></span>
<span class="normal"><a href="#__codelineno-0-2018">2018</a></span>
<span class="normal"><a href="#__codelineno-0-2019">2019</a></span>
<span class="normal"><a href="#__codelineno-0-2020">2020</a></span>
<span class="normal"><a href="#__codelineno-0-2021">2021</a></span>
<span class="normal"><a href="#__codelineno-0-2022">2022</a></span>
<span class="normal"><a href="#__codelineno-0-2023">2023</a></span>
<span class="normal"><a href="#__codelineno-0-2024">2024</a></span>
<span class="normal"><a href="#__codelineno-0-2025">2025</a></span>
<span class="normal"><a href="#__codelineno-0-2026">2026</a></span>
<span class="normal"><a href="#__codelineno-0-2027">2027</a></span>
<span class="normal"><a href="#__codelineno-0-2028">2028</a></span>
<span class="normal"><a href="#__codelineno-0-2029">2029</a></span>
<span class="normal"><a href="#__codelineno-0-2030">2030</a></span>
<span class="normal"><a href="#__codelineno-0-2031">2031</a></span>
<span class="normal"><a href="#__codelineno-0-2032">2032</a></span>
<span class="normal"><a href="#__codelineno-0-2033">2033</a></span>
<span class="normal"><a href="#__codelineno-0-2034">2034</a></span>
<span class="normal"><a href="#__codelineno-0-2035">2035</a></span>
<span class="normal"><a href="#__codelineno-0-2036">2036</a></span>
<span class="normal"><a href="#__codelineno-0-2037">2037</a></span>
<span class="normal"><a href="#__codelineno-0-2038">2038</a></span>
<span class="normal"><a href="#__codelineno-0-2039">2039</a></span>
<span class="normal"><a href="#__codelineno-0-2040">2040</a></span>
<span class="normal"><a href="#__codelineno-0-2041">2041</a></span>
<span class="normal"><a href="#__codelineno-0-2042">2042</a></span>
<span class="normal"><a href="#__codelineno-0-2043">2043</a></span>
<span class="normal"><a href="#__codelineno-0-2044">2044</a></span>
<span class="normal"><a href="#__codelineno-0-2045">2045</a></span>
<span class="normal"><a href="#__codelineno-0-2046">2046</a></span>
<span class="normal"><a href="#__codelineno-0-2047">2047</a></span>
<span class="normal"><a href="#__codelineno-0-2048">2048</a></span>
<span class="normal"><a href="#__codelineno-0-2049">2049</a></span>
<span class="normal"><a href="#__codelineno-0-2050">2050</a></span>
<span class="normal"><a href="#__codelineno-0-2051">2051</a></span>
<span class="normal"><a href="#__codelineno-0-2052">2052</a></span>
<span class="normal"><a href="#__codelineno-0-2053">2053</a></span>
<span class="normal"><a href="#__codelineno-0-2054">2054</a></span>
<span class="normal"><a href="#__codelineno-0-2055">2055</a></span>
<span class="normal"><a href="#__codelineno-0-2056">2056</a></span>
<span class="normal"><a href="#__codelineno-0-2057">2057</a></span>
<span class="normal"><a href="#__codelineno-0-2058">2058</a></span>
<span class="normal"><a href="#__codelineno-0-2059">2059</a></span>
<span class="normal"><a href="#__codelineno-0-2060">2060</a></span>
<span class="normal"><a href="#__codelineno-0-2061">2061</a></span>
<span class="normal"><a href="#__codelineno-0-2062">2062</a></span>
<span class="normal"><a href="#__codelineno-0-2063">2063</a></span>
<span class="normal"><a href="#__codelineno-0-2064">2064</a></span>
<span class="normal"><a href="#__codelineno-0-2065">2065</a></span>
<span class="normal"><a href="#__codelineno-0-2066">2066</a></span>
<span class="normal"><a href="#__codelineno-0-2067">2067</a></span>
<span class="normal"><a href="#__codelineno-0-2068">2068</a></span>
<span class="normal"><a href="#__codelineno-0-2069">2069</a></span>
<span class="normal"><a href="#__codelineno-0-2070">2070</a></span>
<span class="normal"><a href="#__codelineno-0-2071">2071</a></span>
<span class="normal"><a href="#__codelineno-0-2072">2072</a></span>
<span class="normal"><a href="#__codelineno-0-2073">2073</a></span>
<span class="normal"><a href="#__codelineno-0-2074">2074</a></span>
<span class="normal"><a href="#__codelineno-0-2075">2075</a></span>
<span class="normal"><a href="#__codelineno-0-2076">2076</a></span>
<span class="normal"><a href="#__codelineno-0-2077">2077</a></span>
<span class="normal"><a href="#__codelineno-0-2078">2078</a></span>
<span class="normal"><a href="#__codelineno-0-2079">2079</a></span>
<span class="normal"><a href="#__codelineno-0-2080">2080</a></span>
<span class="normal"><a href="#__codelineno-0-2081">2081</a></span>
<span class="normal"><a href="#__codelineno-0-2082">2082</a></span>
<span class="normal"><a href="#__codelineno-0-2083">2083</a></span>
<span class="normal"><a href="#__codelineno-0-2084">2084</a></span>
<span class="normal"><a href="#__codelineno-0-2085">2085</a></span>
<span class="normal"><a href="#__codelineno-0-2086">2086</a></span>
<span class="normal"><a href="#__codelineno-0-2087">2087</a></span>
<span class="normal"><a href="#__codelineno-0-2088">2088</a></span>
<span class="normal"><a href="#__codelineno-0-2089">2089</a></span>
<span class="normal"><a href="#__codelineno-0-2090">2090</a></span>
<span class="normal"><a href="#__codelineno-0-2091">2091</a></span>
<span class="normal"><a href="#__codelineno-0-2092">2092</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1992" name="__codelineno-0-1992"></a><span class="k">def</span><span class="w"> </span><span class="nf">ensure_daemon_running</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-1993" name="__codelineno-0-1993"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1994" name="__codelineno-0-1994"></a><span class="sd">    Ensure daemon is running, starting it automatically if needed.</span>
<a id="__codelineno-0-1995" name="__codelineno-0-1995"></a>
<a id="__codelineno-0-1996" name="__codelineno-0-1996"></a><span class="sd">    Checks if daemon is responsive via ping with retry logic. If not responsive</span>
<a id="__codelineno-0-1997" name="__codelineno-0-1997"></a><span class="sd">    or not running, verifies daemon is actually stopped before starting a new one.</span>
<a id="__codelineno-0-1998" name="__codelineno-0-1998"></a>
<a id="__codelineno-0-1999" name="__codelineno-0-1999"></a><span class="sd">    This is called by the CLI on every command invocation to ensure the daemon</span>
<a id="__codelineno-0-2000" name="__codelineno-0-2000"></a><span class="sd">    is always available for IPC operations, event handling, and completion cache</span>
<a id="__codelineno-0-2001" name="__codelineno-0-2001"></a><span class="sd">    management.</span>
<a id="__codelineno-0-2002" name="__codelineno-0-2002"></a>
<a id="__codelineno-0-2003" name="__codelineno-0-2003"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-2004" name="__codelineno-0-2004"></a><span class="sd">        True if daemon is running (or successfully started), False on error</span>
<a id="__codelineno-0-2005" name="__codelineno-0-2005"></a>
<a id="__codelineno-0-2006" name="__codelineno-0-2006"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-2007" name="__codelineno-0-2007"></a><span class="sd">        ```python</span>
<a id="__codelineno-0-2008" name="__codelineno-0-2008"></a><span class="sd">        &gt;&gt;&gt; ensure_daemon_running()</span>
<a id="__codelineno-0-2009" name="__codelineno-0-2009"></a><span class="sd">        True  # Daemon is now guaranteed to be running</span>
<a id="__codelineno-0-2010" name="__codelineno-0-2010"></a><span class="sd">        ```</span>
<a id="__codelineno-0-2011" name="__codelineno-0-2011"></a>
<a id="__codelineno-0-2012" name="__codelineno-0-2012"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-2013" name="__codelineno-0-2013"></a><span class="sd">        Uses 2-second timeout with 2 retry attempts for ping check to handle</span>
<a id="__codelineno-0-2014" name="__codelineno-0-2014"></a><span class="sd">        cases where daemon is busy loading spokes/gears.</span>
<a id="__codelineno-0-2015" name="__codelineno-0-2015"></a><span class="sd">        If ping fails after retries, checks PID file and process status before starting.</span>
<a id="__codelineno-0-2016" name="__codelineno-0-2016"></a><span class="sd">        This prevents accidental restarts when daemon is running but slow.</span>
<a id="__codelineno-0-2017" name="__codelineno-0-2017"></a><span class="sd">        If daemon start fails, logs warning but returns False (non-fatal).</span>
<a id="__codelineno-0-2018" name="__codelineno-0-2018"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-2019" name="__codelineno-0-2019"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-2020" name="__codelineno-0-2020"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">axium.core.ipc</span><span class="w"> </span><span class="kn">import</span> <span class="n">send_request_sync</span>
<a id="__codelineno-0-2021" name="__codelineno-0-2021"></a>
<a id="__codelineno-0-2022" name="__codelineno-0-2022"></a>        <span class="c1"># Try ping with longer timeout and retries</span>
<a id="__codelineno-0-2023" name="__codelineno-0-2023"></a>        <span class="c1"># Daemon might be busy loading spokes/gears or handling requests</span>
<a id="__codelineno-0-2024" name="__codelineno-0-2024"></a>        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-0-2025" name="__codelineno-0-2025"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-2026" name="__codelineno-0-2026"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="n">send_request_sync</span><span class="p">({</span><span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s2">&quot;ping&quot;</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
<a id="__codelineno-0-2027" name="__codelineno-0-2027"></a>                <span class="k">if</span> <span class="n">resp</span> <span class="ow">and</span> <span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
<a id="__codelineno-0-2028" name="__codelineno-0-2028"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-2029" name="__codelineno-0-2029"></a>                        <span class="s2">&quot;Daemon is responsive (pid: </span><span class="si">%s</span><span class="s2">, attempt: </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-2030" name="__codelineno-0-2030"></a>                        <span class="n">_read_pid</span><span class="p">(),</span>
<a id="__codelineno-0-2031" name="__codelineno-0-2031"></a>                        <span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-2032" name="__codelineno-0-2032"></a>                    <span class="p">)</span>
<a id="__codelineno-0-2033" name="__codelineno-0-2033"></a>                    <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-2034" name="__codelineno-0-2034"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-2035" name="__codelineno-0-2035"></a>                <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-2036" name="__codelineno-0-2036"></a>                    <span class="c1"># First attempt failed, try once more after brief pause</span>
<a id="__codelineno-0-2037" name="__codelineno-0-2037"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-2038" name="__codelineno-0-2038"></a>                        <span class="s2">&quot;Ping attempt </span><span class="si">%d</span><span class="s2"> failed: </span><span class="si">%s</span><span class="s2">, retrying...&quot;</span><span class="p">,</span> <span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">e</span>
<a id="__codelineno-0-2039" name="__codelineno-0-2039"></a>                    <span class="p">)</span>
<a id="__codelineno-0-2040" name="__codelineno-0-2040"></a>                    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-0-2041" name="__codelineno-0-2041"></a>
<a id="__codelineno-0-2042" name="__codelineno-0-2042"></a>                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>  <span class="c1"># Brief pause before retry</span>
<a id="__codelineno-0-2043" name="__codelineno-0-2043"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-2044" name="__codelineno-0-2044"></a>                <span class="c1"># Second attempt also failed</span>
<a id="__codelineno-0-2045" name="__codelineno-0-2045"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Daemon not responsive after </span><span class="si">%d</span><span class="s2"> attempts&quot;</span><span class="p">,</span> <span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-2046" name="__codelineno-0-2046"></a>
<a id="__codelineno-0-2047" name="__codelineno-0-2047"></a>        <span class="c1"># Ping failed after retries - verify daemon is actually stopped before starting</span>
<a id="__codelineno-0-2048" name="__codelineno-0-2048"></a>        <span class="n">pid</span> <span class="o">=</span> <span class="n">_read_pid</span><span class="p">()</span>
<a id="__codelineno-0-2049" name="__codelineno-0-2049"></a>        <span class="k">if</span> <span class="n">pid</span><span class="p">:</span>
<a id="__codelineno-0-2050" name="__codelineno-0-2050"></a>            <span class="c1"># PID file exists - check if process is alive</span>
<a id="__codelineno-0-2051" name="__codelineno-0-2051"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-2052" name="__codelineno-0-2052"></a>                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Signal 0 checks process existence without killing</span>
<a id="__codelineno-0-2053" name="__codelineno-0-2053"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-2054" name="__codelineno-0-2054"></a>                    <span class="s2">&quot;Daemon process exists (pid: </span><span class="si">%s</span><span class="s2">) but not responsive after retries - letting it continue&quot;</span><span class="p">,</span>
<a id="__codelineno-0-2055" name="__codelineno-0-2055"></a>                    <span class="n">pid</span><span class="p">,</span>
<a id="__codelineno-0-2056" name="__codelineno-0-2056"></a>                <span class="p">)</span>
<a id="__codelineno-0-2057" name="__codelineno-0-2057"></a>                <span class="c1"># Process exists but isn&#39;t responding to pings even after retries</span>
<a id="__codelineno-0-2058" name="__codelineno-0-2058"></a>                <span class="c1"># This can happen during heavy initialization (loading many spokes/gears)</span>
<a id="__codelineno-0-2059" name="__codelineno-0-2059"></a>                <span class="c1"># Don&#39;t start a new daemon - return True to allow operation to continue</span>
<a id="__codelineno-0-2060" name="__codelineno-0-2060"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-2061" name="__codelineno-0-2061"></a>            <span class="k">except</span> <span class="ne">ProcessLookupError</span><span class="p">:</span>
<a id="__codelineno-0-2062" name="__codelineno-0-2062"></a>                <span class="c1"># Process doesn&#39;t exist - safe to start new daemon</span>
<a id="__codelineno-0-2063" name="__codelineno-0-2063"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-2064" name="__codelineno-0-2064"></a>                    <span class="s2">&quot;PID file exists but process is dead (pid: </span><span class="si">%s</span><span class="s2">) - starting new daemon&quot;</span><span class="p">,</span>
<a id="__codelineno-0-2065" name="__codelineno-0-2065"></a>                    <span class="n">pid</span><span class="p">,</span>
<a id="__codelineno-0-2066" name="__codelineno-0-2066"></a>                <span class="p">)</span>
<a id="__codelineno-0-2067" name="__codelineno-0-2067"></a>                <span class="k">pass</span>
<a id="__codelineno-0-2068" name="__codelineno-0-2068"></a>            <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
<a id="__codelineno-0-2069" name="__codelineno-0-2069"></a>                <span class="c1"># Can&#39;t check process (shouldn&#39;t happen for our own process)</span>
<a id="__codelineno-0-2070" name="__codelineno-0-2070"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-2071" name="__codelineno-0-2071"></a>                    <span class="s2">&quot;Cannot check daemon process (pid: </span><span class="si">%s</span><span class="s2">) - permission denied&quot;</span><span class="p">,</span> <span class="n">pid</span>
<a id="__codelineno-0-2072" name="__codelineno-0-2072"></a>                <span class="p">)</span>
<a id="__codelineno-0-2073" name="__codelineno-0-2073"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-2074" name="__codelineno-0-2074"></a>
<a id="__codelineno-0-2075" name="__codelineno-0-2075"></a>        <span class="c1"># Daemon is definitively not running, start it</span>
<a id="__codelineno-0-2076" name="__codelineno-0-2076"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting daemon automatically&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2077" name="__codelineno-0-2077"></a>        <span class="n">success</span> <span class="o">=</span> <span class="n">start</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-2078" name="__codelineno-0-2078"></a>
<a id="__codelineno-0-2079" name="__codelineno-0-2079"></a>        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
<a id="__codelineno-0-2080" name="__codelineno-0-2080"></a>            <span class="c1"># Give daemon a moment to initialize socket</span>
<a id="__codelineno-0-2081" name="__codelineno-0-2081"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-0-2082" name="__codelineno-0-2082"></a>
<a id="__codelineno-0-2083" name="__codelineno-0-2083"></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># 200ms for socket creation and initialization</span>
<a id="__codelineno-0-2084" name="__codelineno-0-2084"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Auto-started Axium daemon&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2085" name="__codelineno-0-2085"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-2086" name="__codelineno-0-2086"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-2087" name="__codelineno-0-2087"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to auto-start daemon&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2088" name="__codelineno-0-2088"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-2089" name="__codelineno-0-2089"></a>
<a id="__codelineno-0-2090" name="__codelineno-0-2090"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-2091" name="__codelineno-0-2091"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error ensuring daemon is running: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-2092" name="__codelineno-0-2092"></a>        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/axium-tools/axium" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>